<link rel="import" href="../bower_components/polymer/polymer.html">

<!-- APP ELEMENTS -->
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">

<!-- IRON ELEMENTS -->
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">

<!--  CHRIS ELEMENTS -->
<link rel="import" href="chris-ultron-config.html">
<link rel="import" href="chris-api/chris-api.html">
<link rel="import" href="chris-behaviors/feed-behavior/feed-behavior.html">

<dom-module id="chris-ultron">
  <template>

    <style>
      :host {
        display: block;

        /* Define theme here for now....*/
        /* text */
        --primary-text-color: var(--paper-grey-900);
        --primary-background-color: #ffffff;
        --secondary-text-color: #737373;
        --disabled-text-color: #9b9b9b;

        --divider-color: #dbdbdb;

        /* colors */
        --primary-color: var(--paper-blue-500);
        --light-primary-color: var(--paper-blue-100);
        --dark-primary-color: var(--paper-blue-700);

        --accent-color: var(--paper-pink-a200);
        --light-accent-color: var(--paper-pink-a100);
        --dark-accent-color: var(--paper-pink-a400);
      }

    </style>

    <chris-ultron-config></chris-ultron-config>
    <chris-api id="ChrisAPI" error="{{error}}"></chris-api>

    <app-location route="{{route}}"></app-location>
    <app-route
        route="{{route}}"
        pattern="/:page"
        data="{{routeData}}"
        tail="{{subroute}}"></app-route>

    <iron-pages role="main" selected="[[page]]" attr-for-selected="name" fallback-selection="404">

      <chris-login name="login" on-login="_login"></chris-login>

      <chris-home
        name="home"
        feeds="[[feeds]]"
        labels="[[labels]]"
        on-change-filter="_changeFilter"
        on-fetch-labels="_fetchLabels"
        on-fetch-feeds='_fetchFeeds'
        on-open-feed="_openFeed"
        on-exit="_logout"
        on-open-app="_openApp"></chris-home>

      <chris-app
        name="app"
        app="[[openApp]]"
        plugins="[[plugins]]"
        on-exit="_goHome"
        on-new-feed="_fetchFeed"></chris-app>

      <chris-feed
        name="feed"
        feed="[[openFeed]]"
        plugins="[[plugins]]"
        on-exit="_goHome"></chris-feed>

      <chris-warning-404
        name="warning-404"
        on-go-home="_goHome"></chris-warning-404>

    </iron-pages>

  </template>

  <script>

    // performance logging
    window.performance && performance.mark && performance.mark('chris-ultron - before register');

    Polymer({

      is: 'chris-ultron',

      behaviors: [FeedBehavior],

      properties: {

        authenticated:{
          type: Boolean,
          observer: '_authenticatedChanged'
        },

        page: {
          type: String,
          reflectToAttribute: true,
          observer: '_pageChanged'
        },

        openApp: Object,

        feeds: Array,

        plugins: Array,

        openFeed: Object,

        labels: Array,

        filter: {
          type: Array,
          value: []
        }

      },

      observers: [
        '_routePageChanged(routeData.page)'
      ],

      _openFeed: function( event ){

        this.openFeed = event.detail;
        this.set('route.path', '/feed/' + this.openFeed.data.id + '/');

      },

      _changeFilter: function( event ){

        this.set('filter', event.detail);
        this._fetchFeeds();

      },

      _fetchFeeds: function(){

        var data = {};
        data.auth = {
          type: 'token',
          token: sessionStorage.getItem('token')
        };

        data.params = {};
        data.params.filter = this.filter;
        data.params.limit = 20;
        data.params.page_size = 20;

        var request =this.$.ChrisAPI.request('GET', 'feeds', data);
        request
          .then( this._handleFeeds.bind(this) );

      },

      _handleFeeds: function( response ){
        // format feeds
        for(var i = 0; i < response.data.length; i++){
          response.data[i] = this.__formatFeed(response.data[i]);
        }

        this.set( 'feeds', response );
      },

      _fetchLabels: function(){

        var data = {};
        data.auth = {
          type: 'token',
          token: sessionStorage.getItem('token')
        };

        var request =this.$.ChrisAPI.request('GET', '/tags', data);
        request
          .then( this._handleLabels.bind(this) );

      },

      _handleLabels: function( response ){

        this.set( 'labels', response );

      },

      _fetchPlugins: function(){

        var data = {};
        data.auth = {
          type: 'token',
          token: sessionStorage.getItem('token')
        };

        var request =this.$.ChrisAPI.request('GET', '/plugins/', data);
        request
          .then( this._handlePlugins.bind(this) );

      },

      _handlePlugins: function( response ){

        console.log(response.data);

        this.set( 'plugins', response.data );

      },

      handleFeed: function( response ){

        if( response.error ){

          // split "/123/" => ["", "123", ""]
          var feedId = response.href.split('/')[1];

          // update the right feed
          for(var i = 0; i < this.feeds.data.length; i++){

            if( this.feeds.data[i].data.id === feedId ){
              // restore cache...
              for( var j = 0; j < response.cache.length; j++ ){

                this.set(['feeds', 'data', i, 'data', response.cache[j].name], response.cache[j].value );

              }

              break;

            }

          }

          // notify user

        }

      },

      _routePageChanged: function( page ) {

        // redirection for login page
        if( !this.authenticated && page !== 'login' ){

          this.set( 'route.path', '/login/' );

        } else if( this.authenticated && page === 'login' ){

          this.set( 'route.path', '/home/' );

        } else {

          this.page = page || 'home';

        }
        
      },

      _authenticatedChanged: function( authenticated ){

        var page = authenticated ? 'home' : 'login';
        this.set( 'route.path', '/' + page + '/' );

      },

      _pageChanged: function( page ) {

        var resolvedPageUrl = this.resolveUrl('./chris-pages/chris-' + page + '/chris-' + page + '.html');
        this.importHref(resolvedPageUrl, null, this._go404, true );

      },

      created: function() {

        window.performance && performance.mark && performance.mark( 'chris-ultron.created' );
        // Custom elements polyfill safe way to indicate an element has been upgraded.
        this.removeAttribute( 'unresolved' );

      },

      ready: function(){

        this._fetchPlugins();

        //if username and token are stored, we are still authenticated in
        if ( sessionStorage.getItem( 'username' ) &&
             sessionStorage.getItem( 'token' ) ) {

          this.authenticated = true;

        } else {

          this.authenticated = false;

        }

      },

      _openApp: function( event ){

        this.openApp = event.detail;
        this.set('route.path', '/app/' + this.openApp.name + '/');

      },

      _fetchFeed: function(event) {
        var feedLink = event.detail.link;

        var data = {};
        data.auth = {
          type: 'token',
          token: sessionStorage.getItem('token')
        };

        var request =this.$.ChrisAPI.request('GET', feedLink, data);
        request
          .then( function(response) {
            var feed = response.data[0];
            feed = this.__formatFeed(feed);
            this._addFeed(feed);
          }.bind(this));

      },

      _addFeed: function(feed) {
        // prepend feed
        this.unshift('feeds.data', feed);

        // scroll to top of the page
        window.scrollTo(0, 0);
      },

      _goHome: function(){

        this.set('route.path', '/home/');

      },

      _go404: function(){

        this.page = 'warning-404';

      },

      _login: function( event ){

        this.authenticated = event.detail.success;
        
      },

      _logout: function(){

        // should happen in the login page.
        sessionStorage.removeItem('username');
        sessionStorage.removeItem('token');

        this.authenticated = false;

      }
      

    });
  </script>
</dom-module>
