<!--
@license
Copyright (c) 2016 FNNDSC. All rights reserved.
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">

<!-- IRON -->
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/iron-meta/iron-meta.html">

<!-- BEHAVIORS -->
<link rel="import" href="chris-api-helper-behavior.html">
<!-- APIS BEHAVIORS -->
<link rel="import" href="apis/fake/fake.html">
<link rel="import" href="apis/ultron/ultron.html">

<dom-module id="chris-api">

  <template>

    <iron-meta id="meta"></iron-meta>

    <iron-ajax id="ironAjax" url="[[getUrl(apiRoot, api, target)]]" body="[[body]]" params="[[params]]" method="[[method]]" content-type="[[contentType]]" last-response="{{response}}" last-error="{{error}}" handle-as="[[handleAs]]" auto="[[auto]]" headers="{{headers}}"></iron-ajax>

  </template>

  <script>
    Polymer({
        is: 'chris-api',

        properties: {

          url: {
            type: String
          },

          auto: {
            type:Boolean,
            value: false
          },

          response: {
            type: Object
            // do not use notify true
            // if notify true, response-changed event fired
            // before we had change to format the response
            // for instance:
            // if API returns an Object and reponse expected to
            // be an array (binded to iron-list)
            //notify: true
          },

          error: {
            type: Object
            // do not use notify true
            // see response explanation
            //notify: true
          },

          body:{
            type: Object
          },

          method:{
            type: String,
            value: 'GET'
          },

          contentType:{
            type: String
          },

          params:{
            type: Object
          },

          headers: {
            type: Object,
            value: {}
          },

          handleAs :{
            type: String,
            value: 'json'
          },

          target: {
            type: String
          },

          api: {
            type: String,
            observer: '_validateAPI'
          },

          apiRoot:{
            type: String
          },

          apiError: {
            type: Boolean,
            value: false
          }

        },

        observers: [
         'getBody(body, body.*)'
        ],


        behaviors: [
          Helper,
          FakeAPI,
          UltronAPI
        ],

        ready: function(){

          this.apiRoot = this.$.meta.byKey('cu-api-root');
          this.api = this.$.meta.byKey('cu-api');

        },

        generateRequest: function() {

          this.url = this.getUrl();
          return this.$.ironAjax.generateRequest();

        },

        handleResponse: function( request ){

          var response = this.formatResponse( request );
          // should fire instead!
          this._setResponse( response );
          return response;

        },

        formatResponse: function( request ){

          var response = this[ 'format' + this.api + 'APIResponse' ](request.target, request.response);

          // extra formating for Collection + JSON objects
          response = this.formatJsonCollectionResponse( response );

          var cache = request.cache;
          if( cache ){

            response.cache = cache;

          }

          return response;

        },

        formatJsonCollectionResponse: function( itemObj ){

          // if no . collection, just return
          // we just have a regular object
          if( !itemObj.collection ){

            return itemObj;

          }

          var item = {

            href: this._removeAPIRoot( itemObj.collection.href )

          }

          if( itemObj.collection.template && itemObj.collection.template.data && itemObj.collection.template.data.length >0 ){

            // attach template if any
            item.template = itemObj.collection.template;

          }

          if( itemObj.collection.error ){

            // attach only error if any
            item.error = itemObj.collection.error;

          }
          else if( itemObj.collection.items ){

            // attach items if any
            item.data = [];

            for( var i = 0; i < itemObj.collection.items.length; i++ ){

              var data = {};
              data.data = {};
              for( var j=0; j < itemObj.collection.items[i].data.length; j++ ){

                data.data[ itemObj.collection.items[i].data[j].name ] = itemObj.collection.items[i].data[j].value;

              }

              if( itemObj.collection.items[i].links && itemObj.collection.items[i].links.length > 0){

                data.links = {};
                for( var j=0; j < itemObj.collection.items[i].links.length; j++ ){

                  data.links[ itemObj.collection.items[i].links[j].rel ] =
                    this._removeAPIRoot( itemObj.collection.items[i].links[j].href );

                }

              }

              data.href = this._removeAPIRoot( itemObj.collection.items[i].href );

              item.data.push( data);

            }

          }

          return item;

        },

        _removeAPIRoot: function( value ){

          return value.replace( this.apiRoot, '');

        },

        handleError: function( request ){

          var error = this.formatError( request );
          this._setError( error );
          return error;

        },

        formatError: function( request ){

          return request;

        },

        _validateAPI: function(){

          var error = [];

          if (typeof this[ 'url' + this.api + 'API' ] != "function") {

            error.push( 'url' + this.api + 'API() function not declared.' );

          }

          if (typeof this[ 'format' + this.api + 'APIResponse' ] != "function") {

            error.push( 'format' + this.api + 'APIResponse() function not declared.' );

          }

          if( error.length > 0){

            console.log( error );

          }

        },

        getUrl: function(){

          return this.apiRoot + this[ 'url' + this.api + 'API' ](this.target);

        },

        getBody: function(){

          // format body for proper Collection+JSON POST
          var bodyCJ = this.body;

          // if( this.body.template && this.body.data ){
          //
          //   bodyCJ = this.formatQueryCJ( this.body.template, this.body.data );
          //
          // }

          return {};

        },

        getParams: function(){

          return this.params;

        },

        request: function( action, target, data){

          // action and target
          this.method = action;
          this.target = target;

          // handle data
          this._handleParameters( data.params );
          this._handleBody( target, data.body );
          this._handleAuthorization( data.auth );
          this._handleType( target );

          var request = this.generateRequest();

          // attach extra data to the request that can be accessed in response
          this._attachToRequest(request, 'cache', data.cache);
          this._attachToRequest(request, 'target', target);
          // also attach method? GET/POST/PUT/DELETE?

          return request.completes
            .then( this.handleResponse.bind(this) )
            .catch( this.handleError.bind(this) );

        },

        _setResponse: function( response ){

          // update value
          this.response = response;
          // trigger auto-binding
          // i.e. notify: true
          this.fire( 'response-changed' );
          // trigger parent callback
          this.fire( 'response', response );

        },

        _setError: function( error ){

          // update value
          this.error = error;
          // trigger auto-binding
          // i.e. notify: true
          this.fire( 'error-changed' );
          // trigger parent callback
          this.fire( 'error', error );

        },

        _handleParameters: function( params ){

          if( params ){

            this.params = params;

          }
          else{

            this.params = {};

          }

          this.params = params;

        },

        _handleBody: function( target, body ){

          if( target === 'login' ){

            this.body = body;

          }
          else if( body && body.template && body.data ){

            // format body for proper json collection query
            // body must contain template + data fields
            var jsonCollectionBody = {};
            jsonCollectionBody.template = body.template;

            // fill the values...
            for( var i=0; i < body.template.data.length; i++ ){

              // ... if value is set in data
              if( body.data[ body.template.data[i].name ] ){

                jsonCollectionBody.template.data[i].value = body.data[ body.template.data[i].name ];

              }


            }

            this.body = JSON.stringify( jsonCollectionBody );

          }

        },

        _handleType: function( target ){

          if( target === 'login'){

            this.headers["Content-Type"] = "application/json";
            this.headers["Accept"] = "application/json";

          }
          else{

            this.headers["Content-Type"] = "application/vnd.collection+json";
            this.headers["Accept"] = "application/vnd.collection+json";

          }

        },

        _handleAuthorization: function( auth ){

          if( auth.type ){

            if( auth.type === 'basic' ){

              var authorization = window.btoa( unescape( encodeURIComponent( auth.username + ':' + auth.password ) ) );
              this.headers['Authorization'] = "Basic " + authorization;

            }
            else if( auth.type === 'token'){

              this.headers['Authorization'] = "Token " + auth.token;

            }
            else {

              this.headers['Authorization'] = ""

            }

          }

        },

        _attachToRequest: function( request, label, value ){

          if( value ){

            request[label] = value;

          }
        }
    });
  </script>
</dom-module>
