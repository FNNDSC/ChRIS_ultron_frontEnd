<!--
@license
Copyright (c) 2016 FNNDSC. All rights reserved.
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">

<!-- IRON -->
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/iron-meta/iron-meta.html">

<!-- BEHAVIORS -->
<link rel="import" href="behaviors/chris-api-helper-behavior.html">
<link rel="import" href="behaviors/chris-api-item-behavior.html">

<link rel="import" href="apis/fake/fake.html">
<link rel="import" href="apis/ultron/ultron.html">

<dom-module id="chris-api">

  <template>

    <iron-meta id="meta"></iron-meta>

    <iron-ajax id="ironAjax" url="[[getUrl(apiRoot, api, target)]]" body="[[body]]" params="[[params]]" method="[[method]]" content-type="[[contentType]]" last-response="{{response}}" last-error="{{error}}" handle-as="[[handleAs]]" auto="[[auto]]" headers="{{headers}}"></iron-ajax>

  </template>

  <script>
    Polymer({
        is: 'chris-api',

        properties: {

          url: {
            type: String
          },

          auto: {
            type:Boolean,
            value: false
          },

          auth: {
            type: Object,
            observer: '_authChanged'
          },

          response: {
            type: Object
            // do not use notify true
            // if notify true, response-changed event fired
            // before we had change to format the response
            // for instance:
            // if API returns an Object and reponse expected to
            // be an array (binded to iron-list)
            //notify: true
          },

          error: {
            type: Object
            // do not use notify true
            // see response explanation
            //notify: true
          },

          body:{
            type: Object
          },

          method:{
            type: String,
            value: 'GET'
          },

          contentType:{
            type: String
          },

          params:{
            type: Object
          },

          headers: {
            type: Object
          },

          handleAs :{
            type: String,
            value: 'json'
          },

          target: {
            type: String
          },

          api: {
            type: String
          },

          apiRoot:{
            type: String
          },

          apiError: {
            type: Boolean,
            value: false
          }

        },

        observers: [
         'getBody(body, body.*)',
         'getParams(params, params.*)'
        ],

        behaviors: [
          Helper,
          Item,
          FakeAPI,
          UltronAPI
        ],

        ready: function(){

          this.apiRoot = this.$.meta.byKey('cu-api-root');
          this.api = this.$.meta.byKey('cu-api');
          this.headers = {
            "Content-Type": "application/vnd.collection+json",
            "Accept": "application/vnd.collection+json"
          };

        },

        generateRequest: function() {

          this.url = this.getUrl();
          return this.$.ironAjax.generateRequest();

        },

        handleResponse: function( request ){

          var response = this.handleItem( request );
          // should fire instead!
          this._setResponse( response );
          return response;

        },

        handleError: function( request ){

          var error = this.handleErrorItem( request );
          this._setError( error );
          return error;

        },

        getUrl: function(){

          return this.prepareItem( 'target' );

        },

        getBody: function(){

          return this.prepareItem( 'body' );

        },

        getParams: function(){

          return this.prepareItem( 'params' );

        },

        request: function( action, target, data){

          // this.headers = this._computeHeaders();

          // handle parameters
          var params = {};
          if( data && data.params ){

            // AUTH done at HEADER level
            // data.params.auth = params.auth;
            params = data.params;

          }

          this.params = params;

          // handle body
          if( data && data.body ){

            this.body = data.body;

          }

          this.method = action;
          this.target = target;

          var request = this.generateRequest();

          // handle cache
          if( data && data.cache){

            request.cache = data.cache;

          }

          request.target = target;

          return request.completes
            .then( this.handleResponse.bind(this) )
            .catch( this.handleError.bind(this) );

        },

        _setResponse: function( response ){

          // update value
          this.response = response;
          // trigger auto-binding
          // i.e. notify: true
          this.fire( 'response-changed' );
          // trigger parent callback
          this.fire( 'response', response );

        },

        _setError: function( error ){

          // update value
          this.error = error;
          // trigger auto-binding
          // i.e. notify: true
          this.fire( 'error-changed' );
          // trigger parent callback
          this.fire( 'error', error );

        },

        _validAPI: function(){

          // to be valid, API must provide
          var missing = '';

          // make sure this.API exists in available APIs
          //
          //
          //

          if( missing !== '' ){

            // fire error
            var error = this.api + ' is not valid. ( Missing ' + missing + ' )';
            this._setError(error);

            // reset API
            this.api = '';

            return false;
          }

          return true;

        },

        _authChanged: function(){

          if( this.auth.type ){

            if( this.auth.type === 'basic' ){

              var authorization = window.btoa( unescape( encodeURIComponent( this.auth.username + ':' + this.auth.password ) ) );
              this.headers['Authorization'] = "Basic " + authorization;

            }
            else if( this.auth.type === 'token'){

              //python manage.py runmodwsgi --host 0.0.0.0 --port 8001 --https-port 80 --ssl-certificate-file ../utils/ssl_cert/local.crt --ssl-certificate-key-file ../utils/ssl_cert/local.key --processes 8 --server-name localhost --https-only --reload-on-changes
              // http  --verify=../utils/ssl_cert/local.crt https://localhost:8000/api/v1/plugins/ "Authorization: Token 1612a857a43c21d688ccbe849dbfbf078cef8cc7"
              this.headers['Authorization'] = "Token " + this.auth.token;

            }

          }

        }
    });
  </script>
</dom-module>
