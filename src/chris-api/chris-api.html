<!--
@license
Copyright (c) 2016 FNNDSC. All rights reserved.
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">

<!-- IRON -->
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">

<!-- BEHAVIORS -->
<link rel="import" href="behaviors/chris-api-feeds-behavior.html">
<link rel="import" href="behaviors/chris-api-feed-details-behavior.html">
<link rel="import" href="behaviors/chris-api-labels-behavior.html">
<link rel="import" href="behaviors/chris-api-login-behavior.html">
<link rel="import" href="behaviors/chris-api-plugin-pacspull-behavior.html">
<link rel="import" href="behaviors/chris-api-plugins-feed-behavior.html">

<dom-module id="chris-api">

  <template>

    <iron-ajax id="ironAjax" url="[[getUrl(url, api)]]" body="[[getBody(body, api)]]" params="[[getParams(params, api)]]" method="[[method]]" last-response="{{response}}" on-response="handleResponse" last-error="{{error}}" on-error="handleError" handle-as="[[handleAs]]" auto></iron-ajax>

  </template>

  <script>
    Polymer({
        is: 'chris-api',
        properties: {
          url: {
            type: String
          },
          response: {
            type: Object,
            notify: true
          },
          error: {
            type: Object,
            notify: true
          },
          body:{
            type: Object
          },
          method:{
            type: String
          },
          params:{
            type: Object
          },
          api: {
            type: String
          },
          handleAs :{
            type: String,
            value: 'json'
          },
          // ChRIS API SPECIFIC VARS
          chrisAPI:{
            type: Boolean,
            value: false
          },
          apiRoot:{
            type: String,
            value: 'http://127.0.0.1:5555/v1/'
          },
          dbPath:{
            type: String,
            value: '/tmp/ChRIS_DB'
          },
          createDB :{
            type: Boolean,
            value: false
          }
        },
        behaviors: [
          Feeds,
          FeedDetails,
          Labels,
          Login,
          PluginPacspull,
          PluginsFeed
        ],
        generateRequest: function() {
          this.$.ironAjax.generateRequest();
        },
        handleResponse: function(evt){
          var response = this['handle' + this.api ]();
          this._setResponse(response);
        },
        handleError: function(evt){
          var error = this['handleError' + this.api ]();
          this._setError(error);
        },
        getUrl: function(url, api){

          if(!api){
            return;
          }

          return this['prepare' + api ]('url');
        },
        getBody: function(body, api){

          if(!api){
            return;
          }

          return this['prepare' + api ]('body');
        },
        getParams: function(params, api){

          if(!api){
            return;
          }

          return this['prepare' + api ]('params');
        },
        _setResponse(response){
          // update value
          this.response = response;
          // trigger parent callback
          this.fire('response');
        },
        _setError(error){
          // update value
          this.error = error;
          // trigger parent callback
          this.fire('error');
        }
    });
  </script>
</dom-module>
