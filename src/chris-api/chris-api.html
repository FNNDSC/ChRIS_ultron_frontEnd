<!--
@license
Copyright (c) 2016 FNNDSC. All rights reserved.
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">

<!-- IRON -->
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">

<!-- BEHAVIORS -->
<link rel="import" href="behaviors/chris-api-login-behavior.html">
<link rel="import" href="behaviors/chris-api-helper-behavior.html">
<link rel="import" href="behaviors/chris-api-plugin-pacspull-behavior.html">
<link rel="import" href="behaviors/chris-api-plugin-create-behavior.html">
<link rel="import" href="behaviors/chris-api-item-behavior.html">

<link rel="import" href="cj/helper-behavior.html">
<link rel="import" href="cj/comment-collection-behavior.html">
<link rel="import" href="cj/comment-behavior.html">
<link rel="import" href="cj/feed-collection-behavior.html">
<link rel="import" href="cj/feed-behavior.html">
<link rel="import" href="cj/label-collection-behavior.html">
<link rel="import" href="cj/label-behavior.html">
<link rel="import" href="cj/note-behavior.html">
<link rel="import" href="cj/pacsquery-behavior.html">
<link rel="import" href="cj/plugin-collection-behavior.html">
<link rel="import" href="cj/plugin-behavior.html">
<link rel="import" href="cj/pluginfs-collection-behavior.html">
<link rel="import" href="cj/pluginfs-behavior.html">

<dom-module id="chris-api">

  <template>

    <iron-ajax id="ironAjax" url="[[getUrl(url, api)]]" body="[[body]]" params="[[params]]" method="[[method]]" content-type="[[contentType]]" last-response="{{response}}" last-error="{{error}}" handle-as="[[handleAs]]" auto="[[auto]]"></iron-ajax>

  </template>

  <script>
    Polymer({
        is: 'chris-api',

        properties: {

          url: {
            type: String
          },

          auto: {
            type:Boolean,
            value: false
          },

          response: {
            type: Object
            // do not use notify true
            // if notify true, response-changed event fired
            // before we had change to format the response
            // for instance:
            // if API returns an Object and reponse expected to
            // be an array (binded to iron-list)
            //notify: true
          },

          error: {
            type: Object
            // do not use notify true
            // see response explanation
            //notify: true
          },

          body:{
            type: Object
          },

          method:{
            type: String,
            value: 'GET'
          },

          contentType:{
            type: String
          },

          params:{
            type: Object
          },

          api: {
            type: String,
            value: '',
            observer: '_validAPI'
          },

          handleAs :{
            type: String,
            value: 'json'
          },

          apiRoot:{
            type: String,
            value: ''
          }

        },

        observers: [
         'getBody(body, body.*)',
         'getParams(params, params.*)'
        ],

        behaviors: [
          Helper,
          HelperCJ,
          CommentCollectionCJ,
          CommentCJ,
          FeedCollectionCJ,
          FeedCJ,
          LabelCollectionCJ,
          LabelCJ,
          NoteCJ,
          PacsqueryCJ,
          PluginCollectionCJ,
          PluginCJ,
          PluginFSCollectionCJ,
          PluginFSCJ,
          Item,
          Login,
          PluginCreate,
          PluginPacspull
        ],

        ready: function(){

          //console.log( window.CollectionJSON );

        },

        generateRequest: function() {

          this.url = this.getUrl();

          return this.$.ironAjax.generateRequest();

        },

        handleResponse: function( request ){

          var response = this[ 'handle' + this.api ]( request );
          // should fire instead!
          this._setResponse( response );
          return response;

        },

        handleError: function( request ){

          var error = this[ 'handleError' + this.api ]( request );
          this._setError( error );
          return error;

        },

        getUrl: function(){

          if( !this._validAPI() ){

            return;

          }

          return this['prepare' + this.api ]( 'url' );

        },

        getBody: function(){

          if( !this._validAPI() ){

            return;

          }

          return this['prepare' + this.api ]( 'body' );

        },

        getParams: function(){

          if( !this._validAPI() ){

            return;

          }

          return this['prepare' + this.api ]( 'params' );

        },

        request: function( action, url, data){

          // handle parameters
          var params = {
              auth: 'user=' + sessionStorage.getItem( 'username' ) + ',hash=' + sessionStorage.getItem( 'token' )
          };

          if( data && data.params ){

            data.params.auth = params.auth;
            params = data.params;

          }

          this.params = params;

          // handle body
          if( data && data.body ){

            this.body = data.body;

          }

          this.method = action;
          this.url = url;

          var request = this.generateRequest();

          // handle cache
          if( data && data.cache){

            request.cache = data.cache;

          }

          return request.completes
            .then( this.handleResponse.bind(this) )
            .catch( this.handleError.bind(this) );

        },

        _setResponse: function( response ){

          // update value
          this.response = response;
          // trigger auto-binding
          // i.e. notify: true
          this.fire( 'response-changed' );
          // trigger parent callback
          this.fire( 'response', response );

        },

        _setError: function( error ){

          // update value
          this.error = error;
          // trigger auto-binding
          // i.e. notify: true
          this.fire( 'error-changed' );
          // trigger parent callback
          this.fire( 'error', error );

        },

        _validAPI: function(){

          // to be valid, API must provide
          var missing = '';

          // prepare
          if( !this['prepare' + this.api ] ){

            missing += ' prepare' + this.api;

          }

          // handle
          if( !this['handle' + this.api ] ){

            missing += ' handle' + this.api;

          }

          // handleError
          if( !this['handleError' + this.api ] ){

            missing += ' handleError' + this.api;

          }

          if( missing !== '' ){

            // fire error
            var error = this.api + ' is not valid. ( Missing ' + missing + ' )';
            this._setError(error);

            // reset API
            this.api = '';

            return false;
          }

          return true;

        }
    });
  </script>
</dom-module>
