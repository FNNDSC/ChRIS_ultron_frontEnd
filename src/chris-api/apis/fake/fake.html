<link rel="import" href="cj/helper-behavior.html">
<link rel="import" href="cj/comment-collection-behavior.html">
<link rel="import" href="cj/comment-behavior.html">
<link rel="import" href="cj/feed-collection-behavior.html">
<link rel="import" href="cj/feed-behavior.html">
<link rel="import" href="cj/file-collection-behavior.html">
<link rel="import" href="cj/file-behavior.html">
<link rel="import" href="cj/note-behavior.html">
<link rel="import" href="cj/pacsquery-behavior.html">
<link rel="import" href="cj/plugin-collection-behavior.html">"
<link rel="import" href="cj/plugin-instance-collection-behavior.html">
<link rel="import" href="cj/plugin-instance-behavior.html">
<link rel="import" href="cj/plugin-behavior.html">
<link rel="import" href="cj/tag-collection-behavior.html">
<link rel="import" href="cj/tag-behavior.html">

<script>
    /** @polymerBehavior FakeAPI */
    // extending behaviors
    // https://www.polymer-project.org/1.0/docs/devguide/behaviors
    FakeAPI = [
      HelperCJ,
      CommentCollectionCJ,
      CommentCJ,
      FeedCollectionCJ,
      FeedCJ,
      FileCollectionCJ,
      FileCJ,
      NoteCJ,
      PacsqueryCJ,
      PluginCollectionCJ,
      PluginInstanceCollectionCJ,
      PluginInstanceCJ,
      PluginCJ,
      TagCollectionCJ,
      TagCJ
    ]

    FakeAPIImpl = {

      urlFakeAPI: function( target ){

        // POST AND PUT
        if( this.method !== 'GET'){
          return 'https://httpbin.org/' + this.method.toLowerCase();;
        }

        // GET      
        // url pattern: /<number>/ to be replaced by /feed/
        var isFeedRegex = /^\/(\d+)\//;
        if( isFeedRegex.test(target) ){
          target = target.replace(isFeedRegex, '/feed/');
        }

        console.log( target );

        // HIJACK GET FILE NAME
        if(/^\/data\//.test(target)){

          return target;

        } else if( /^\/plugins\/instances\/(\d+)\//.test(target) ){

           return '/data/plugins.json';

        } else if( /^\/plugins\/instances\/search\//.test(target) ){

           return '/data/pluginsInstancesSearch.json';

        } else if( /^\/feed\/files\//.test(target) ){

          return '/data/files.json';

        } else if( /^\/feed\/comments\//.test(target) ){

          return '/data/feed/comments.json';

        } else if( /^\/note\/(\d+)\//.test(target) ){

          return '/data/feed/note.json';

        } else{

          return '/data/' + target + '.json';

        }
        

      },

      formatFakeAPIResponse: function(target, params, response){

        switch( target ){
          case 'login':
            return {
              status: true,
              message: 'Successful login.',
              token: 'kjASD12dasS'
            };
          default:
            // to nothing yet.
            break;
        }

        // if targetting raw data
        if(/^\/data\//.test(target)){

          console.log( target );

          return response;

        }
        
        //
        var itemCJ = {};

        // Simulate GET
        if( this.method === 'GET' && /^\/(\d+)\/comments\//.test(target) ){

          itemCJ = this.generateCommentCollectionCJ();

        }
        else if( this.method === 'GET' && target === 'feeds' ){

          itemCJ = this.generateFeedCollectionCJ( response.data, params );

        }
        else if( this.method === 'GET' && target === 'tags' ){

          itemCJ = this.generateTagCollectionCJ();

        }
        else if( this.method === 'GET' && /^\/note\/(\d+)\//.test(target) ){

          itemCJ = this.generateNoteCJ();

        }
        else if( this.method === 'GET' && target === 'plugins' ){

          console.log( target );

          itemCJ = this.generatePluginCollectionCJ();

          console.log( itemCJ );

        }

        // url pattern: /plugins/instances/<id>
        if( this.method === 'GET' && /^\/plugins\/instances\/(\d+)\//.test(target) ){

          var id = Number( target.match(/\d+/)['0'] );
          itemCJ = this.generatePluginInstanceCJ( id );

        }
        else if( this.method === 'GET' && /^\/plugins\/instances\/search\//.test(target) ){

          itemCJ = this.generatePluginInstanceCollectionCJ( params.root_id );

        }

        // url pattern: /<id>/files/
        if( this.method === 'GET' && /^\/(\d+)\/files\//.test(target) ){
          
          window.console.log( target );
          window.console.log( target.match(/\d+/)['0'] );
          var id = Number( target.match(/\d+/)['0'] );
          window.console.log( id );
          itemCJ = this.generateFileCollectionCJ( id, params );

          window.console.log( itemCJ );

        }

        // get file data
        // this.$.API.request( 'GET', file, data );
        // hijack file name :D

        // Simulate POST/PUT
        if( this.method !== 'GET' ){

          itemCJ.collection = {};
          itemCJ.collection.href = target;
          itemCJ.collection.items = [{
            data: [],
            href: '',
            links: []
          }];

          // url pattern: /plugins/<number>/instances/
          if( /^\/plugins\/(\d+)\/instances\//.test(target) ){

            // extract plugin ID from string
            var id = Number( target.match(/\d+/)['0'] );

            function pluginSelected( value ){
              return Number( value['id'] ) ===  id;
            }

            var plugins = this.plugins();
            var plugin = plugins.filter( pluginSelected )[0];

            switch( plugin.name ){
              case 'pacsquery':
              case 'pacsretrieve':
                  var pluginInstanceID = Math.round( Math.random() * 100 );
                  itemCJ.collection.items[0].data = [
                    {
                      name: 'id',
                      value: pluginInstanceID
                    },
                    {
                      name: 'plugin_name',
                      value: plugin.name
                    },
                    {
                      name: 'owner',
                      value: 'chris'
                    }];
                  itemCJ.collection.items[0].href = this.apiRoot + '/plugins/instances/' + pluginInstanceID + '/';
                  break;
              default:
                  break;

            }

          }

        }

        // Generate errors...
        if( this.apiError ){

          itemCJ.collection.error = {
            'title'   : 'API Error',
            'code'    : 'X1234',
            'message' : this.method + ' : ' + itemCJ.collection.href + ' could not be processed.'
          };

        }

        return itemCJ;
      }

    },

    FakeAPI.push(FakeAPIImpl)

</script>
