<script>
    /** @polymerBehavior Feeds */
    Feeds = {

      prepareFeeds: function( what ){

        this.handleAs = 'json';

        switch( what ){

          case 'url':

            // shoud be empty as it is main entry point in API
            var suffix = '/data/feeds.json';
            var url = this.apiRoot + suffix;

            return url;

          case 'params':
            return this.params;

          case 'body':
            return this.body;

          default:
            break;

          }

        return false;
      },

      handleFeeds: function( ){

        // generate fake data
        var feedsCJ = this._generateFeedsCJ( this.response );
        
        // parse fake CJ response and format it as needed
        var feeds = this.formatFeeds( feedsCJ );

        return feeds;

      },

      formatFeeds: function( feedsCJ ){

        var feedObj = JSON.parse( feedsCJ );
        var items = feedObj.collection.items;
        var template = feedObj.collection.template;

        var feeds = [];

        for( var i=0; i<items.length; i++ ){

          var feed = {};
          feed.data = {};
          feed.template = template;

          for( var j=0; j < items[i].data.length; j++ ){

            feed.data[ items[i].data[j].name ] = items[i].data[j].value;

          }

          feeds.push(feed);

        }

        return feeds;

      },

      handleErrorFeeds: function( ){

        return this.error;

      },

      _generateFeedsCJ: function( rawData ){

        var cj = {};
        cj.collection = {};

        // create the template field
        cj.collection.template = {};
        var template = cj.collection.template;
        template.data = [
          {"name" : "color", "value" : ""},
          {"name" : "date", "value" : ""},
          {"name" : "favorite", "value" : ""},
          {"name" : "id", "value" : ""},
          {"name" : "letter", "value" : ""},
          {"name" : "name", "value" : ""},
          {"name" : "status", "value" : ""},
          {"name" : "tags", "value" : ""}
        ];

        // create the items
        cj.collection.items = [];
        var items = cj.collection.items;

        var colors = this.colors();

        for( var i=0; i<rawData.length; i++ ){

          var item = {};
          // href? links?
          item.data = [];
          var data = item.data;

          data.push( { "name" : "color", "value" : colors[Math.floor(Math.random() * colors.length)].value } );
          data.push( { "name" : "date", "value" : rawData[i].date } );
          data.push( { "name" : "favorite", "value" : rawData[i].integer > 50 ? true : false } );
          data.push( { "name" : "id", "value" : "id: " + rawData[i].index } );
          data.push( { "name" : "letter", "value" : "N" } );
          data.push( { "name" : "name", "value" : rawData[i].name } );
          data.push( { "name" : "status", "value" : this._generateStatus( rawData[i].integer ) } );
          data.push( { "name" : "tags", "value" : this._generateTags( colors ) } );

          items.push(item);

        }

        // convert to JSON
        return JSON.stringify( cj );

      },

      _generateStatus: function( value ){

        if( value < 30 ){

          return 'done';

        }
        else if( value < 60 ){

          return 'running';

        }
        else{

          return 'error';

        }

      },

      _generateTags: function( available ){

        var tags = [];
        var countTags = {};
        var nbTags = Math.floor(Math.random() * available.length);

        for( var i=0; i<nbTags; i++ ){

          var tag = available[Math.floor(Math.random() * available.length)];

          if( !countTags[tag.name] ){

            tags.push({
              name: tag.name,
              color: tag.value
            });

            countTags[tag.name] = true;

          }

        }

        return tags;

      }

    };
</script>