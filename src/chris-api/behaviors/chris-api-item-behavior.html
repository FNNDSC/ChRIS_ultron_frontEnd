<script>
    /** @polymerBehavior Item */
    Item = {

      prepareItem: function( what ){

        this.handleAs = 'json';

        switch( what ){

          case 'url':

            // get last part of url for now

            console.log( this.url );

            var url = '';

            if( this.method === 'POST' ){

              url = 'https://httpbin.org/post';

            }
            else if( this.method === 'PUT' ){

              url = 'https://httpbin.org/put';

            }
            else{

              url = '/data/';
              url += this.url.split(/[/]+/).pop();
              if( url.indexOf('.json') === -1 ){

                url += '.json';

              }

            }

            return url;

          case 'params':

            return this.params;

          case 'body':

            // format body for proper CJ POST
            var bodyCJ = this.body;

            if( this.body.template && this.body.data ){

              bodyCJ = this.formatQueryCJ( this.body.template, this.body.data );

            }
            
            return bodyCJ;

          default:

            break;

          }

        return false;

      },

      handleItem: function( request ){

        var response = request.response;
        var cache = request.cache;

        //
        // TO BE REMOVED WHEN CONNECTED TO REAL API?
        // STILL GOD FOR TESTING
        // NEED SWITCH?
        //
        // FROM HERE
        //.....................................

        var itemCJ = {};

        // Simulate GET
        if( this.method === 'GET' && response.type === 'comments' ){

          itemCJ = this.generateCommentCollectionCJ();

        }
        else if( this.method === 'GET' && response.type === 'feeds' ){

          itemCJ = this.generateFeedCollectionCJ( response.data );

        }
        else if( this.method === 'GET' && response.type === 'labels' ){

          itemCJ = this.generateLabelCollectionCJ();

        }
        else if( this.method === 'GET' && response.type === 'note' ){

          itemCJ = this.generateNoteCJ();

        }
        else if( this.method === 'GET' && response.type === 'plugins' ){

          itemCJ = this.generatePluginCollectionCJ();

        }
        else if( this.method === 'GET' && response.type === 'pluginsFS' ){

          itemCJ = this.generatePluginFSCollectionCJ( response.data);

        }

        // Simulate POST/PUT
        if( this.method !== 'GET' ){

          itemCJ.collection = {};
          itemCJ.collection.href = response.json.href;

        }

        // Generate random errors...
        if( Math.random() > 0.75 ){

          itemCJ.collection.error = {
            'title'   : 'API Error',
            'code'    : 'X1234',
            'message' : this.method + ' : ' + itemCJ.collection.href + ' could not be processed.'
          };
          
        }

        itemCJ = JSON.stringify( itemCJ );

        // TO HERE
        //.....................................

        // format the response
        var item = this.formatItemCJ( itemCJ );
        response = item;

        if( cache ){

          response.cache = cache;

        }

        return response;

      },


      formatItemCJ: function( feedCJ ){
      
        var itemObj = JSON.parse( feedCJ );
        // debug here why template...

        var item = {

          template: itemObj.collection.template,
          href: itemObj.collection.href

        }

        if( itemObj.collection.template && itemObj.collection.template.data && itemObj.collection.template.data.length >0 ){

          // attach template if any
          item['template'] = itemObj.collection.template;

        }

        if( itemObj.collection.error ){

          // attach only error if any
          item.error = itemObj.collection.error;

        }
        else if( itemObj.collection.items ){

          // attach items if any
          item.data = [];
          
          for( var i = 0; i < itemObj.collection.items.length; i++ ){

            var data = {};
            data.data = {};
            for( var j=0; j < itemObj.collection.items[i].data.length; j++ ){

              data.data[ itemObj.collection.items[i].data[j].name ] = itemObj.collection.items[i].data[j].value;

            }

            if( itemObj.collection.items[i].links && itemObj.collection.items[i].links.length > 0){

              data.links = {};
              for( var j=0; j < itemObj.collection.items[i].links.length; j++ ){

                data.links[ itemObj.collection.items[i].links[j].rel ] = itemObj.collection.items[i].links[j].href;

              }

            }

            data.href = itemObj.collection.items[i].href;

            item.data.push( data);

          }

        }

        return item;

      },

      handleErrorItem: function( request ){

        return request;

      }
    };
</script>