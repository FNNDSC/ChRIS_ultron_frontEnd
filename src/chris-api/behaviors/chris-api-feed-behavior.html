<script>
    /** @polymerBehavior Feed */
    Feed = {

      prepareFeed: function( what ){

        this.handleAs = 'json';

        switch( what ){

          case 'url':

            // http://httpbin.org/
            var url = 'https://httpbin.org/get';

            if( this.method === 'PUT' ){

              url = 'https://httpbin.org/put'

            }

            return url;

          case 'params':

            return this.params;

          case 'body':

            // format body for proper CJ POST
            var bodyCJ = this.body;

            if( this.body.template && this.body.data ){

              bodyCJ = this._generateFeedCJPost( this.body.template, this.body.data );

            }
            
            return JSON.stringify(bodyCJ);

          default:

            break;

          }
        return false;
      },

      handleFeed: function(){

        if( this.method === 'PUT' ){

          // generate error 50% of the time
          var feedCJ = this._generateFeedCJ( Math.random() > 0.5 );
          var feed = this.formatFeedCJ( feedCJ );
          return feed;

        }
        else{
          
          //

        }

        return this.response.json;

      },

      formatFeedCJ: function( feedCJ ){
      
        var feedObj = JSON.parse( feedCJ );
        var feed = {

          template: feedObj.collection.template

        }

        if( feedObj.collection.error ){

          feed[ 'error' ] = feedObj.collection.error;

        }
        else{

          feed[ 'data' ] = feedObj.collection.items[0].data;

        }

        return feed;

      },

      handleErrorFeed: function(){

        return this.error;

      },

      _generateFeedCJPost: function( template, data ){

        // use template + data to do the magics
        var feedCJ = {};
        feedCJ.template = template;

        // fill the values
        for( var i=0; i < template.data.length; i++ ){

          feedCJ.template.data[i].value = data[ template.data[i].name ];

        }

        return feedCJ;


      },

      _feedTemplate: function(){

      },

      _generateFeedItem: function( template, data ){
          
          var item = {};
          // href? links?

          // create the data field
          item.data = [];

          for( var j=0; j < template.data.length; j++ ){

            var attribute = {};
            attribute[ template.data[j].name ] = data[ template.data[j].name ]
            item.data.push( attribute );

          }

          return item;

      },

      _generateFeedCJ: function( error ){

        var cj = {};
        cj.collection = {};

        // create the template field
        cj.collection.template = {};
        var template = cj.collection.template;
        template.data = [
          {"name" : "color", "value" : ""},
          {"name" : "date", "value" : ""},
          {"name" : "favorite", "value" : ""},
          {"name" : "id", "value" : ""},
          {"name" : "letter", "value" : ""},
          {"name" : "name", "value" : ""},
          {"name" : "status", "value" : ""},
          {"name" : "tags", "value" : ""}
        ];

        // create the error field
        if( error === true ){

          // create the template field
          cj.collection.error = {
            "title"   : "Server Error",
            "code"    : "X1234",
            "message" : "Favorite could not be updated"
          };

        }
        else{

          // create the items field
          cj.collection.items = [];
          // we get body instead of response for now...
          // var rawData = JSON.parse( this.body );
          var rawData = this.body;
          cj.collection.items.push( this._generateFeedItem( rawData.template, rawData.data ) );

        }

        return JSON.stringify( cj );

      }

    };
</script>