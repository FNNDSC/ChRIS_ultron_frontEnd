<link rel="import" href="../../../bower_components/polymer/polymer.html">

<!-- IRON ELEMENTS -->
<link rel="import" href="../../../bower_components/iron-collapse/iron-collapse.html">

<!-- PAPER ELEMENTS -->
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../../../bower_components/paper-tooltip/paper-tooltip.html">

<!-- EXTERNAL ELEMENTS -->
<link rel="import" href="../../../bower_components/paper-date-picker/paper-date-picker.html">

<!-- CHRIS ELEMENTS -->
<link rel="import" href="../../chris-api/chris-api.html">

<dom-module id="pacs-find">

  <template>
    <style>

      host {

        display: block;

      }

      .spacer {

        @apply(--layout-flex);

      }

      paper-dialog {

        --paper-date-picker-dialog: {

          margin: 0;
          max-height: 520px !important;
          overflow: hidden;

        };

        --paper-date-picker-dialog-picker: {

          margin-top: 0 !important;
          padding: 0;

        };

        --paper-date-picker-dialog-calendar: {

          padding-bottom: 0;

        };

        --paper-date-picker-dialog-heading: {

          margin-bottom: -62px;

        };

      }

      /* Application of mixins to local .paper-date-picker-dialog elements */
      .paper-date-picker-dialog {
        @apply(--paper-date-picker-dialog);
      }
      .paper-date-picker-dialog > paper-date-picker {
        --paper-calendar: {
          @apply(--paper-date-picker-dialog-calendar);
        };
        @apply(--paper-date-picker-dialog-picker);
      }
      .paper-date-picker-dialog > paper-date-picker:not([narrow]) {
        --paper-date-picker-heading: {
          @apply(--paper-date-picker-dialog-heading);
        };
      }

      .content {

        background-color: var(--paper-grey-50);
        @apply(--layout-vertical);
        @apply(--layout-wrap);
        padding: 24px;
        max-width: 800px;
        margin: auto;
        margin-top: 24px;
        margin-bottom: 100px;

      }

      .item {

        @apply(--layout-horizontal);
        padding: 10px 72px;

      }

      .group {

        @apply(--layout-vertical);
        position: relative;
        padding: 8px 0;

      }

      .name {

        font-size: 18px;
        font-weight: 400;
        color: #737373;

      }

      .submit {

        padding: 16px;
        font-size: 18px;
        font-weight: 400;
        background-color: var(--accent-color);
        color: #ffffff;
        margin-top: 24px;

      }

      .tool {

        @apply(--layout-horizontal);
        cursor: pointer;
        /*padding: 8px 14px;*/
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);

      }

      paper-textarea {

        width: 100%;

      }

      paper-input {

        width: 100%;

      }

      .flex {

        @apply(--layout-flex);
        @apply(--layout-horizontal);
        align-items: center;
        justify-content: flex-start;

      }

      paper-progress {

        display: none;
        width: 100%;
        --paper-progress-active-color: var(--accent-color);

      }

    </style>

    <!-- API connection -->
    <chris-api id="API"
      error="{{error}}">
    </chris-api>

    <!-- Progress bar -->
    <paper-progress id="progressBar" indeterminate></paper-progress>

    <div class="content">

      <div class="group">

        <div class="name tool" on-tap="_toggleSimple">Simple search <div class="spacer"></div> <paper-icon-button id="simpleIcon" icon="icons:expand-less"></paper-icon-button></div>

        <iron-collapse id="simple" opened>

          <div class="item large">
            <div class="flex">
              <paper-textarea id="patientids" label='Patient IDs' value="{{patientID}}"></paper-textarea>
              <paper-tooltip>Tooltip text</paper-tooltip>
            </div>
          </div>

        </iron-collapse>

      </div>

      <div class="group">

        <div class="name tool" on-tap="_toggleAdvanced">Advanced search <div class="spacer"></div> <paper-icon-button id="advancedIcon" icon="icons:expand-more"></paper-icon-button></div>

        <iron-collapse id="advanced">

          <div class="item large">

            <div class="flex">
              <paper-input label="Study Date (Format: MM-DD-YYYY)" value="[[studyDate]]"></paper-input>
              <paper-button class="btn" on-tap="showDialog" raised>Change</paper-button>
            </div>

            <paper-dialog id="dialog" class="paper-date-picker-dialog" modal on-iron-overlay-closed="dismissDialog" on-iron-overlay-opened="patchOverlay" >
              <paper-date-picker id="datePicker"></paper-date-picker>
              <div class="buttons">
                <paper-button dialog-dismiss>Cancel</paper-button>
                <paper-button dialog-confirm>OK</paper-button>
              </div>
            </paper-dialog>

          </div>

        </iron-collapse>

      </div>


      <div class="group">

        <div class="name tool" on-tap="_toggleSettings">PACS settings <div class="spacer"></div> <paper-icon-button id="settingsIcon" icon="icons:expand-more"></paper-icon-button></div>

        <iron-collapse id="settings">

          <div class="item large">
            <div class="flex">
              <paper-input label="PACS Server IP" value="{{pacsSettings.server_ip}}"></paper-input>
            </div>
          </div>

          <div class="item large">
            <div class="flex">
              <paper-input label="PACS Server Port" value="{{pacsSettings.server_port}}"></paper-input>
            </div>
          </div>

          <div class="item large">
            <div class="flex">
              <paper-input label="AET" value="{{pacsSettings.aet}}"></paper-input>
            </div>
          </div>

          <div class="item large">
            <div class="flex">
              <paper-input label="AEC" value="{{pacsSettings.aec}}"></paper-input>
            </div>
          </div>

        </iron-collapse>

      </div>

      <paper-button class="submit" raised on-tap="_find">Search on the PACS</paper-button>

    </div>

  </template>

  <script>

    Polymer({

      is: 'pacs-find',

      properties: {

        query: {
          type: Array,
          value: []
        },

        instances: {
          type: String
        },

        pacsSettings: {
          type: Object
        },

        patientID: {
          type: String,
          value: ''
        },

        studyDate: {
          type: String,
          value: ''
        }

      },

      showDialog: function() {

        this.$.dialog.toggle();
        this.$.dialog.updateStyles();

      },

      patchOverlay: function ( e ) {

        if ( e.currentTarget.backdropElement ) {

          e.currentTarget.parentNode.insertBefore( e.currentTarget.backdropElement, e.currentTarget );

        }

      },

      dismissDialog: function( e ){

        if( e && e.detail && e.detail.confirmed ){

          var dateString = (this.$.datePicker.date.getFullYear()
            + '-' + ('0' + (this.$.datePicker.date.getMonth() + 1)).slice(-2)
            + '-' + ('0' + (this.$.datePicker.date.getDate())).slice(-2));

          this.studyDate = dateString;

        }

      },

      _toggleAdvanced: function(){

        this.$.advanced.toggle();
        this.$.advancedIcon.icon = this.$.advanced.opened ? 'icons:expand-less' : 'icons:expand-more';

      },

      _toggleSimple: function(){

        this.$.simple.toggle();
        this.$.simpleIcon.icon = this.$.simple.opened ? 'icons:expand-less' : 'icons:expand-more';

      },

      _toggleSettings: function(){

        this.$.settings.toggle();
        this.$.settingsIcon.icon = this.$.settings.opened ? 'icons:expand-less' : 'icons:expand-more';

      },

      _find: function(){

        // show loading progress bar
        this.$.progressBar.style.display = 'block';

        // get data for pacs find
        var data = {};
        data.auth = {
          type: 'token',
          token: sessionStorage.getItem('token')
        };

        //
        data.body = {};
        data.body.template = {};
        data.body.template.data = [
          {name: 'aet', value: ''},
          {name: 'aec', value: ''},
          {name: 'server_ip', value: ''},
          {name: 'server_port', value: ''},
          {name: 'modalities_in_study', value: ''},
          {name: 'patient_name', value: ''},
          {name: 'patient_sex', value: ''},
          {name: 'patient_id', value: ''},
          {name: 'study_description', value: ''},
          {name: 'study_date', value: ''},
          {name: 'series_description', value: ''},
          {name: 'performed_station_aet', value: ''}
        ];



        data.body.data = this.pacsSettings;
        data.body.data['patient_id'] = this.patientID;
        data.body.data['study_date'] = this.studyDate;

        var request1 = this.$.API.request( 'GET', this.instances, data );
        request1
          .then( function( response ){ console.log( response ); } )

        var request = this.$.API.request( 'POST', this.instances, data );
        request
          .then( this.handlePacsQuery.bind(this) )
          .then( this.waitUntilFinished.bind(this) )
          .then( this.getFeedFiles.bind(this) )
          .then( this.handleFeedFiles.bind(this) )
          .then( this.getFileContent.bind(this) )
          .then( this.handleFileContent.bind(this) )
          .catch( this.handlePacsQueryError.bind(this) );

      },

      handlePacsQuery: function( response ){

        let p1 = new Promise(

           function(resolve, reject){
             window.setTimeout(
               function(){resolve(response)},
                  1000
              );

           }

        );

        return p1;
        

      },

      waitUntilFinished: function( response ){

        console.log( response );

        // new feed
        let data = {};
        data.auth = {
          type: 'token',
          token: sessionStorage.getItem( 'token' )
        };

        //
        this.fire( 'previous-changed', response.data[0].data.id );

        let waitPromise = new Promise(

           (resolve, reject) => {

             var remaningAttemps = 6;

             function run(){
              //
              this.$.API.request( 'GET', response.data[0].href , data ).
              then( ( response2 ) => {
                // check depdending on status
                console.log( response2.data[0].data.status );
                if( remaningAttemps < 5 && response2.data[0].data.status === 'finishedSuccessfully'){

                  resolve(response2);

                }
                else{
                  remaningAttemps--;
                  if( remaningAttemps <= 0){
                    reject(response2);
                  }
                  else{
                    setTimeout(run, 1000);
                  }
                  

                }
                
              });
             }

             run = run.bind(this);
             run();

           }


        );

        return waitPromise;

      },

      getFeedFiles: function( response ){

        let feed = response.data[0].links.feed;

        console.log(`FEED: ${feed}`);

        var data = {};
        data.auth = {
          type: 'token',
          token: sessionStorage.getItem('token')
        };

        return this.$.API.request( 'GET', feed + 'files/', data );

      },

      handleFeedFiles: function( response ){

        return response.data[0].links.file_resource;

      },

      getFileContent: function( file ){

        var data = {};
        data.auth = {
          type: 'token',
          token: sessionStorage.getItem('token')
        };

        return this.$.API.request( 'GET', file, data );

      },

      handleFileContent: function( response ){

        console.log( response );

        this.$.progressBar.style.display = 'none';
        this.fire( 'results-changed', response.data );

        return 'Done'

      },

      handlePacsQueryError: function( response ){

        console.log( 'error:' + response );

      }

    });

  </script>

</dom-module>
