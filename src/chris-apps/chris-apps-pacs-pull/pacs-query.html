<html><head><link rel="import" href="../../../bower_components/polymer/polymer.html">


<link rel="import" href="../../../bower_components/iron-collapse/iron-collapse.html">


<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../../bower_components/paper-tooltip/paper-tooltip.html">


<script src="https://cdn.vaadin.com/vaadin-core-elements/latest/webcomponentsjs/webcomponents-lite.min.js"></script>

<link rel="import" href="../../../bower_components/vaadin-date-picker/vaadin-date-picker.html">


<link rel="import" href="../../chris-api/chris-api.html">

</head><body><dom-module id="pacs-query">

  <template>
    <style>

      host {

        display: block;

      }

      .spacer {

        @apply(--layout-flex);

      }

      .content {

        background-color: var(--paper-grey-50);
        @apply(--layout-vertical);
        @apply(--layout-wrap);
        padding: 24px;
        max-width: 800px;
        margin: auto;
        margin-top: 24px;
        margin-bottom: 100px;

      }

      .item {

        @apply(--layout-horizontal);
        padding: 10px 72px;

      }

      .group {

        @apply(--layout-vertical);
        position: relative;
        padding: 8px 0;

      }

      .name {

        font-size: 18px;
        font-weight: 400;
        color: #737373;

      }

      .submit {

        padding: 16px;
        font-size: 18px;
        font-weight: 400;
        background-color: var(--accent-color);
        color: #ffffff;
        margin-top: 24px;

      }

      .tool {

        @apply(--layout-horizontal);
        cursor: pointer;
        /*padding: 8px 14px;*/
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);

      }

      paper-textarea {

        width: 100%;

      }

      paper-input {

        width: 100%;

      }

      .flex {

        @apply(--layout-flex);
        @apply(--layout-horizontal);
        align-items: center;
        justify-content: flex-start;

      }

      .labelContainer, vaadin-date-picker {

        display: flex;
        flex-direction: row;
        flex: 1;
        height: 100%;

      }

      .label {

        font: inherit;
        color: #737373;
        -webkit-transition: -webkit-transform 0.25s, width 0.25s;
        transition: transform 0.25s, width 0.25s;
        -webkit-transform-origin: left top;
        transform-origin: left top;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-family: 'Roboto', 'Noto', sans-serif;
        -webkit-font-smoothing: antialiased;
        font-size: 16px;
        font-weight: 400;
        line-height: 24px;
        align-self: flex-end;

      }

    </style>

    
    <chris-api id="API" error="{{error}}">
    </chris-api>

    <div class="content">

      <div class="group">

        <div class="name tool" on-tap="_toggleSimple">Simple search <div class="spacer"></div> <paper-icon-button id="simpleIcon" icon="icons:expand-less"></paper-icon-button></div>

        <iron-collapse id="simple" opened="">

          <div class="item large">
            <div class="flex">
              <paper-textarea id="patientids" label="Patient IDs" value="{{patientID}}"></paper-textarea>
              <paper-tooltip>Tooltip text</paper-tooltip>
            </div>
          </div>

        </iron-collapse>

      </div>

      <div class="group">

        <div class="name tool" on-tap="_toggleAdvanced">Advanced search <div class="spacer"></div> <paper-icon-button id="advancedIcon" icon="icons:expand-more"></paper-icon-button></div>

        <iron-collapse id="advanced">

          <div class="item large">

            <div class="flex">

              <div class="labelContainer">
                <div class="label">Study date</div>
              </div>

              <vaadin-date-picker label="From" value="{{startDate}}" max="[[endDate]]"></vaadin-date-picker>
              <vaadin-date-picker label="To" value="{{endDate}}" min="[[startDate]]"></vaadin-date-picker>

            </div>

          </div>

        </iron-collapse>

      </div>


      <div class="group">

        <div class="name tool" on-tap="_toggleSettings">PACS settings <div class="spacer"></div> <paper-icon-button id="settingsIcon" icon="icons:expand-more"></paper-icon-button></div>

        <iron-collapse id="settings">

          <div class="item large">
            <div class="flex">
              <paper-input label="PACS Server IP" value="{{pacsSettings.server_ip}}"></paper-input>
            </div>
          </div>

          <div class="item large">
            <div class="flex">
              <paper-input label="PACS Server Port" value="{{pacsSettings.server_port}}"></paper-input>
            </div>
          </div>

          <div class="item large">
            <div class="flex">
              <paper-input label="AET" value="{{pacsSettings.aet}}"></paper-input>
            </div>
          </div>

          <div class="item large">
            <div class="flex">
              <paper-input label="AEC" value="{{pacsSettings.aec}}"></paper-input>
            </div>
          </div>

        </iron-collapse>

      </div>

      <paper-button class="submit" raised="" on-tap="_find">Search on the PACS</paper-button>

    </div>

  </template>

  <script>Polymer({is:"pacs-query",properties:{instances:{type:String},pacsSettings:{type:Object},patientID:{type:String,value:""},studyDate:{type:String,value:""}},_toggleAdvanced:function(){this.$.advanced.toggle(),this.$.advancedIcon.icon=this.$.advanced.opened?"icons:expand-less":"icons:expand-more"},_toggleSimple:function(){this.$.simple.toggle(),this.$.simpleIcon.icon=this.$.simple.opened?"icons:expand-less":"icons:expand-more"},_toggleSettings:function(){this.$.settings.toggle(),this.$.settingsIcon.icon=this.$.settings.opened?"icons:expand-less":"icons:expand-more"},_find:function(){var e={};e.auth={type:"token",token:sessionStorage.getItem("token")},e.body={},e.body.template={},e.body.template.data=[{name:"aet",value:""},{name:"aec",value:""},{name:"server_ip",value:""},{name:"server_port",value:""},{name:"modalities_in_study",value:""},{name:"patient_name",value:""},{name:"patient_sex",value:""},{name:"patient_id",value:""},{name:"study_description",value:""},{name:"study_date",value:""},{name:"series_description",value:""},{name:"performed_station_aet",value:""}],e.body.data=this.pacsSettings,e.body.data.patient_id=this.patientID,e.body.data.study_date=this.studyDate;var t=this.$.API.request("POST",this.instances,e);t.then(this.handlePacsQuery.bind(this)).then(this.waitUntilFinished.bind(this)).then(this.getFeedFiles.bind(this)).then(this.handleFeedFiles.bind(this)).then(this.getFileContent.bind(this)).then(this.handleFileContent.bind(this)).catch(this.handlePacsQueryError.bind(this)),this.fire("searching-changed",!0)},handlePacsQuery:function(e){var t=new Promise(function(t,n){window.setTimeout(function(){t(e)},1e3)});return t},waitUntilFinished:function(e){console.log(e);var t={};t.auth={type:"token",token:sessionStorage.getItem("token")},this.fire("previous-changed",e.data[0].data.id),console.log(e.data[0].href);var n=new Promise(function(n,i){function s(){this.$.API.request("GET",e.data[0].href,t).then(function(e){console.log(e),a<5&&"finishedSuccessfully"===e.data[0].data.status?n(e):(a--,a<=0?i(e):setTimeout(s,1e3))}.bind(this))}var a=6;(s=s.bind(this))()}.bind(this));return n},getFeedFiles:function(e){console.log(e);var t=e.data[0].links.feed,n=Number(t.match(/\d+/)[0]);this.fire("feedid-changed",n),console.log("FEED: "+t);var i={};return i.auth={type:"token",token:sessionStorage.getItem("token")},this.$.API.request("GET",t+"files/",i)},handleFeedFiles:function(e){return e.data[0].links.file_resource},getFileContent:function(e){var t={};return t.auth={type:"token",token:sessionStorage.getItem("token")},this.$.API.request("GET",e,t)},handleFileContent:function(e){return console.log(e),this.fire("results-changed",e.data),"Done"},handlePacsQueryError:function(e){console.log("error:"+e)}});</script>

</dom-module>
</body></html>