<link rel="import" href="../../../bower_components/polymer/polymer.html">

<!-- IRON ELEMENTS -->
<link rel="import" href="../../../bower_components/iron-collapse/iron-collapse.html">

<!-- PAPER ELEMENTS -->
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../../bower_components/paper-tooltip/paper-tooltip.html">

<!-- EXTERNAL ELEMENTS -->
<script src="https://cdn.vaadin.com/vaadin-core-elements/latest/webcomponentsjs/webcomponents-lite.min.js"></script>

<link rel="import" href="../../../bower_components/vaadin-date-picker/vaadin-date-picker.html">

<!-- CHRIS ELEMENTS -->
<link rel="import" href="../../chris-api/chris-api.html">
<link rel="import" href="../../chris-behaviors/plugin-behavior/plugin-behavior.html">

<dom-module id="pacs-query">

  <template>
    <style>

      host {
        display: block;
      }

      .spacer {
        @apply(--layout-flex);
      }

      .content {
        background-color: var(--paper-grey-50);
        @apply(--layout-vertical);
        @apply(--layout-wrap);
        padding: 24px;
        max-width: 800px;
        margin: auto;
        margin-top: 24px;
        margin-bottom: 100px;
      }

      .item {
        @apply(--layout-horizontal);
        padding: 10px 72px;
      }

      .group {
        @apply(--layout-vertical);
        position: relative;
        padding: 8px 0;
      }

      .name {
        font-size: 18px;
        font-weight: 400;
        color: #737373;
      }

      .submit {
        padding: 16px;
        font-size: 18px;
        font-weight: 400;
        background-color: var(--accent-color);
        color: #ffffff;
        margin-top: 24px;
      }

      .tool {
        @apply(--layout-horizontal);
        cursor: pointer;
        /*padding: 8px 14px;*/
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
      }

      paper-textarea {
        width: 100%;
      }

      paper-input {
        width: 100%;
      }

      .flex {
        @apply(--layout-flex);
        @apply(--layout-horizontal);
        align-items: center;
        justify-content: flex-start;
      }

      .labelContainer, vaadin-date-picker {
        display: flex;
        flex-direction: row;
        flex: 1;
        height: 100%;
      }

      .label {
        font: inherit;
        color: #737373;
        -webkit-transition: -webkit-transform 0.25s, width 0.25s;
        transition: transform 0.25s, width 0.25s;
        -webkit-transform-origin: left top;
        transform-origin: left top;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-family: 'Roboto', 'Noto', sans-serif;
        -webkit-font-smoothing: antialiased;
        font-size: 16px;
        font-weight: 400;
        line-height: 24px;
        align-self: flex-end;
      }

    </style>

    <!-- API connection -->
    <chris-api id="API"
      error="{{error}}">
    </chris-api>

    <div class="content">

      <div class="group">

        <div class="name tool" on-tap="_toggleSimple">Simple search <div class="spacer"></div> <paper-icon-button id="simpleIcon" icon="icons:expand-less"></paper-icon-button></div>

        <iron-collapse id="simple" opened>

          <div class="item large">
            <div class="flex">
              <paper-textarea id="patientids" label='Patient IDs' value="{{patientID}}"></paper-textarea>
              <paper-tooltip>Tooltip text</paper-tooltip>
            </div>
          </div>

        </iron-collapse>

      </div>

      <div class="group">

        <div class="name tool" on-tap="_toggleAdvanced">Advanced search <div class="spacer"></div> <paper-icon-button id="advancedIcon" icon="icons:expand-more"></paper-icon-button></div>

        <iron-collapse id="advanced">

          <div class="item large">

            <div class="flex">

              <div class="labelContainer">
                <div class="label">Study date</div>
              </div>

              <vaadin-date-picker label="From" value="{{startDate}}" max="[[endDate]]"></vaadin-date-picker>
              <vaadin-date-picker label="To" value="{{endDate}}" min="[[startDate]]"></vaadin-date-picker>

            </div>

          </div>

        </iron-collapse>

      </div>


      <div class="group">

        <div class="name tool" on-tap="_toggleSettings">PACS settings <div class="spacer"></div> <paper-icon-button id="settingsIcon" icon="icons:expand-more"></paper-icon-button></div>

        <iron-collapse id="settings">

          <div class="item large">
            <div class="flex">
              <paper-input label="PACS Server IP" value="{{pacsSettings.server_ip}}"></paper-input>
            </div>
          </div>

          <div class="item large">
            <div class="flex">
              <paper-input label="PACS Server Port" value="{{pacsSettings.server_port}}"></paper-input>
            </div>
          </div>

          <div class="item large">
            <div class="flex">
              <paper-input label="AET" value="{{pacsSettings.aet}}"></paper-input>
            </div>
          </div>

          <div class="item large">
            <div class="flex">
              <paper-input label="AEC" value="{{pacsSettings.aec}}"></paper-input>
            </div>
          </div>

        </iron-collapse>

      </div>

      <paper-button class="submit" raised on-tap="_find">Search on the PACS</paper-button>

    </div>

  </template>

  <script>

    Polymer({

      is: 'pacs-query',

      behaviors: [PluginBehavior],

      properties: {

        plugin: {
          type: Object,
        },

        pacsSettings: {
          type: Object,
        },

        patientID: {
          type: String,
          value: ''
        },

        studyDate: {
          type: String,
          value: ''
        }

      },

      _toggleAdvanced: function() {
        this.$.advanced.toggle();
        this.$.advancedIcon.icon = this.$.advanced.opened ? 'icons:expand-less' : 'icons:expand-more';
      },

      _toggleSimple: function() {
        this.$.simple.toggle();
        this.$.simpleIcon.icon = this.$.simple.opened ? 'icons:expand-less' : 'icons:expand-more';
      },

      _toggleSettings: function() {
        this.$.settings.toggle();
        this.$.settingsIcon.icon = this.$.settings.opened ? 'icons:expand-less' : 'icons:expand-more';
      },

      _find: function() {
        // get data for pacs find
        var data = {};
        data.auth = {
          type: 'token',
          token: sessionStorage.getItem('token')
        };

        //
        data.body = {};
        data.body.template = {};
        data.body.template.data = [
          {name: 'aet', value: ''},
          {name: 'aec', value: ''},
          {name: 'server_ip', value: ''},
          {name: 'server_port', value: ''},
          // {name: 'modalities_in_study', value: ''},
          // {name: 'patient_name', value: ''},
          // {name: 'patient_sex', value: ''},
          // {name: 'study_description', value: ''},
          // {name: 'study_date', value: ''},
          // {name: 'series_description', value: ''},
          // {name: 'performed_station_aet', value: ''}
        ];

        data.body.data = this.pacsSettings;

        if(this.patientID !== '') {
          data.body.template.data.push(
            {name: 'patient_id', value: ''});
          data.body.data['patient_id'] = this.patientID;
        }

        var start = this.__startPlugin(this.$.API, this.plugin, data);
        start
          // https://github.com/FNNDSC/ChRIS_ultron_backEnd/issues/17
          .then(this.__wait.bind(this, 1000))
          .then(this.__waitEndPlugin.bind(this, this.$.API, data))
          .then(this.__getFilesPlugin.bind(this, this.$.API, data))
          .then(this.getFileContent.bind(this))
          .then(this.handleFileContent.bind(this))
          .catch(this.handlePacsQueryError.bind(this));
          
          //
          this.fire( 'searching-changed', true );
      },

      getFileContent: function(files){
        var file = files[0].links.file_resource;

        var data = {};
        data.auth = {
          type: 'token',
          token: sessionStorage.getItem('token')
        };

        return this.$.API.request('GET', file, data);
      },

      handleFileContent: function(response) {
        this.fire('results-changed', response.data);
        return 'Done'
      },

      handlePacsQueryError: function(response) {
        console.log('error:' + response);
        console.log(response);
      }

    });

  </script>

</dom-module>
