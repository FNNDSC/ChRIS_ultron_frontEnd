<link rel="import" href="../../../bower_components/polymer/polymer.html">

<!-- PAPER ELEMENTS -->
<link rel="import" href="../../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-tooltip/paper-tooltip.html">

<!-- EXTERNAL ELEMENTS -->
<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../../../bower_components/paper-fab-transitions/paper-fab-speed-dial.html">

<!-- CHRIS ELEMENTS -->
<link rel="import" href="../../chris-api/chris-api.html">

<dom-module id="pacs-move">

  <template>
    <style>

      host {

        display: block;

      }


      paper-input {

        padding: 0 16px;

      }

      #grid{

        background-color: var(--paper-grey-50);

      }

      #vad{

        background-color: var(--paper-grey-50);
        display: flex;
        flex-direction: column;
        flex: 1;

      }

      paper-fab-speed-dial{

        z-index:10;
        position: fixed;
        bottom: 16px;
        right: 16px;

      }

      .vaadinfoot {

        border: 1px solid #e3e3e3;
        font-size: 18px;
        padding: 16px;
        background-color: var(--paper-grey-50);

      }

      .content {

        position: fixed;
        top: 128px;
        bottom: 0;
        left: 0;
        right: 0;
        display: flex;
        flex-direction: column;

      }

    </style>

    <!-- API connection -->
    <chris-api id="API"
      api="Item",
      content-type="application/json",
      error="{{error}}">
    </chris-api>

    <div class="content">

      <paper-fab-speed-dial direction="top">

        <!-- update icon nd color depending on if there is something to get or not. -->
        <paper-fab id="create" icon="icons:add" class="dropdown-trigger" disabled></paper-fab>
        <div class="dropdown-content">
          <div>
            <paper-fab mini id="export" icon="icons:file-download" on-tap="_getCSV"></paper-fab>
            <paper-tooltip for="export" position="left" animation-delay="0">Selection to CSV</paper-tooltip>
          </div>
          <div>
            <paper-fab mini id="download" icon="icons:save" on-tap="_retrieve"></paper-fab>
            <paper-tooltip for="download" position="left" animation-delay="0">Selection to ChRIS</paper-tooltip>
          </div>
        </div>
      </paper-fab-speed-dial>

      <!--small buble with nb of files to be pulled-->

      <div id="vad">


        <!-- https://vaadin.com/elements/-/element/vaadin-grid -->
        <!-- https://github.com/vaadin/vaadin-grid -->
        <paper-input id="filter" label="Filter results ([[filter.length]])" value="{{filterExp}}"></paper-input>

        <vaadin-grid id="grid" selection-mode="multi" style="height:100%">
          <table>
            <colgroup>

              <col name="PatientID" sortable hidable/>
              <col name="PatientName" max-width="250" sortable hidable/>
              <col name="StudyDescription" max-width="250" sortable hidable/>
              <col name="SeriesDescription" max-width="250" sortable hidable/>
              <col name="NumberOfSeriesRelatedInstances" sortable max-width="200" hidable/>

            </colgroup>

          </table>
        </vaadin-grid>

        <div class="vaadinfoot">
          Selected files: [[selection.length]]
        </div>

      </div>

    </div>

  </template>

  <script>

    Polymer({
      is: 'pacs-move',
      properties: {

        query: {
          type: Array,
          value: [],
          observer: '_queryChanged'
        },

        href: {
          type: String
        },

        filterExp: {
          type: String,
          value: '',
          observer: '_filterExpChanged'
        },

        filter: {
          type: Array,
          value: []
        },

        selection: {
          type: Array,
          value: [],
          observer: '_selectionChanged'
        }
      },

      ready: function(){

        var grid = this.$.grid;

        grid.addEventListener('sort-order-changed', function() {

          var sortOrder = grid.sortOrder[0];
          var sortProperty = grid.columns[sortOrder.column].name;
          var sortDirection = sortOrder.direction;
          grid.items.sort(function(a, b) {
            var res;
            var path = sortProperty.split('.');
            for (var i = 0; i < path.length; i++) {
              a = a[path[i]];
              b = b[path[i]];
            }
            if (!isNaN(a)) {
              res = parseInt(a, 10) - parseInt(b, 10);
            } else {
              res = a.localeCompare(b);
            }

            if ('desc' === sortDirection) {
              res *= -1;
            }
            return res;
          });

        });

        var self = this;
        grid.addEventListener('selected-items-changed', function(e) {

          var selection = [];

          // for (var i = 0; i < grid.selection.size; i += 1) {

          //   selection.push( grid.items[i] );

          // }
          grid.selection.selected(function(index) {

            selection.push( grid.items[index] );

          });

          self.set('selection', selection );

        });

      },

      _queryChanged: function(){

        // format query...
        console.log( this.query );
        if( !this.query || !this.query.series){
          return;
        }
        // loop through series
        var fQuery = [];
        for( var i=0; i<this.query.series.length; i++ ){
          // find related study
          var series = this.query.series[i];
          var study = {};
          for( var j=0; j<this.query.study.length; j++ ){
            if( series.StudyInstanceUID.value === this.query.study[j].StudyInstanceUID.value ){
              study = this.query.study[j];
            }

          }
          // fill row (with extra info for move)
          var row = {};
          row.PatientID = study.PatientID.value;
          row.PatientName = study.PatientName.value;
          row.StudyDescription = study.StudyDescription.value;
          row.SeriesDescription = series.SeriesDescription.value;
          row.NumberOfSeriesRelatedInstances = series.NumberOfSeriesRelatedInstances.value;

          fQuery.push( row );
        }

        this.set('filter', fQuery);

        // fill table
        this.$.grid.items = fQuery;

      },

      _filterExpChanged: function( value ){

        var filterResponse = this.query.filter(function(val) {

          if ( value ) {

            // split on white space
            var values = value.split(" ");
            var match = 0;

            for( var i = 0; i< values.length; i++ ){

              if(
                ((val.PatientID.toLowerCase()).indexOf(values[i]) > -1) ||
                ((val.PatientName.toLowerCase()).indexOf(values[i]) > -1) ||
                ((val.StudyDescription.toLowerCase()).indexOf(values[i]) > -1) ||
                ((val.SeriesDescription.toLowerCase()).indexOf(values[i]) > -1) ||
                ((val.NumberOfSeriesRelatedInstances.toLowerCase()).indexOf(values[i]) > -1) ){
                match += 1;
              }

            }

            if( match === values.length ){

              return true

            }
            else{

              return false;

            }

          } else {
            return true;
          }
        });

        this.set( 'filter', filterResponse );

        // fill table
        this.$.grid.items = this.filter;

      },

      _selectionChanged: function(){

        // update color of FAB
        this.$.create.disabled = this.selection.length > 0 ? false : true;

      },

      _getCSV: function(){

        // convert selection to csv
        var csv = this.toCSV( this.selection );

        // download CSV
        this.downloadCSV( csv );

      },

      toCSV: function( data ){

        var csv = '';

        // fill headers
        for( var key in data[0] ){

          if (data[0].hasOwnProperty(key)) {

            csv += '"' + key + '",';

          }


        }

        csv += '\r\n';

        // fill content
        for( var i = 0; i<data.length; i++){

          for( var key in data[i] ){

            if (data[i].hasOwnProperty(key)) {

              csv += '"' + data[i][key] + '",';

            }
            else{

              csv += '"no value provided",';

            }

          }

          csv += '\r\n';

        }

        return csv;

      },

      // http://halistechnology.com/2015/05/28/use-javascript-to-export-your-data-as-csv/
      downloadCSV: function( csv ) {


        if (csv == null) return;

        var now = new Date();
        filename = "pacs_pull-" +( "0" + now.getFullYear()).slice(-2) + ("0" + now.getMonth()).slice(-2) + ("0" + now.getDate()).slice(-2) + "-" + ("0" + now.getHours()).slice(-2) + ("0" + now.getMinutes()).slice(-2) + ("0" + now.getSeconds()).slice(-2) +  ".csv";

        if (!csv.match(/^data:text\/csv/i)) {
            csv = 'data:text/csv;charset=utf-8,' + csv;
        }

        data = encodeURI(csv);
        // console.log( data )

        link = document.createElement('a');
        link.setAttribute('href', data);
        link.setAttribute('download', filename);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    },

      _retrieve: function(){

        console.log('_retrieve');

        // go API with selection!


        // debug;

        // var params = {
        //   mrns: this.$.mrns.value,
        //   startDate: this.$.startDate.value,
        //   endDate: this.$.endDate.value,
        //   anonymize: this.$.anonymize.checked
        // }

        var request = this.$.API.request( 'PUT', '/pacsquery');
        request
          .then( this.handleRetrieve.bind(this) )
          .catch( this.handleRetrieveError.bind(this) );

        // this.reset();
        // go pacs retrieve
        // 1- post + update optimistic results

      },

      handleRetrieve: function( response ){

        console.log( 'retrieve returned' );

      },

      handleRetrieveError: function( response ){

        console.log( 'retrieve errored' );

      }
    });

  </script>

</dom-module>
