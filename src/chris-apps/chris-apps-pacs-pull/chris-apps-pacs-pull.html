<link rel="import" href="../../../bower_components/polymer/polymer.html">

<!-- IRON ELEMENTS -->
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/iron-pages/iron-pages.html">

<!-- PAPER ELEMENTS -->
<link rel="import" href="../../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../../bower_components/paper-tabs/paper-tab.html">

<!-- CHRIS ELEMENTS -->
<link rel="import" href="../chris-apps-behavior.html">
<link rel="import" href="../../chris-api/chris-api.html">

<!-- BASE ELEMENTS -->
<link rel="import" href="pacs-query.html">
<link rel="import" href="pacs-retrieve.html">

<dom-module id="chris-apps-pacs-pull">

  <template>

    <style>

      host {

        display: block;

      }

    </style>

      <!-- API connection -->
      <chris-api id="API"></chris-api>

      <!-- Toolbar -->
      <div id="toolbar" style="width: 100%; display: flex;">
        <paper-button hidden$="[[_hideButton(page,searching)]]" on-tap="_pageChange"> <iron-icon icon="icons:arrow-back"></iron-icon> Back to search</paper-button>
        <span style="flex: 1;"></span>
      </div>

      <iron-pages selected="{{page}}">

        <pacs-query
          id="find"
          instances="[[pacsqueryInstances]]"
          pacs-settings="[[pacsSettings]]"
          on-pacs-settings-changed="_pacsSettingsChanged"
          on-results-changed="_resultsChanged"
          on-previous-changed="_previousChanged"
          on-searching-changed="_searchingChanged"
          on-feedid-changed="_feedIdChanged">
        </pacs-query>

        <pacs-move
          id="move"
          instances="[[pacsretrieveInstances]]"
          pacs-settings="[[pacsSettings]]"
          results="[[results]]"
          previous="[[previous]]"
          searching="[[searching]]"
          on-add-feed="_addFeed"></pacs-move>

      </iron-pages>

  </template>

  <script>
    Polymer({
        is: 'chris-apps-pacs-pull',
        properties: {

          toolbar: HTMLElement,

          page: {
            type: Number,
            value: 0,
            observer: '_pageChanged'
          },

          feedid: {
            type: Number,
            value: -1
          },

          plugins: {
            type: Array,
            observer: '_pluginsChanged'
          },

          searching: {
            type: Boolean,
            value: false
          },

          previous: {
            type: Number,
            value: 0
          },

          results: {
            type: Array,
            value: []
          },

          pacsSettings:{
            type: Object
          },

          pacsqueryInstances: {
            type: String
          },

          pacsretrieveInstances: {
            type: String
          }

        },

        behaviors: [
          ChrisApps
        ],

        ready: function(){

          console.log('I am ready');

          this.toolbar = this.$.toolbar;

          // PACS Default settings
          this.pacsSettings = {
            aet: 'CHRIS-ULTRON-AET',
            aec: 'CHRIS-ULTRON-AEC',
            aet_listener: 'CHRIS-ULTRON-LIS',
            data_location: '/tmp/host/data',
            server_ip: '192.168.1.39',
            server_port: '4242'
          };

        },

        _pluginsChanged: function( ){

          for( var i = 0; i < this.plugins.length; i++ ){

            if( this.plugins[i].data.name === 'pacsquery' ){

              this.pacsqueryInstances = this.plugins[i].links.instances;

            }

            if( this.plugins[i].data.name === 'pacsretrieve' ){

              this.pacsretrieveInstances = this.plugins[i].links.instances;

            }

          }

        },

        handleError: function( error ){

          console.log( error );

        },

        _resultsChanged: function( event ){

          this.searching = false;
          this.results = event.detail;

        },

        _previousChanged: function( event ){

          this.previous = event.detail;

        },

        _searchingChanged: function( event ){

          this.searching = event.detail;
          console.log( this.searching );
          this.page = 1;

        },

        _pacsSettingsChanged: function( event ){

          this.set(event.detail.path, event.detail.value);

        },

        _hideButton: function(page, searching){

          // show if we areon page 1 and not searching
          var show = (this.page === 1) && (!searching);

          // else hide!
          return !show;

        },

        _pageChange: function( value ){

          if( typeof value === 'object'){

            value = 0;

          }

          this.page = value;

        },

        _pageChanged: function(){

          if( this.page === 0){

            // clean up results
            this.results = [];
            this.previous = '';

            // stop kill promise..?

          }
        },

        _addFeed: function( event ){

          //
          event.preventDefault();
          event.stopPropagation();

          // create the feed:
          var feed = {
            data: {
              color: '#353535',
              date: 'I am the date',
              favorite: false,
              id: this.feedid,
              letter: 'P',
              name: 'chris',
              status: 'finishedSuccessfully',
              tags: []
            },
            href: '/' + this.feedid,
            links: {
              comments: '/' + this.feedid + '/comments/',
              note: '/' + this.feedid + '/note/',
              plugins: '/' + this.feedid + '/plugins/'
            }
          }

          // fire new add-event 
          this.fire('add-feed', feed);
          this.fire('exit-app');

        },

        _feedIdChanged: function( event ){

          event.preventDefault();
          var feedID = event.detail;
          this.feedid = feedID;

        }

    });
  </script>
</dom-module>
