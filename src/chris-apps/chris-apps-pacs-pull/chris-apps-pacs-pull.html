<link rel="import" href="../../../bower_components/polymer/polymer.html">

<!-- IRON ELEMENTS -->
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../../bower_components/iron-pages/iron-pages.html">

<!-- PAPER ELEMENTS -->
<link rel="import" href="../../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../../bower_components/paper-tabs/paper-tab.html">

<!-- CHRIS ELEMENTS -->
<link rel="import" href="../chris-apps-behavior.html">
<link rel="import" href="../../chris-api/chris-api.html">

<!-- BASE ELEMENTS -->
<link rel="import" href="pacs-find.html">
<link rel="import" href="pacs-move.html">

<!--
Chris app pacs-pull element!
@demo demo/index.html
-->

<dom-module id="chris-apps-pacs-pull">

  <template>

    <style>

      host {

        display: block;

      }

      paper-tabs {

        --paper-tabs-selection-bar-color: var(--accent-color);

      }

      paper-tab {

        --paper-tab-ink: var(--accent-color);

      }

    </style>

      <!-- API connection -->
      <chris-api id="API"></chris-api>

      <!-- Toolbar -->
      <div id="toolbar">
        <paper-tabs selected="{{selected}}">
          <paper-tab>Search</paper-tab>
          <paper-tab>Results ([[results.length]])</paper-tab>
        </paper-tabs>
      </div>

      <iron-pages selected="{{selected}}">

        <pacs-find id="find" instances="[[pacsqueryInstances]]" pacs-settings="[[pacsSettings]]" on-pacs-settings-changed="_pacsSettingsChanged" on-results-changed="_resultsChanged" on-previous-changed="_previousChanged"></pacs-find>
        <pacs-move id="move" instances="[[pacsretrieveInstances]]" pacs-settings="[[pacsSettings]]" results="[[results]]" previous="[[previous]]"></pacs-move>

      </iron-pages>

  </template>

  <script>
    Polymer({
        is: 'chris-apps-pacs-pull',
        properties: {

          toolbar: HTMLElement,

          selected: {
            type: Number,
            value: 0
          },

          previous: {
            type: Number,
            value: 0
          },

          results: {
            type: Array,
            value: []
          },

          pacsSettings:{
            type: Object
          },

          pacsqueryInstances: {
            type: String
          },

          pacsretrieveInstances: {
            type: String
          }

        },

        behaviors: [
          ChrisApps
        ],

        ready: function(){

          this.toolbar = this.$.toolbar;

          // PACS Default settings
          this.pacsSettings = {
            aet: 'CHRIS-ULTRON-AET',
            aec: 'CHRIS-ULTRON-AEC',
            aet_listener: 'CHRIS-ULTRON-LIS',
            data_location: '/tmp/host/data',
            server_ip: '192.168.1.39',
            server_port: '4242'
          };

          // fetch pacsquery and pacsmove ids from the REST API
          //
          var data = {};
          data.auth = {
            type: 'token',
            token: sessionStorage.getItem('token')
          };

          // fetch the plugins
          var request = this.$.API.request('GET', 'plugins', data);
          request
            .then( this.handlePlugins.bind(this) )
            .catch( this.handleError.bind(this) );

        },

        handlePlugins: function( response ){

          for( var i = 0; i < response.data.length; i++ ){

            if( response.data[i].data.name === 'pacsquery' ){

              this.pacsqueryInstances = response.data[i].links.instances;

            }

            if( response.data[i].data.name === 'pacsretrieve' ){

              this.pacsretrieveInstances = response.data[i].links.instances;

            }

          }

        },

        handleError: function( error ){

          console.log( error );

        },

        // because if so the callback is called at creation time.
        _resultsChanged: function( event ){

          this.results = event.detail;
          this.selected = 1;

        },

        _previousChanged: function( event ){

          this.previous = event.detail;

        },

        _pacsSettingsChanged: function( event ){

          this.set(event.detail.path, event.detail.value);

        }

    });
  </script>
</dom-module>
