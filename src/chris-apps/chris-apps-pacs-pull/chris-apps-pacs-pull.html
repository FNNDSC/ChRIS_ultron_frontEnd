<link rel="import" href="../../../bower_components/polymer/polymer.html">

<!-- IRON ELEMENTS -->
<link rel="import" href="../../../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/iron-pages/iron-pages.html">


<!-- PAPER ELEMENTS -->
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../../bower_components/paper-tabs/paper-tab.html">

<!-- EXTERNAL ELEMENTS -->
<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../../../bower_components/paper-date-picker/paper-date-picker.html">

<!-- CHRIS ELEMENTS -->
<link rel="import" href="../../chris-api/chris-api.html">

<!--
Chris app pacs-pull element!
@demo demo/index.html
-->

<dom-module id="chris-apps-pacs-pull">

  <template>

    <style>

      host {

        display: block;

      }

      .spacer {

        @apply(--layout-flex);

      }

      .container {

        padding: 10px;

      }

      paper-tabs {

        --paper-tabs-selection-bar-color: var(--accent-color);

      }

      paper-tab {

        --paper-tab-ink: var(--accent-color);

      }

      paper-dialog {

        --paper-date-picker-dialog: {

          margin: 0;
          max-height: 520px !important;
          overflow: hidden;

        };

        --paper-date-picker-dialog-picker: {

          margin-top: 0 !important;
          padding: 0;

        };

        --paper-date-picker-dialog-calendar: {

          padding-bottom: 0;

        };

        --paper-date-picker-dialog-heading: {

          margin-bottom: -62px;

        };
        
      }

      /* Application of mixins to local .paper-date-picker-dialog elements */
      .paper-date-picker-dialog {
        @apply(--paper-date-picker-dialog);
      }
      .paper-date-picker-dialog > paper-date-picker {
        --paper-calendar: {
          @apply(--paper-date-picker-dialog-calendar);
        };
        @apply(--paper-date-picker-dialog-picker);
      }
      .paper-date-picker-dialog > paper-date-picker:not([narrow]) {
        --paper-date-picker-heading: {
          @apply(--paper-date-picker-dialog-heading);
        };
      }

      .form {

        @apply(--layout-vertical);
        @apply(--layout-wrap);
        padding-top: 24px;

      }

      .item {

        @apply(--layout-horizontal);
        padding: 10px 72px;

      }

      .group {

        @apply(--layout-vertical);
        position: relative;
        padding: 8px 0;

      }

      .flex {

        @apply(--layout-flex);
        @apply(--layout-horizontal);
        align-items: center;
        justify-content: flex-start;
        /*flex: 1;*/

      }

      .help {
        /*flex: 0;*/
      }

      paper-textarea, paper-input {
        width: 100%;
      }

      .name {

        font-size: 22px;
        font-weight: 400;
        color: #737373;

      }

      .submit {

        padding: 16px;
        font-size: 18px;
        font-weight: 400;
        background-color: var(--accent-color);
        color: #ffffff;
        margin-top: 24px;

      }

      .tool {

        @apply(--layout-horizontal);
        cursor: pointer;
        padding: 8px 14px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);

      }

    </style>

      <chris-api id="ItemAPI"
        api="Item",
        content-type="application/json",
        error="{{error}}">
      </chris-api>

      <div class="container" >

        <paper-tabs selected="{{selected}}">
          <paper-tab class="name">Search</paper-tab>
          <paper-tab class="name">Results</paper-tab>
        </paper-tabs>

        <iron-pages selected="{{selected}}">
          <div class="form">

          <div class="group">

            <div class="name tool" on-tap="_toggleSimple">Simple search <div class="spacer"></div> <paper-icon-button id="simpleIcon" icon="icons:expand-less"></paper-icon-button></div>

            <iron-collapse id="simple" opened>

              <div class="item large">
                <div class="flex">
                  <paper-textarea label="Patient MRN(s)"></paper-textarea>
                </div>

                <div class="help">
                  <paper-icon-button icon="icons:help-outline"></paper-icon-button>
                </div>
              </div>

            </iron-collapse>

          </div>

          <div class="group">

            <div class="name tool" on-tap="_toggleAdvanced">Advanced search <div class="spacer"></div> <paper-icon-button id="advancedIcon" icon="icons:expand-more"></paper-icon-button></div>

            <iron-collapse id="advanced">

              <div class="item large">

                <div class="flex">
                  <paper-input label="Start Date" value="[[date]]"></paper-input>
                  <paper-button class="btn" on-tap="showDialog" raised>Change</paper-button>
                </div>

                <div>
                  <paper-icon-button icon="icons:help-outline"></paper-icon-button>
                </div>

                <paper-dialog id="dialog" class="paper-date-picker-dialog" modal on-iron-overlay-closed="dismissDialog" on-iron-overlay-opened="patchOverlay" >
                  <paper-date-picker id="picker" date="{{date}}" ></paper-date-picker>
                  <div class="buttons">
                    <paper-button dialog-dismiss>Cancel</paper-button>
                    <paper-button dialog-confirm>OK</paper-button>
                  </div>
                </paper-dialog>

              </div>

              <div class="item large">

                <div class="flex">
                  <paper-input label="End Date" value="[[date]]"></paper-input>
                  <paper-button class="btn" on-tap="showDialog" raised>Change</paper-button>
                </div>

                <div>
                  <paper-icon-button icon="icons:help-outline"></paper-icon-button>
                </div>

                <paper-dialog id="dialog" class="paper-date-picker-dialog" modal on-iron-overlay-closed="dismissDialog" on-iron-overlay-opened="patchOverlay" >
                  <paper-date-picker id="picker" date="{{date}}" ></paper-date-picker>
                  <div class="buttons">
                    <paper-button dialog-dismiss>Cancel</paper-button>
                    <paper-button dialog-confirm>OK</paper-button>
                  </div>
                </paper-dialog>

              </div>

              <div class="item small">
                
                <div class="flex">
                  <paper-input label="Modality"></paper-input>
                </div>

                <div>
                  <paper-icon-button icon="icons:help-outline"></paper-icon-button>
                </div>

              </div>

              <div class="item large">
                
                <div class="flex">
                  <paper-checkbox>Anonymize results</paper-checkbox>
                </div>

                <div>
                  <paper-icon-button icon="icons:help-outline"></paper-icon-button>
                </div>

              </div>

            </iron-collapse>

            </div>


          <div class="group">

            <div class="name tool" on-tap="_toggleSettings">PACS settings <div class="spacer"></div> <paper-icon-button id="settingsIcon" icon="icons:expand-more"></paper-icon-button></div>

            <iron-collapse id="settings">

              <div class="item large">
                <div class="flex">
                  <paper-input label="PACS IP"></paper-input>
                </div>

                <div class="help">
                  <paper-icon-button icon="icons:help-outline"></paper-icon-button>
                </div>
              </div>

              <div class="item large">
                <div class="flex">
                  <paper-input label="AETITLE"></paper-input>
                </div>

                <div class="help">
                  <paper-icon-button icon="icons:help-outline"></paper-icon-button>
                </div>
              </div>

            </iron-collapse>

          </div>

            <paper-button class="submit" raised>Search on the PACS</paper-button>

          </div>

          <div>
            <div id="vad">
            <!-- https://vaadin.com/elements/-/element/vaadin-grid -->
            <!-- https://github.com/vaadin/vaadin-grid -->

            <paper-input id="filter" label="Filter by first name"></paper-input>

            <vaadin-grid id="sort" selection-mode="multi" style="height:100%">
              <table>
                <colgroup>
                  <col name="firstName" sortable/>
                  <col name="lastName" sortable/>
                  <col name="email" sortable/>
                </colgroup>
              </table>
            </vaadin-grid>

            </div>

          </div>

        </iron-pages>
         
      </div>

  </template>

  <script>
    Polymer({
        is: 'chris-apps-pacs-pull',
        properties: {

          selected: {
            type: Number,
            value: 0
          },

          parameters: {
            type: Object
          }
        },

        ready: function(){

          var grid = this.$.sort;
          var users = [];

          this.getJSON('https://demo.vaadin.com/demo-data/1.0/people', function(json) {
            users = json.result;
            grid.items = users;
          });

          grid.addEventListener('sort-order-changed', function() {

            var sortOrder = grid.sortOrder[0];
            var sortProperty = grid.columns[sortOrder.column].name;
            var sortDirection = sortOrder.direction;
            grid.items.sort(function(a, b) {
              var res;
              var path = sortProperty.split('.');
              for (var i = 0; i < path.length; i++) {
                a = a[path[i]];
                b = b[path[i]];
              }
              if (!isNaN(a)) {
                res = parseInt(a, 10) - parseInt(b, 10);
              } else {
                res = a.localeCompare(b);
              }

              if ('desc' === sortDirection) {
                res *= -1;
              }
              return res;
            });

          });

          var filterInput = this.$.filter;
          filterInput.addEventListener('value-changed', function() {

            var filterText = filterInput.value.toLowerCase();
            grid.items = users.filter(function(val) {
              if (filterText) {
                return (val.firstName.toLowerCase()).indexOf(filterText) > -1;
              } else {
                return true;
              }
            });

          });

        },

        getJSON: function(url, callback) {
          var xhr = new XMLHttpRequest();
          xhr.onreadystatechange = function() {
            if (xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
              callback(JSON.parse(xhr.responseText));
            }
          };
          xhr.open('GET', url, true);
          xhr.send();
        },

        generateParameters: function(){

          // get parameters
          //
          this.parameters = {
            hello: 'from',
            the: 'pacs_pull'
          }

          // let plugin-fs know the parameters are ready
          this.fire( 'parameters-changed' );

        },

        showDialog: function() {

          this.$.dialog.toggle();
          this.$.dialog.updateStyles();

        },

        patchOverlay: function ( e ) {

          if ( e.currentTarget.backdropElement ) {

            e.currentTarget.parentNode.insertBefore( e.currentTarget.backdropElement, e.currentTarget );

          }

        },

        _toggleAdvanced: function(){

          this.$.advanced.toggle();
          this.$.advancedIcon.icon = this.$.advanced.opened ? 'icons:expand-less' : 'icons:expand-more';

        },

        _toggleSimple: function(){

          this.$.simple.toggle();
          this.$.simpleIcon.icon = this.$.simple.opened ? 'icons:expand-less' : 'icons:expand-more';

        },

        _toggleSettings: function(){

          this.$.settings.toggle();
          this.$.settingsIcon.icon = this.$.settings.opened ? 'icons:expand-less' : 'icons:expand-more';

        }
    });
  </script>
</dom-module>