<html><head><link rel="import" href="../../../bower_components/polymer/polymer.html">



<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/iron-icons/editor-icons.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../../../bower_components/paper-tooltip/paper-tooltip.html">


<script src="https://cdn.vaadin.com/vaadin-core-elements/latest/webcomponentsjs/webcomponents-lite.min.js"></script>
<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../../../bower_components/paper-fab-transitions/paper-fab-speed-dial.html">


<link rel="import" href="../../chris-api/chris-api.html">

</head><body><dom-module id="pacs-move">

  <template>
    <style>

      host {

        display: block;

      }


      paper-input {

        padding: 0 16px;

      }

      #grid{

        background-color: var(--paper-grey-50);

      }

      #vad{

        background-color: var(--paper-grey-50);
        display: flex;
        flex-direction: column;
        flex: 1;

      }

      paper-fab-speed-dial{

        z-index:10;
        position: fixed;
        bottom: 16px;
        right: 16px;

      }

      .content {

        position: fixed;
        top: 128px;
        bottom: 0;
        left: 0;
        right: 0;
        display: flex;
        flex-direction: column;

      }

      paper-badge {

        z-index: 999;

      }

      paper-progress {

        width: 100%;
        --paper-progress-active-color: var(--accent-color);

      }

      .load {

        text-align: center;
        color: #ffffff;
        display: inline-block;
        font-size: 2.4em;
        position: relative;
        top: 1em;
        display: block;
        /*-webkit-transform: scale(.9);*/
        /*-moz-transform: scale(.9);*/
        /*transform: scale(.9);*/

      }

      .beat {

        color: var(--light-accent-color);
        -webkit-animation: love .5s infinite linear alternate-reverse;
        -moz-animation: love .5s infinite linear alternate-reverse;
        animation: love .5s infinite linear alternate-reverse;

      }

      @keyframes love {

        animation-name: love;
        animation-duration: 0.5s;
        animation-timing-function: linear;
        animation-delay: initial;
        animation-iteration-count: infinite;
        animation-direction: alternate-reverse;
        animation-fill-mode: initial;
        animation-play-state: initial;

        0% {
          transform: scale(0.9);
          }
        100% {
          transform: scale(1.1);
        }

      }

      #vad[hidden], .load[hidden]{

        display: none

      }

      .vaadinfoot {

        text-align: center;
        border: 1px solid #e3e3e3;
        font-size: 18px;
        padding: 16px;
        background-color: var(--paper-grey-50);

      }

      paper-button {

        padding: 16px;
        font-size: 18px;

      }

      #retrieve {

        background-color: var(--accent-color);
        color: #ffffff;
        width: 100%;
        max-width: 400px;

      }

      #retrieve[disabled] {

        background-color: var(--light-accent-color);

     }

    </style>

    
    <chris-api id="API" content-type="application/json" ,="" error="{{error}}">
    </chris-api>

    <div class="content">

      
      <paper-progress id="progressBar" indeterminate="" hidden$="[[!searching]]"></paper-progress>
      <div hidden$="[[!searching]]" class="load">
        Fetching data... <div class="beat">â™¥</div>
      </div>

      <div id="vad" hidden$="[[searching]]">

        <paper-input id="filter" label="Filter results ([[filter.length]])" value="{{filterExp}}"></paper-input>

        <vaadin-grid id="grid" selection-mode="multi" style="height:100%">
          <table>
            <colgroup>

              <col name="PatientID" sortable="" hidable="">
              <col name="PatientName" max-width="250" sortable="" hidable="">
              <col name="StudyDescription" max-width="250" sortable="" hidable="">
              <col name="SeriesDescription" max-width="250" sortable="" hidable="">
              <col name="NumberOfSeriesRelatedInstances" sortable="" max-width="200" hidable="">
              <col name="uid" sortable="" max-width="200" hidden="">

            </colgroup>
          </table>
        </vaadin-grid>

        <div class="vaadinfoot">
          <paper-button id="retrieve" raised="" on-tap="_retrieve" disabled="">Pull [[selection.length]] series</paper-button>
          <paper-button id="csv" raised="" on-tap="_getCSV">CSV<iron-icon icon="icons:file-download"></iron-icon></paper-button>
        </div>

      </div>

    </div>

  </template>

  <script>Polymer({is:"pacs-move",properties:{results:{type:Array,value:[],observer:"_resultsChanged"},searching:{type:Boolean,value:!1},previous:{type:Number,value:0},pacsSettings:{type:Object},filterExp:{type:String,value:"",observer:"_filterExpChanged"},filter:{type:Array,value:[]},selection:{type:Array,value:[],observer:"_selectionChanged"}},ready:function(){var e=this.$.grid;e.addEventListener("sort-order-changed",function(){var t=e.sortOrder[0],i=e.columns[t.column].name,s=t.direction;e.items.sort(function(e,t){for(var r,n=i.split("."),a=0;a<n.length;a++)e=e[n[a]],t=t[n[a]];return r=isNaN(e)?e.localeCompare(t):parseInt(e,10)-parseInt(t,10),"desc"===s&&(r*=-1),r})});var t=this;e.addEventListener("selected-items-changed",function(i){var s=[];e.selection.selected(function(e){s.push(t.filter[e])}),t.set("selection",s)})},_resultsChanged:function(){for(var e=[],t=0;t<this.results.length;t++){var i={};i.PatientID=this.results[t].PatientID.value,i.PatientName=this.results[t].PatientName.value,i.StudyDescription=this.results[t].StudyDescription.value,i.SeriesDescription=this.results[t].SeriesDescription.value,i.NumberOfSeriesRelatedInstances=this.results[t].NumberOfSeriesRelatedInstances.value,i.uid=this.results[t].uid.value,e.push(i)}this.set("filter",e),this.$.grid.items=e},_filterExpChanged:function(e){e=e.toLowerCase();for(var t=this.results.filter(function(t){if(e){for(var i=e.split(" "),s=0,r=0;r<i.length;r++)(t.PatientID.value.toLowerCase().indexOf(i[r])>-1||t.PatientName.value.toLowerCase().indexOf(i[r])>-1||t.StudyDescription.value.toLowerCase().indexOf(i[r])>-1||t.SeriesDescription.value.toLowerCase().indexOf(i[r])>-1||t.NumberOfSeriesRelatedInstances.value.toLowerCase().indexOf(i[r])>-1)&&(s+=1);return s===i.length}return!0}),i=[],s=0;s<t.length;s++){var r={};r.PatientID=t[s].PatientID.value,r.PatientName=t[s].PatientName.value,r.StudyDescription=t[s].StudyDescription.value,r.SeriesDescription=t[s].SeriesDescription.value,r.NumberOfSeriesRelatedInstances=t[s].NumberOfSeriesRelatedInstances.value,r.uid=t[s].uid.value,i.push(r)}this.set("filter",i),this.$.grid.items=this.filter},_selectionChanged:function(){this.$.retrieve.disabled=!(this.selection.length>0),this.$.csv.disabled=!(this.selection.length>0)},_getCSV:function(){var e=this.toCSV(this.selection);this.downloadCSV(e)},toCSV:function(e){function t(e){return i.indexOf(e.uid.value)>=0}for(var i=[],s=0;s<e.length;s++)i.push(e[s].uid);var r=this.results.filter(t),n="";for(var a in r[0])r[0].hasOwnProperty(a)&&(n+='"'+a+'",');n+="\r\n";for(var l=0;l<r.length;l++){for(var a in r[l])n+=r[l].hasOwnProperty(a)?'"'+r[l][a].value+'",':'"no value provided",';n+="\r\n"}return n},downloadCSV:function(e){if(null!=e){var t=new Date;filename="pacs_pull-"+("0"+t.getFullYear()).slice(-2)+("0"+t.getMonth()).slice(-2)+("0"+t.getDate()).slice(-2)+"-"+("0"+t.getHours()).slice(-2)+("0"+t.getMinutes()).slice(-2)+("0"+t.getSeconds()).slice(-2)+".csv",e.match(/^data:text\/csv/i)||(e="data:text/csv;charset=utf-8,"+e),data=encodeURI(e),link=document.createElement("a"),link.setAttribute("href",data),link.setAttribute("download",filename),document.body.appendChild(link),link.click(),document.body.removeChild(link)}},_retrieve:function(){var e={};e.auth={type:"token",token:sessionStorage.getItem("token")},e.body={},e.body.template={},e.body.template.data=[{name:"aet",value:""},{name:"aec",value:""},{name:"aet_listener",value:""},{name:"server_ip",value:""},{name:"server_port",value:""},{name:"series_uids",value:""},{name:"series_file",value:""},{name:"data_location",value:""},{name:"previous",value:""}],e.body.data=this.pacsSettings,e.body.data.series_uids="0,1",e.body.data.previous=this.previous;var t=this.$.API.request("POST",this.instances,e);t.then(this.handleRetrieve.bind(this)).catch(this.handleRetrieveError.bind(this))},handleRetrieve:function(e){console.log("retrieve returned"),console.log(e),this.fire("add-feed")},handleRetrieveError:function(e){console.log("retrieve errored"),console.log(e)}});</script>

</dom-module>
</body></html>