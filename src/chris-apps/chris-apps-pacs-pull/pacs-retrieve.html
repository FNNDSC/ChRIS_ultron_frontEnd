<html><head><link rel="import" href="../../../bower_components/polymer/polymer.html">



<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/iron-icons/editor-icons.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../../../bower_components/paper-tooltip/paper-tooltip.html">


<script src="https://cdn.vaadin.com/vaadin-core-elements/latest/webcomponentsjs/webcomponents-lite.min.js"></script>
<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../../../bower_components/paper-fab-transitions/paper-fab-speed-dial.html">


<link rel="import" href="../../chris-api/chris-api.html">

</head><body><dom-module id="pacs-move">

  <template>
    <style>

      host {

        display: block;

      }


      paper-input {

        padding: 0 16px;

      }

      #grid{

        background-color: var(--paper-grey-50);

      }

      #vad{

        background-color: var(--paper-grey-50);
        display: flex;
        flex-direction: column;
        flex: 1;

      }

      paper-fab-speed-dial{

        z-index:10;
        position: fixed;
        bottom: 16px;
        right: 16px;

      }

      .content {

        position: fixed;
        top: 128px;
        bottom: 0;
        left: 0;
        right: 0;
        display: flex;
        flex-direction: column;

      }

      paper-badge {

        z-index: 999;

      }

      paper-progress {

        width: 100%;
        --paper-progress-active-color: var(--accent-color);

      }

      .load {

        text-align: center;
        color: #ffffff;
        display: inline-block;
        font-size: 2.4em;
        position: relative;
        top: 1em;
        display: block;
        /*-webkit-transform: scale(.9);*/
        /*-moz-transform: scale(.9);*/
        /*transform: scale(.9);*/

      }

      .beat {

        color: var(--light-accent-color);
        -webkit-animation: love .5s infinite linear alternate-reverse;
        -moz-animation: love .5s infinite linear alternate-reverse;
        animation: love .5s infinite linear alternate-reverse;

      }

      @keyframes love {

        animation-name: love;
        animation-duration: 0.5s;
        animation-timing-function: linear;
        animation-delay: initial;
        animation-iteration-count: infinite;
        animation-direction: alternate-reverse;
        animation-fill-mode: initial;
        animation-play-state: initial;

        0% {
          transform: scale(0.9);
          }
        100% {
          transform: scale(1.1);
        }

      }

      #vad[hidden], .load[hidden]{

        display: none

      }

      .vaadinfoot {

        text-align: center;
        border: 1px solid #e3e3e3;
        font-size: 18px;
        padding: 16px;
        background-color: var(--paper-grey-50);

      }

      paper-button {

        padding: 16px;
        font-size: 18px;

      }

      #retrieve {

        background-color: var(--accent-color);
        color: #ffffff;
        width: 100%;
        max-width: 400px;

      }

      #retrieve[disabled] {

        background-color: var(--light-accent-color);

     }

    </style>

    
    <chris-api id="API" content-type="application/json" ,="" error="{{error}}">
    </chris-api>

    <div class="content">

      
      <paper-progress id="progressBar" indeterminate="" hidden$="[[!searching]]"></paper-progress>
      <div hidden$="[[!searching]]" class="load">
        Fetching data... <div class="beat">â™¥</div>
      </div>

      <div id="vad" hidden$="[[searching]]">

        <paper-input id="filter" label="Filter results ([[filter.length]])" value="{{filterExp}}"></paper-input>

        <vaadin-grid id="grid" selection-mode="multi" style="height:100%">
          <table>
            <colgroup>

              <col name="PatientID" sortable="" hidable="">
              <col name="PatientName" max-width="250" sortable="" hidable="">
              <col name="StudyDescription" max-width="250" sortable="" hidable="">
              <col name="SeriesDescription" max-width="250" sortable="" hidable="">
              <col name="NumberOfSeriesRelatedInstances" sortable="" max-width="200" hidable="">
              <col name="uid" sortable="" max-width="200" hidden="">

            </colgroup>
          </table>
        </vaadin-grid>

        <div class="vaadinfoot">
          <paper-button id="retrieve" raised="" on-tap="_retrieve" disabled="">Pull [[selection.length]] series</paper-button>
          <paper-button id="csv" raised="" on-tap="_getCSV">CSV<iron-icon icon="icons:file-download"></iron-icon></paper-button>
        </div>

      </div>

    </div>

  </template>

  <script>

    Polymer({
      is: 'pacs-move',
      properties: {

        results: {
          type: Array,
          value: [],
          observer: '_resultsChanged'
        },

        searching: {
          type: Boolean,
          value: false
        },

        previous: {
          type: Number,
          value: 0
        },

        pacsSettings: {
          type: Object
        },

        filterExp: {
          type: String,
          value: '',
          observer: '_filterExpChanged'
        },

        filter: {
          type: Array,
          value: []
        },

        selection: {
          type: Array,
          value: [],
          observer: '_selectionChanged'
        }
      },

      ready: function(){

        var grid = this.$.grid;

        grid.addEventListener('sort-order-changed', function() {

          var sortOrder = grid.sortOrder[0];
          var sortProperty = grid.columns[sortOrder.column].name;
          var sortDirection = sortOrder.direction;
          grid.items.sort(function(a, b) {
            var res;
            var path = sortProperty.split('.');
            for (var i = 0; i < path.length; i++) {
              a = a[path[i]];
              b = b[path[i]];
            }
            if (!isNaN(a)) {
              res = parseInt(a, 10) - parseInt(b, 10);
            } else {
              res = a.localeCompare(b);
            }

            if ('desc' === sortDirection) {
              res *= -1;
            }
            return res;
          });

        });

        var self = this;
        grid.addEventListener('selected-items-changed', function(e) {

          var selection = [];
          grid.selection.selected(function(index) {

            // should fetch selection from the filter
            // so indices match
            selection.push( self.filter[index] );

          });

          self.set('selection', selection );

        });

      },

      _resultsChanged: function(){

        // format query...
        // loop through series
        let filter = [];
        for( var i=0; i<this.results.length; i++ ){

          // fill row (with extra info for move)
          let row = {};
          row.PatientID = this.results[i].PatientID.value;
          row.PatientName = this.results[i].PatientName.value;
          row.StudyDescription = this.results[i].StudyDescription.value;
          row.SeriesDescription = this.results[i].SeriesDescription.value;
          row.NumberOfSeriesRelatedInstances = this.results[i].NumberOfSeriesRelatedInstances.value;
          row.uid = this.results[i].uid.value;

          filter.push( row );
        }

        this.set( 'filter', filter );

        // fill table
        this.$.grid.items = filter;

      },

      _filterExpChanged: function( value ){

        // make sure we are not sensitive to capital letters
        value = value.toLowerCase();

        var filterResponse = this.results.filter(function(val) {

          if ( value ) {

            // split on white space
            var values = value.split(" ");
            var match = 0;

            for( var i = 0; i< values.length; i++ ){

              if(
                ((val.PatientID.value.toLowerCase()).indexOf(values[i]) > -1) ||
                ((val.PatientName.value.toLowerCase()).indexOf(values[i]) > -1) ||
                ((val.StudyDescription.value.toLowerCase()).indexOf(values[i]) > -1) ||
                ((val.SeriesDescription.value.toLowerCase()).indexOf(values[i]) > -1) ||
                ((val.NumberOfSeriesRelatedInstances.value.toLowerCase()).indexOf(values[i]) > -1) ){
                match += 1;
              }

            }

            if( match === values.length ){

              return true

            }
            else{

              return false;

            }

          } else {
            return true;
          }
        });

        var filter = [];
        for( var i=0; i<filterResponse.length; i++ ){

          // fill row (with extra info for move)
          var row = {};
          row.PatientID = filterResponse[i].PatientID.value;
          row.PatientName = filterResponse[i].PatientName.value;
          row.StudyDescription = filterResponse[i].StudyDescription.value;
          row.SeriesDescription = filterResponse[i].SeriesDescription.value;
          row.NumberOfSeriesRelatedInstances = filterResponse[i].NumberOfSeriesRelatedInstances.value;
          row.uid = filterResponse[i].uid.value;

          filter.push( row );

        }

        this.set( 'filter', filter );

        // fill table
        this.$.grid.items = this.filter;

      },

      _selectionChanged: function(){

        // update state of button
        this.$.retrieve.disabled = this.selection.length > 0 ? false : true;
        this.$.csv.disabled = this.selection.length > 0 ? false : true;

      },

      _getCSV: function(){

        // convert selection to csv
        var csv = this.toCSV( this.selection );

        // download CSV
        this.downloadCSV( csv );

      },

      toCSV: function( data ){

        // filter results by selection.uid
        var uids = [];
        for( var j=0; j<data.length; j++){
          uids.push(data[j]['uid']);
        }

        function isSelected( value ){
          return uids.indexOf( value['uid'].value ) >= 0;
        }

        var finalSelection = this.results.filter(isSelected);


        var csv = '';

        // fill headers
        for( var key in finalSelection[0] ){

          if (finalSelection[0].hasOwnProperty(key)) {

            csv += '"' + key + '",';

          }


        }

        csv += '\r\n';

        // fill content
        for( var i = 0; i<finalSelection.length; i++){

          for( var key in finalSelection[i] ){

            if (finalSelection[i].hasOwnProperty(key)) {

              csv += '"' + finalSelection[i][key].value + '",';

            }
            else{

              csv += '"no value provided",';

            }

          }

          csv += '\r\n';

        }

        return csv;

      },

      // http://halistechnology.com/2015/05/28/use-javascript-to-export-your-data-as-csv/
      downloadCSV: function( csv ) {


        if (csv == null) return;

        var now = new Date();
        filename = "pacs_pull-" +( "0" + now.getFullYear()).slice(-2) + ("0" + now.getMonth()).slice(-2) + ("0" + now.getDate()).slice(-2) + "-" + ("0" + now.getHours()).slice(-2) + ("0" + now.getMinutes()).slice(-2) + ("0" + now.getSeconds()).slice(-2) +  ".csv";

        if (!csv.match(/^data:text\/csv/i)) {
            csv = 'data:text/csv;charset=utf-8,' + csv;
        }

        data = encodeURI(csv);
        // console.log( data )

        link = document.createElement('a');
        link.setAttribute('href', data);
        link.setAttribute('download', filename);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    },

      _retrieve: function(){

        var data = {};
        data.auth = {
          type: 'token',
          token: sessionStorage.getItem('token')
        };

        //
        data.body = {};
        data.body.template = {};
        data.body.template.data = [
          {name: 'aet',           value: ''},
          {name: 'aec',           value: ''},
          {name: 'aet_listener',  value: ''},
          {name: 'server_ip',     value: ''},
          {name: 'server_port',   value: ''},
          {name: 'series_uids',   value: ''},
          {name: 'series_file',   value: ''},
          {name: 'data_location', value: ''},
          {name: 'previous',      value: ''}
        ];

        data.body.data = this.pacsSettings;
        data.body.data['series_uids'] = '0,1';
        data.body.data['previous']    = this.previous;

        var request = this.$.API.request( 'POST', this.instances, data);
        request
          .then( this.handleRetrieve.bind(this) )
          .catch( this.handleRetrieveError.bind(this) );

      },

      handleRetrieve: function( response ){

        console.log( 'retrieve returned' );
        console.log( response );

        this.fire('add-feed');

      },

      handleRetrieveError: function( response ){

        console.log( 'retrieve errored' );
        console.log( response );

      }
    });

  </script>

</dom-module>
</body></html>