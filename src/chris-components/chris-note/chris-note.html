<!--
@license
Copyright (c) 2016 FNNDSC. All rights reserved.
-->

<link rel="import" href="../../../bower_components/polymer/polymer.html">

<!-- IRON ELEMENTS -->
<link rel="import" href="../../../bower_components/iron-autogrow-textarea/iron-autogrow-textarea.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">

<!-- PAPER ELEMENTS -->
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">

<link rel="import" href="../../../bower_components/marked-element/marked-element.html">

<!-- CHRIS ELEMENTS -->
<link rel="import" href="../../chris-api/chris-api.html">

<dom-module id="chris-note">
  <template>
    <style>

      .toolbar {

        min-height: 48px;
        @apply(--layout-horizontal);
        @apply(--layout-end);
        @apply(--layout-wrap);

      }

      .name {

        font-size: 16px;
        font-weight: bold;
        color: var(--primary-text-color);

      }

      .spacer {

        @apply(--layout-flex);

      }

      paper-icon-button {

        border-bottom: 1px solid var(--accent-color);
        color: var(--secondary-text-color);

      }

      .content {

        padding: 20px;

      }

      #editor {

        display: none;
        width: inherit;

      }

      /* Markdown style */

      .markdown-html pre code {

        display: flex;
        padding: 10px;
        color: #ffffff;
        background-color: var(--paper-grey-800);

      }

      .markdown-html code {

        padding: 10px;
        background-color: var(--paper-grey-200);

      }

      .markdown-html blockquote p {

        background-color: var(--paper-grey-200);
        padding: 8px;

      }

      .markdown-html table {

        border-collapse: collapse;

      }
      
      .markdown-html table, .markdown-html th, .markdown-html td {

        border: 1px solid black;

      }

    </style>

    <chris-api id="ItemAPI"
      api="Item",
      content-type="application/json",
      response="{{response}}"
      on-response="handleItem"
      error="{{error}}"
      on-error="handleError">
    </chris-api>

    <div id="note" class="note">

      <!-- Toolbar -->

      <div class="toolbar">

      <div class="spacer"></div>

      <template is="dom-if" if="{{!editing}}" >
        <paper-icon-button icon="icons:create" on-tap="edit"></paper-icon-button>
      </template>
      <template is="dom-if" if="{{editing}}" >
        <paper-icon-button icon="icons:save" on-tap="save"></paper-icon-button>
        <paper-icon-button icon="icons:close" on-tap="close"></paper-icon-button>
      </template>

      </div>

      <!-- Content -->

      <div class="content">

        <iron-autogrow-textarea id="editor" value="{{note.data.0.data.content}}" on-input="_updateContent"></iron-autogrow-textarea>
        
        <marked-element id="md" markdown="[[note.data.0.data.content]]">
          <div class="markdown-html"></div>
        </marked-element>
      </div>

    </div>

  </template>

  <script>
    Polymer({
        is: 'chris-note',

        properties: {

          note: {
            type: Object
          },

          previousContent: {
            type: String
          },

          editing: {
            type: Boolean,
            value: false
          }

        },

        _stopEventPropagation: function( event ){

          event.stopPropagation();

        },

        edit: function( event ){

          this._stopEventPropagation( event );

          // start editing (will show related buttons)
          this.editing = true;
          // save current content
          this.previousContent = this.note.data[0].data.content;

          this.$.editor.style.display = 'block';

        },

        close: function( event ){

          this._stopEventPropagation( event );

          // stop editing
          this.editing = false;

          // restore previous content
          this.note.data[0].data.content = this.previousContent;
          this.$.editor.value = this.previousContent;
          this.$.md.markdown = this.previousContent;

          this.$.editor.style.display = 'none';

        },

        save: function( event ){

          this._stopEventPropagation( event );

          this.editing = false;

          this.$.editor.style.display = 'none';

          var note = this.note.data[0];
          note.template = this.note.template;
          note.href = this.note.href;

          this.$.ItemAPI.request( 'PUT', note.href, note);

        },

        handleItem: function( event ){

          // stop ajax propagation
          event.preventDefault();
          event.stopPropagation();

          // could/should show nice reload button
          if( !this.response ){

            return;

          }

          // if feed was not updated, fire notification message
          if( this.response.error && this.response.error.code ){

            // restore cache, not good solution
            // restore previous content
            this.note.data[0].data.content = this.previousContent;
            this.$.editor.value = this.previousContent;
            this.$.md.markdown = this.previousContent;

            // show toast message
            this.fire( 'notification', this.response.error );

          }

        },

        handleError: function(){

          console.log( this.error );

        },

        // binding not supported with arrays items ***.0.***
        _updateContent: function(){

          this.$.md.markdown = this.$.editor.value;

        }
    });
  </script>
</dom-module>
