<!--
@license
Copyright (c) 2016 FNNDSC. All rights reserved.
-->

<link rel="import" href="../../../bower_components/polymer/polymer.html">

<!-- IRON ELEMENTS -->
<link rel="import" href="../../../bower_components/iron-autogrow-textarea/iron-autogrow-textarea.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">

<!-- PAPER ELEMENTS -->
<link rel="import" href="../../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">

<link rel="import" href="../../../bower_components/marked-element/marked-element.html">

<!-- CHRIS ELEMENTS -->
<link rel="import" href="../../chris-api/chris-api.html">

<dom-module id="chris-note">
  <template>
    <style>

      .toolbar {

        min-height: 48px;
        @apply(--layout-horizontal);
        @apply(--layout-end);
        @apply(--layout-wrap);

        padding: 16px;
        font-size: 24px;
        font-weight: 400;
        color: #737373;

      }

      .name {

        font-size: 16px;
        font-weight: bold;
        color: var(--primary-text-color);

      }

      .spacer {

        @apply(--layout-flex);

      }

      paper-icon-button {

        border-bottom: 1px solid var(--accent-color);
        color: var(--secondary-text-color);

      }

      .content {

        /*padding: 20px;*/

      }

      #editor {

        display: none;
        width: inherit;

      }

      /* Markdown style */

      .markdown-html pre code {

        display: flex;
        padding: 10px;
        color: #ffffff;
        background-color: var(--paper-grey-800);

      }

      .markdown-html code {

        padding: 10px;
        background-color: #ffffff;
        color: var(--accent-color);
        font-weight: bold;

      }

      .markdown-html blockquote p {

        background-color: #ffffff;
        padding: 8px;

      }

      .markdown-html table {

        border-collapse: collapse;

      }

      .markdown-html table, .markdown-html th, .markdown-html td {

        border: 1px solid black;

      }

      paper-card {

          width: 800px;

        }

      @media (max-width: 800px) {

        paper-card {

          width: 100%;

        }

      }


      paper-card{

        color: var(--primary-text-color);
        --paper-card-header-color: var(--secondary-text-color);
        --paper-card-background-color: var(--paper-grey-100);
        background: var(--paper-grey-100);

      }

    </style>

    <chris-api id="API"
      api="Item",
      content-type="application/json",
      on-response="handleItem"
      error="{{error}}"
      on-error="handleError">
    </chris-api>

    <paper-card>

      <div class="toolbar">

        <div class="title" title>Note</div>

        <div class="spacer"></div>

        <template is="dom-if" if="{{!editing}}" >
          <paper-icon-button icon="icons:create" on-tap="edit"></paper-icon-button>
        </template>

        <template is="dom-if" if="{{editing}}" >
          <paper-icon-button icon="icons:save" on-tap="save"></paper-icon-button>
          <paper-icon-button icon="icons:close" on-tap="close"></paper-icon-button>
        </template>

        <a href="https://github.com/adam-p/markdown-here/wiki/Markdown-Here-Cheatsheet" target="_blank">
          <paper-icon-button icon="help-outline"></paper-icon-button>
        </a>

      </div>

      <div class="card-content">

        <div id="note" class="note">

          <!-- Content -->

          <div class="content">

            <iron-autogrow-textarea id="editor" value="{{notes.data.0.data.content}}" on-input="_updateContent"></iron-autogrow-textarea>

            <marked-element id="md" markdown="[[notes.data.0.data.content]]">
              <div class="markdown-html"></div>
            </marked-element>
          </div>

        </div>

      </div>

    </paper-card>

  </template>

  <script>
    Polymer({
        is: 'chris-note',

        properties: {

          notes: {
            type: Object,
            observer: '_notesChanged'
          },

          previousContent: {
            type: String
          },

          editing: {
            type: Boolean,
            value: false
          },

          error: {
            type: Object
          },

          valid: {
            type: Boolean
          }

        },

        _stopEventPropagation: function( event ){

          event.stopPropagation();

        },

        edit: function( event ){

          if( event ){

            this._stopEventPropagation( event );

          }

          // start editing (will show related buttons)
          this.editing = true;
          // save current content
          this.previousContent = this.notes.data[0].data.content;

          this.$.editor.style.display = 'block';

        },

        close: function( event ){

          this._stopEventPropagation( event );

          // stop editing
          this.editing = false;

          // restore previous content
          this.notes.data[0].data.content = this.previousContent;
          this.$.editor.value = this.previousContent;
          this.$.md.markdown = this.previousContent;

          this.$.editor.style.display = 'none';

        },

        save: function( event ){

          if( event ){

            this._stopEventPropagation( event );

          }

          this.editing = false;

          this.$.editor.style.display = 'none';

          var note = this.notes.data[0];
          note.template = this.notes.template;
          note.href = this.notes.href;
          var cache = [{ 'name': 'content', 'value': this.previousContent }]

          this.$.API.request( 'PUT', note.href, { body: note, cache: cache } );

        },

        handleItem: function( event ){

          // stop ajax propagation
          event.preventDefault();
          event.stopPropagation();

          // could/should show nice reload button
          if( !event.detail ){

            return;

          }

          var response = event.detail;

          // if feed was not updated, fire notification message
          if( response.error && response.error.code ){

            // restore previous content
            this.notes.data[0].data.content = response.cache[0].value;
            this.fire('notes-changed');

            this.$.editor.value = response.cache[0].value;
            this.$.md.markdown = response.cache[0].value;

            // show toast message
            this.fire( 'notification', response.error );

          }

        },

        handleError: function(){

          console.log( this.error );

        },

        // binding not supported with arrays items ***.0.***
        _updateContent: function(){

          this.$.md.markdown = this.$.editor.value;

        },

        isValid: function( notes ){

          if( !this.notes ){

            return;

          }

          var error = [];

          // Template is an <object>
          if( !( typeof this.notes.template === 'object' ) ){

            error.push( 'template:Object' );

          }

          // Href is a <string>
          if( !( typeof this.notes.href === 'string' ) ){

            error.push( 'href:String' );

          }

          // Data is an <array>
          if( !( this.notes.data && this.notes.data.constructor === Array ) ){

            error.push( 'data:Array' );

          }

          this.valid = ( error.length <= 0 );
          this.fire( 'valid-changed');

          if( !this.valid ){

            console.log( error );

            // fire error here because firefox complains if we do it before...?
            this.fire( 'error', error );

          }

          return this.valid;

        },

        _notesChanged: function( event ){

          if( !this.isValid( this.notes ) ){

            // if not valid

          }
          else{

            // if valid

          }

        }
    });
  </script>
</dom-module>
