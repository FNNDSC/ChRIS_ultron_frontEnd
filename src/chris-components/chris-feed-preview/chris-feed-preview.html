<link rel="import" href="../../../bower_components/polymer/polymer.html">

<!-- IRON ELEMENTS -->
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/iron-icons/social-icons.html">

<!-- PAPER ELEMENTS -->
<link rel="import" href="../../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../../bower_components/paper-item/paper-item.html"> 
<link rel="import" href="../../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../../bower_components/paper-menu/paper-menu.html"> 
<link rel="import" href="../../../bower_components/paper-menu-button/paper-menu-button.html"> 
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/paper-tooltip/paper-tooltip.html">

<link rel="import" href="../../../bower_components/moment-element/moment-element.html">

<dom-module id="chris-feed-preview">

  <template>
    <style>

      :host{
        
        display: block;

      }

      /* Feed style */

      .feed {

        display: flex;
        flex-direction: row;
        width:100%;

      }

      .feed:hover {

        @apply(--shadow-elevation-8dp);

      }

      .feed.checked {

        background-color: var(--paper-grey-200);

      }

      /* Selection area */
      .selection-area {

        width:48px;
        height: 48px;
        font-size: 18px;
        box-sizing: border-box;
        color: var(--primary-text-color);
        flex-direction: row;
        justify-content: center;
        align-items: center;
        display: flex;

      }

      .checked .selection-area {

        background-color: var(--paper-grey-700);

      }

      .selection-area paper-checkbox {

        display:none;
        --paper-checkbox-size: 18px;
        --paper-checkbox-label-spacing: 0px;
        --paper-checkbox-checked-color: var(--paper-grey-700);

      }

      .selection-area:hover paper-checkbox, .checked .selection-area paper-checkbox {

        display: block;

      }

      .selection-area:hover .letter, .checked .selection-area .letter {

        display: none;

      }

      /* Title area */
      .title-area {

        flex:1;
        box-sizing: border-box;
        color: var(--primary-text-color);
        flex-direction: row;
        justify-content: flex-start;
        align-items: center;
        display: flex;
        
      }

      .name {

        padding-left: 8px;
        font-size: 16px;
        white-space:nowrap;
        overflow:hidden;
        text-overflow:ellipsis;

      }

      .date {

        padding-left: 8px;
        font-size: 14px;
        color: var(--secondary-text-color);
        white-space:nowrap;
        overflow:hidden;
        text-overflow:ellipsis;

      }

      /* Action area */
     /* width vx flex 1 100%*/

      .feed:hover .actions-area {
        display:flex;
      }

      .actions-area {
        /*or not?*/
        position: absolute;
        top: 0;
        right: 0;
        display:none;
        background-color: var(--paper-grey-200);
        color: var(--primary-text-color);
        padding: 0 16px;
        box-sizing: border-box;
        text-align: right;
        flex-direction: row;
        justify-content: flex-end;
        align-items: center;

        }

        paper-icon-button, .checkbox{
          opacity: 0.5;
        }

        paper-icon-button:hover, .checkbox:hover{
          opacity: 1.0;
        }

        paper-menu-button {

          padding: 0;

        }

      @media (max-width: 896px) {
          .date {
            display: none;
          }
        } 


    </style>

    <paper-material id="feed" class="feed" elevation=1>

      <!-- Selection Area-->
      <div class="selection-area" on-tap="_blockEvents">
        <!-- circle with first letter of name-->
        <div class="letter">{{_firstLetter(feed.data.name)}}</div>
        <paper-checkbox on-tap="check" checked="{{checked}}"></paper-checkbox>

      </div>

      <!-- Title Area -->
      <div class="title-area" style$="{{_setBackgroundStyle(feed.data.color)}}">

        <div class="name">Feed [[feed.data.id]] - [[feed.data.name]]</div>
        <div class="date"> <moment-element datetime="[[feed.data.creation_date]]" from="now"></moment-element></div>

      </div>

      <!-- Actions Area -->
      <div class="actions-area" on-tap="_blockEvents">

        <paper-icon-button id="share" class="action" icon="social:share" on-tap="share"></paper-icon-button>
        <paper-icon-button id="favorite" class="action" icon$="[[_setFavoriteIcon(feed.data.favorite)]]" on-tap="favorite"></paper-icon-button>

        <!--<paper-menu-button vertical-align="top" horizontal-align="right">
          <paper-icon-button icon="icons:label-outline" class="dropdown-trigger"></paper-icon-button>

          <paper-menu class="dropdown-content">

            <template is="dom-repeat" items="[[_validateTags(feed.data.tags)]]">

              <paper-item class="tag" style$="{{_setTagStyle(item.color)}}">#<span>{{item.name}}</span></paper-item>

            </template>

          </paper-menu>
        </paper-menu-button>-->

      </div>

    </paper-material>

  </template>

  <script>
    Polymer({
        is: 'chris-feed-preview',
        properties: {

          feed: {
            type: Object,
            observer: '_validateFeed'
          },

          checked: {
            type: Boolean,
            value: false,
            observer: '_checkedChanged'
          },

          valid:{
            type: Boolean
          },

          error: {
            type: Array
          }

        },

        observers: [
          'updateFavorite(feed.data.favorite)'
        ],

        updateFavorite: function() {
         
        },

        _firstLetter: function( value ){

          return value.charAt(0);

        },

        check: function(){

          event.preventDefault();
          event.stopPropagation();

        },

        _checkedChanged: function(){

          // add/remove class
          // if( this.feed && this.feed.data ){

            this.checked ? this.$.feed.classList.add('checked') : this.$.feed.classList.remove('checked');

          // }

        },

        share: function( event ){

          event.preventDefault();
          event.stopPropagation();

          if( !this.valid ){

            return;

          }

          console.log( 'share feed' );

        },

        tag: function( event ){

          event.preventDefault();
          event.stopPropagation();

          if( !this.valid ){

            return;

          }

        },

        _setTagStyle: function( color ){

          return 'color: ' + color + ';';

        },

        _setBackgroundStyle: function( color ){

          return 'border-left: 2px solid ' + color + ';';

        },

        favorite: function( event ){

          event.preventDefault();
          event.stopPropagation();

          if( !this.valid ){

            return;

          }

          //console.log(this.feed.data.favorite);

          // update feed favorite
          var cache = [ { name: 'favorite', value: this.feed.data.favorite } ];
          this.set(['feed', 'data', 'favorite'], !this.feed.data.favorite);

          // fire save feed
          this.fire( 'save-feed', {feed: this.feed, cache: cache} );

        },

        _setFavoriteIcon: function( favorite ) {

          return favorite ? 'icons:favorite' : 'icons:favorite-border';

        },

        _validateFeed: function(){

          if( !this.feed || !this.feed.data ){

            return;

          }

          var error = [];

          // need id
          if( !( typeof this.feed.data.id === 'string' ) ){

            error.push( 'id:String' );

          }

          // need name
          if( !( typeof this.feed.data.name === 'string' ) ){

            error.push( 'name:String' );

          }

          // need letter
          if( !( typeof this.feed.data.letter === 'string' ) ){

            error.push( 'letter:String' );

          }

          // need color
          if( !( typeof this.feed.data.color === 'string' ) ){

            error.push( 'color:String' );

          }

          // need date
          if( !( typeof this.feed.data.date === 'string' ) ){

            error.push( 'date:String' );

          }

          // need status
          if( !( typeof this.feed.data.status === 'string' ) ){

            error.push( 'status:String' );

          }

          // need favorite
          if( !( typeof this.feed.data.favorite === 'boolean' ) ){

            error.push( 'favorite:Boolean' );

          }

          // need checked
          // if( !( typeof this.feed.data.checked === 'boolean' ) ){

          //   error.push( 'checked:Boolean' );

          // }

          // need tags array
          if( !( this.feed.data.tags && this.feed.data.tags.constructor === Array ) ){

            // should we "fix" it or hide the feed and show error
            // just show error "feed"
            // if invalid: red and can not do anything
            error.push( 'tags:Array' );

          }

          if( error.length > 0){

            // got an error
            this.error = error;
            this.fire( 'error-changed' );
            // triggers error on Firefox for some reason...
            // this.fire( 'error' );

            // make it invalid
            this.valid = false;
            this.fire( 'valid-changed' );

            // fire error here because firefox complains if we do it before...?
            this.fire( 'error' );

            return;

          }

          this.valid = true;
          this.fire( 'valid-changed');

        },

        _validateTags: function( tags ){

          if( !( tags && tags.constructor === Array ) ){

            return [];

          }

          return tags;

        },

        _blockEvents: function( event ){

          event.preventDefault();
          event.stopPropagation();

        }

    });
  </script>
</dom-module>
