<!--
@license
Copyright (c) 2016 FNNDSC. All rights reserved.
-->

<!-- POLYMER -->
<link rel="import" href="../../../bower_components/polymer/polymer.html">

<!-- IRON ELEMENTS -->
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">

<!-- PAPER ELEMENTS-->
<link rel="import" href="../../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">

<!-- CHRIS -->
<link rel="import" href="../../chris-api/chris-api.html">
<link rel="import" href="../chris-comment/chris-comment.html">

<dom-module id="chris-comment-list">
  <template>
    <style>

    .toolbar {

        min-height: 48px;
        @apply(--layout-horizontal);
        @apply(--layout-end);
        @apply(--layout-wrap);
        border-bottom: 1px solid var(--accent-color);

      }

      .name {

        font-size: 16px;
        font-weight: bold;
        color: var(--primary-text-color);

      }

      .spacer {

        @apply(--layout-flex);

      }

      paper-icon-button {

        color: var(--secondary-text-color);

      }

      .content {

        /*padding: 20px;*/

      }

          paper-card {
        width: 800px;
      }

    @media (max-width: 800px) {
      paper-card {
        width: 100%;
      }
    }


    paper-card{
      color: var(--primary-text-color);
      --paper-card-header-color: var(--secondary-text-color);
      --paper-card-background-color: var(--paper-grey-100);
      background: var(--paper-grey-100);
    }

    </style>

            <paper-card heading="Discussion">
      <div class="card-content">

    <chris-api id="ItemAPI"
      api="Item",
      content-type="application/json",
      response="{{response}}"
      on-response="handleItem"
      error="{{error}}"
      on-error="handleError">
    </chris-api>

    <div id="commentList" class="comment-list">

      <div id="content" class="content">

        <!-- First comment -->


        <!-- Middle comments -->
        <template is="dom-repeat" items="[[comments.data]]">

          <chris-comment comment="[[item]]"></chris-comment>

        </template>

        <!-- Last comment -->

        <paper-input id="comment" label="Add a comment" on-keydown="save" char-counter maxlength="120">
          <paper-icon-button suffix icon="icons:clear" on-tap="clear"></paper-icon-button>
        </paper-input>

      </div>

    </div>
    </div>
    </paper-card>

  </template>

  <script>
    Polymer({
        is: 'chris-comment-list',

        properties: {

          comments: {
            type: Object
          }

        },

        clear: function(){

          this.$.comment.value = '';

        },

        save: function ( evt ) {
          
          // save comment only if
          // - "enter" was pressed
          // - comment not empty
          if( evt.keyCode === 13 ) {

            // we need to stop propagation if not the feed willl be closed bi iron-list
            evt.stopPropagation();
            evt.preventDefault();

            if( this.$.comment.value !== '' ){

              // create from template then POST!
              var options = {
                weekday: "long", year: "numeric", month: "short",
                day: "numeric", hour: "2-digit", minute: "2-digit"
              };

              var comment = {};
              comment.data = {
                author: "Nicolas Rannou",
                color: "blue",
                content: this.$.comment.value,
                index: this.comments.length + 1,
                date: new Date().toLocaleTimeString("en-us", options)
              }

              comment.template = this.comments.template;
              comment.href = this.comments.href;

              // cache this guy... how?
              this.push( 'comments.data', comment );

              this.clear();

              this.$.ItemAPI.request( 'POST', this.comments.href, { body: comment } );

            }

          }

        },

        handleItem: function( event ){

          // stop ajax propagation
          event.preventDefault();
          event.stopPropagation();

          // could/should show nice reload button
          if( !event.detail ){

            return;

          }

          var response = event.detail;

          // if feed was not updated, fire notification message
          if( response.error && response.error.code ){

            // find index where all data matches

            // console.log( this.comments.data.indexOf( response.cache ) );

            // restore cache
            // pop not good  if we write 2 comments before first response returns
            this.pop('comments.data');

            // show toast message
            this.fire( 'notification', response.error );

          }

        },

        handleError: function(){

        }

    });
  </script>
</dom-module>
