<!--
@license
Copyright (c) 2016 FNNDSC. All rights reserved.
-->

<link rel="import" href="../../../bower_components/polymer/polymer.html">

<!-- APP ELEMENTS -->
<link rel="import" href="../../../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../../../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../../../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../../../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../../../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../../../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../../../bower_components/app-route/app-location.html">

<!-- PAPER ELEMENTS -->
<link rel="import" href="../../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../../bower_components/paper-tooltip/paper-tooltip.html">

<!-- IRON ELEMENTS -->
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">

<!-- EXTERNAL ELEMENTS -->
<link rel="import" href="../../../bower_components/paper-fab-transitions/paper-fab-speed-dial.html">

<!-- CHRIS ELEMENTS -->
<link rel="import" href="../../chris-api/chris-api.html">
<link rel="import" href="../../chris-components/chris-feed-list/chris-feed-list.html">
<link rel="import" href="../../chris-components/chris-label-list/chris-label-list.html">

<dom-module id="chris-home">

  <template>

    <style include="iron-flex iron-flex-alignment">
    <style>

      :host {

        display: block;

      }

      app-header {

        background-color: var(--dark-primary-color);
        color: #ffffff;

      }

      app-header paper-icon-button {

        --paper-icon-button-ink-color: #ffffff;

      }

      .drawer.content {

        height: 100%;
        overflow: auto;

      }

      app-header-layout {

        background-color: var(--paper-grey-100);
        /*min-height: 201vh;*/

      }

      paper-progress {

        width: 100%;
        --paper-progress-active-color: var(--accent-color);
        --paper-progress-height: 2px;

      }

      .loaded paper-progress {

        display: none;

      }

      paper-fab-speed-dial{

        z-index:10;
        position: fixed;
        bottom: 16px;
        right: 16px;

      }

      paper-fab#create {
        --paper-fab-background: var(--accent-color);
      }

      /*on small screens, make toast full width
 class="fit-bottom"
      */

    </style>

    <div id="home">

      <!-- Route -->
      <app-location route="{{route}}"></app-location>

      <!-- API Calls -->
      <chris-api id="FeedsAPI" error="{{error}}"></chris-api>

      <app-drawer-layout fullbleed>

        <!-- Drawer content -->
        <app-drawer>

          <div class="drawer content">

            <app-toolbar>Menu</app-toolbar>
            <chris-label-list custom-labels="{{labels}}"></chris-label-list>

          </div>

        </app-drawer>

        <!-- Main content -->
        <app-header-layout has-scrolling-region id="layout">

          <app-header id="header" fixed effects="waterfall">
            <app-toolbar>
              <paper-icon-button icon="menu" drawer-toggle></paper-icon-button>
              <div main-title>ChRIS 3.0 - Ultr√∏n</div>
              <paper-icon-button icon="icons:exit-to-app" on-tap="_logout"></paper-icon-button>
            </app-toolbar>
          </app-header>

          <div id="content" class="main content">

            <paper-progress indeterminate></paper-progress>

            <paper-fab-speed-dial direction="top">
              <paper-fab id="create" icon="add" class="dropdown-trigger"></paper-fab>
              <div class="dropdown-content">
                <template is="dom-repeat" items="{{apps}}">
                  <paper-fab mini id="[[item.name]]" icon="[[item.icon]]" item="[[item]]" style$="[[_setAppStyle(item.color)]]" on-tap="_openApp"></paper-fab>
                  <paper-tooltip for="[[item.name]]" position="left" animation-delay="0">[[item.label]]</paper-tooltip>
                </template>
              </div>
            </paper-fab-speed-dial>

            <chris-feed-list id="feedList" feeds="[[feeds]]" on-notification="_showNotification" scroll-target="[[_getScrollTarget()]]" feed-opened={{feedOpened}}></chris-feed-list>

            <paper-toast id="notification" text="This toast auto-closes after 3 seconds"></paper-toast>

          </div>

        </app-header-layout>

      </app-drawer-layout>

    </div>

  </template>

  <script>
    Polymer({
      is: 'chris-home',
      properties: {

        feeds: {
          type: Array
        },

        feed:{
          type: Object,
          observer: '_feedChanged'
        },

        feedOpened: {
          type: Object,
          notify: true
        },

        apps:{
          type: Array
        },

        app: {
          type: Object,
          notify: true
        },

        labels:{
          type: Array
        },

        error: {
          type: Object
        }

      },

      ready: function( event ){

        // logged in
        // prepare parameters for API call
        var data = {};
        data.auth = {
          type: 'token',
          token: sessionStorage.getItem('token')
        };

        // fetch the feeds
        // color/icons/etc are BE or FE params?
        // in the plugin args could be
        var request =this.$.FeedsAPI.request('GET', 'feeds', data);
        request
          .then( this.handleFeeds.bind(this) )
          .catch( this.handleError.bind(this) );

        // fetch the labels
        // var request2 = this.$.FeedsAPI.request('GET', '/labels');
        // request2
        //   .then( this.handleLabels.bind(this) )
        //   .catch( this.handleError.bind(this) );

        // set the apps
        // pacsquery
        // viewer
        // file browser
        var pacs_pull = {
          'name': 'pacs-pull',
          'color': '#000044',
          'icon': 'icons:account-box',
          'label': 'Pacs Pull'
        };

        var viewer = {
          'name': 'viewer',
          'color': '#123456',
          'icon': 'icons:tab',
          'label': 'Image Viewer'
        };

        this.set( 'apps', [pacs_pull, viewer] );

        // anchor toast to the chris-feed-list
        this.$.notification.fitInto = this.$.layout;

      },

      handleFeeds: function( response ){

        this.set( 'feeds', response );

        this.showError( response.error );

        this.$.content.classList.add( 'loaded' );

      },

      handleLabels: function( response ){

        this.set( 'labels', response );

        this.showError( response.error );

        this.$.content.classList.add('loaded');

      },

      showError: function( error ){

        // if feed was not updated, fire notification message
        if( error && error.code ){

          var notification = document.createElement('paper-toast');
          notification.text = error.message;
          notification.fitInto = this.$.layout;
          this.$.content.appendChild(notification);
          notification.show();

          //this._showNotification( { detail: error });

        }

      },

      handleError: function( response ){

        console.error( response );

      },

      _showNotification: function( event ){

        // update text
        this.$.notification.text = event.detail.message;

        // show notification
        this.$.notification.show();

      },

      _getScrollTarget: function() {

        return this.$.header.scrollTarget;

      },

      _setAppStyle: function( color ){

          return 'background-color: ' + color + ';';

        },

      _openApp: function( event ){

        // set the plugin FS
        if( event ){

          console.log( event.model.__data__.item );

          this.set( 'app', event.model.__data__.item );

          // update route
          this.set('route.path', '/app/' + event.model.__data__.item.name);

        }

      },

      _feedChanged: function(){

        // get the shell of the feed
        this.feed.id = this.feed.details.id = ( this.feeds.length + 1 ).toString();
        this.unshift( 'feeds', this.feed );

      },

      _logout: function(){

        // update session
        sessionStorage.removeItem('username');
        sessionStorage.removeItem('token');

        this.set('route.path', '/login');

      }

    });
  </script>
</dom-module>
