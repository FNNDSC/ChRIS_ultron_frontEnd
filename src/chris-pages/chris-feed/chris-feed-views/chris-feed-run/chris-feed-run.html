<!--
@license
Copyright (c) 2016 FNNDSC. All rights reserved.
-->

<!-- POLYMER -->
<link rel="import" href="../../../../../bower_components/polymer/polymer.html">


<!-- PAPER ELEMENTS-->
<link rel="import" href="../../../../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../../../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../../../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../../../../bower_components/paper-item/paper-item.html">

<!-- CHRIS ELEMENTS -->
<link rel="import" href="../../../../chris-api/chris-api.html">
<link rel="import" href="../../../../chris-components/chris-parameter/chris-parameter.html">
<link rel="import" href="../../../../chris-behaviors/plugin-behavior/plugin-behavior.html">

<dom-module id="chris-feed-run">
  <template>
    <style>

      :host {
        width: 100%;
        margin:6px;
      }

      .content {
        background-color: var(--paper-grey-50);
        @apply --layout-vertical;
        @apply --layout-wrap;
        padding: 24px;
      }


    paper-card{

      color: var(--primary-text-color);
      --paper-card-header-color: var(--secondary-text-color);
      --paper-card-background-color: var(--paper-grey-100);
      background: var(--paper-grey-100);

    }

      paper-card {
    --paper-card: {
      width: 100%;
    };
  }

    .submit {

        padding: 16px;
        font-size: 18px;
        font-weight: 400;
        background-color: var(--accent-color);
        color: #ffffff;
        margin-top: 24px;

      }

    </style>

    <!-- API Calls -->
    <chris-api id="API"
      error="{{error}}">
    </chris-api>

    <paper-card class="content" heading="Run plugin">

      <div class="card-content">

        <paper-dropdown-menu id="dropdown" label="Plugin to run">

          <paper-listbox class="dropdown-content" selected={{selectedMenu}}>

            <template is="dom-repeat" items="{{plugins}}">
              <template is="dom-if" if="{{_isDSPlugin(item.data.type)}}">
                <paper-item plugin="[[item]]" on-tap="_pluginSelected">{{item.data.name}} - {{item.data.type}}</paper-item>
              </template>
            </template>

          </paper-listbox>

        </paper-dropdown-menu>


        <div>Parameters</div>
        <template is="dom-repeat" items="{{parameters.data}}">
          <!--chris parameter -->
          <chris-parameter
            parameter="{{item}}"
            optional="{{item.data.optional}}"
            name="{{item.data.name}}"
            type="{{item.data.type}}"
            help="{{item.data.help}}"
            default="{{item.data.default}}"
            on-change-value="_changeValue"
            ></chris-parameter>
        </template>

      </div>

      <paper-button class="submit" raised on-tap="_start">Start plugin</paper-button>

    </paper-card>

  </template>

  <script>
    Polymer({
        is: 'chris-feed-run',

        behaviors: [PluginBehavior],

        properties: {

          plugins: {
            type: Array,
          },

          plugin: {
            type: Object,
            observer: '_pluginChanged',
          },

          selectedPlugin: {
            type: Object,
            observer: '_selectedPluginChanged',
          },

          parameters: {
            type: Array,
            observer: '_parametersChanged',
          }

        },

        _pluginChanged: function(event) {
          console.log(this.plugin);
        },

        _selectedPluginChanged: function() {
          if(this.selectedPlugin === null) {
            return;
          }

          this._fetchParameters();
        },

        _parametersChanged: function() {
          console.log(this.parameters);
        },

        _fetchParameters: function() {
          if(this.selectedPlugin === null) {
            return;
          }

          var data = {};
          data.auth = {
            type: 'token',
            token: sessionStorage.getItem('token'),
          };

          var request =this.$.API.request('GET', this.selectedPlugin.links.parameters, data);
          request
            .then(this._handleParameters.bind(this));
        },

        _handleParameters: function(parameters) {
          this.set('parameters', parameters);
          this._resetParameters();
        },

        _resetParameters: function() {
          for(var i=0; i < this.parameters.data.length; i++) {
            this.parameters.data[i].data.value = this.parameters.data[i].data.default;
          }
        },

        _pluginSelected: function( event ){

          this.selectedPlugin = event.currentTarget.plugin;

        },

        _changeValue: function( event ){

          console.log( event );
          event.currentTarget.parameter.data.value = event.detail;

        },

        _start: function() {
          var data = {};
          data.auth = {
            type: 'token',
            token: sessionStorage.getItem('token'),
          };

          data.body = {};
          data.body.template = {};
          data.body.template.data = [];
          data.body.template.data.push({
            name: 'previous_id',
            value: '',
          })
          data.body.data = {
            previous_id: this.plugin.data.id
          }

          for(var i=0; i<this.parameters.data.length; i++) {
            var name = this.parameters.data[i].data.name;
            var value = this.parameters.data[i].data.value;

            // fill template
            var parameter = {
              name: name,
              value: '',
            }
            data.body.template.data.push(parameter);

            // fill data
            data.body.data[ name ] = value;
          }

          var start = this.__startPlugin(this.$.API, this.selectedPlugin, data);
          start
            .then(this.handleRunPluginDS.bind(this))
            .catch(this.handleRunError.bind(this));
        },

        handleRunPluginDS: function(event) {

          console.log(event);

          this.fire('fetch-plugin', event.data[0]);

          this.set( 'selectedPlugin', null) ;
          this.set( 'parameters', []) ;
          this.selectedMenu = null;

        },

        handleRunError: function( event ){

          console.log( event );

        },

        _isDSPlugin: function(type) {
          return type === 'ds';
        }

    });
  </script>
</dom-module>
