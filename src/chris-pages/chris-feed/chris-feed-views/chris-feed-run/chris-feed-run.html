<!--
@license
Copyright (c) 2016 FNNDSC. All rights reserved.
-->

<!-- POLYMER -->
<link rel="import" href="../../../../../bower_components/polymer/polymer.html">


<!-- PAPER ELEMENTS-->
<link rel="import" href="../../../../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../../../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../../../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../../../../bower_components/paper-item/paper-item.html">

<!-- CHRIS ELEMENTS -->
<link rel="import" href="../../../../chris-api/chris-api.html">
<link rel="import" href="../../../../chris-components/chris-parameter/chris-parameter.html">

<dom-module id="chris-feed-run">
  <template>
    <style>

      .content {

        background-color: var(--paper-grey-50);
        @apply --layout-vertical;
        @apply --layout-wrap;
        padding: 24px;
        max-width: 800px;
        margin: auto;
        margin-top: 24px;
        margin-bottom: 100px;

      }


    paper-card{

      color: var(--primary-text-color);
      --paper-card-header-color: var(--secondary-text-color);
      --paper-card-background-color: var(--paper-grey-100);
      background: var(--paper-grey-100);

    }

    .submit {

        padding: 16px;
        font-size: 18px;
        font-weight: 400;
        background-color: var(--accent-color);
        color: #ffffff;
        margin-top: 24px;

      }

    </style>

    <!-- API Calls -->
    <chris-api id="ChrisAPI"
      error="{{error}}">
    </chris-api>

    <paper-card class="content" heading="Run plugin">

      <div class="card-content">

        <paper-dropdown-menu label="Plugin to run">

          <paper-listbox class="dropdown-content">

            <template is="dom-repeat" items="{{plugins}}">
              <paper-item plugin="[[item]]" on-tap="_pluginSelected">{{item.data.name}} </paper-item>
            </template>

          </paper-listbox>

        </paper-dropdown-menu>


        <div>Parameters</div>
        <template is="dom-repeat" items="{{parameters.data}}">
          <!--chris parameter -->
          <chris-parameter
            name="{{item.data.name}}"
            type="{{item.data.type}}"
            help="{{item.data.help}}"
            default="{{item.data.default}}"
            ></chris-parameter>
        </template>

      </div>

      <paper-button class="submit" raised on-tap="_start">Start plugin</paper-button>

    </paper-card>

  </template>

  <script>
    Polymer({
        is: 'chris-feed-run',

        properties: {

          plugin: {
            type: Object,
            observer: '_pluginChanged'
          },

          selectedPlugin: {
            type: Object,
            observer: '_selectedPluginChanged'
          },

          parameters: {
            type: Array,
            observer: '_parametersChanged'
          }

        },

        _pluginChanged: function( event ){

          console.log( this.plugin );

        },

        _selectedPluginChanged: function(){

          this._fetchParameters();

        },

        _parametersChanged: function(){

          console.log( this.parameters );

        },

        _fetchParameters: function(){

          var data = {};
          data.auth = {
            type: 'token',
            token: sessionStorage.getItem('token')
          };

          var request =this.$.ChrisAPI.request('GET', this.selectedPlugin.links.parameters, data);
          request
            .then( this._handleParameters.bind(this) );

        },

        _handleParameters: function( parameters ){

          this.set('parameters', parameters);

        },

        _pluginSelected: function( event ){

          this.selectedPlugin = event.currentTarget.plugin;

        },

        _start: function(){

          console.log( 'start plugin' );
          var data = {};
          data.auth = {
            type: 'token',
            token: sessionStorage.getItem('token')
          };

          console.log( this.plugin );
          console.log( this.selectedPlugin );

          //
          data.body = {};
          data.body.template = {};
          data.body.template.data = [
            {name: 'aet',           value: ''},
            {name: 'aec',           value: ''},
            {name: 'aet_listener',  value: ''},
            {name: 'server_ip',     value: ''},
            {name: 'server_port',   value: ''},
            {name: 'series_uids',   value: ''},
            {name: 'series_file',   value: ''},
            {name: 'data_location', value: ''},
            {name: 'previous',      value: ''}
          ];

          //data.body.data['previous'] = this.plugin.data.id;

          // var request = this.$.ChrisAPI.request( 'POST', this.selectedPlugin.instances, data);
          // request
          //   .then( this.handleRetrieve.bind(this) )
          //   .catch( this.handleRetrieveError.bind(this) );

        }

    });
  </script>
</dom-module>
