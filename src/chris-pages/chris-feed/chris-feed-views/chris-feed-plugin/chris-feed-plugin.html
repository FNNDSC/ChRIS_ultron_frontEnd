<html><head><meta charset="UTF-8"><link rel="import" href="../../../../chris-ultron.html"></head><body><div hidden="" by-vulcanize=""><script>var THREE=THREE||{};</script><script src="https://cdn.rawgit.com/mrdoob/three.js/master/examples/js/loaders/STLLoader.js"></script></div><dom-module id="chris-feed-plugin">
  <template>
    <style>
      :host {
        --app-primary-color: #424242;
        --app-light-primary-color: #eeeeee;

        --app-secondary-color: #212121;

        --app-third-color: #757575;

        --app-accent-color: #03a9f4;
        --app-light-accent-color: #b3e5fc;
        --app-dark-accent-color: #01579b;

        --paper-tab-ink: var(--app-accent-color);
        --paper-tabs-selection-bar-color: var(--app-accent-color);

        --paper-slider-knob-color: var(--app-accent-color);
        --paper-slider-pin-color: var(--app-accent-color);
        --paper-slider-active-color: var(--app-accent-color);

        --paper-fab-background: var(--app-accent-color);
        --paper-fab-keyboard-focus-background: var(--app-dark-accent-color);

        --paper-input-container-focus-color: var(--app-dark-accent-color);

        display: flex;
        flex-direction: column;

        background-color: #eeeeee;

        position: absolute;
        top:0;
        left:0;
        right:0;
        bottom:0;

      }

      paper-range-slider {
        --paper-range-slider-knob-color: var(--app-accent-color);
        --paper-range-slider-active-color: var(--app-accent-color);
        --paper-range-slider-pin-color: var(--app-accent-color);
      }

      .paper-range-slider {
        display: flex;
      }

      .paper-range-slider paper-input{
        width: 50px;
        overflow: hidden;
      }

      app-toolbar {
        color: #fff;
        background-color: var(--app-primary-color);
      }

      .content {
        flex: 1;

        display: flex;
        flex-direction: row;
      }

      .controls {
        min-width: 400px;
        max-width: 400px;
        height:100%;

        display: flex;
        flex-direction: column;

        background-color: var(--app--light-primary-color);
      }

      .renderers {
        width: 100%;
        display: flex;
        flex-wrap: wrap;

        background-color: #353535;
      }

      .renderers > div {
        box-sizing:border-box;
        border: 1px solid rgba(0, 0, 0, .2);
        position: relative;
        overflow: hidden;
      }

      div.v1 {
        border-top: 1px solid #ffeb3b;
      }

      .big {
        height: 70%;
        width:100%;
      }

      div.v2 {
        border-top: 1px solid #f44336;
      }

      div.v3 {
        border-top: 1px solid #4caf50;
      }

      div.v4 {
        border-top: 1px solid #2196f3;
      }

      .small {
        height: 30%;
        flex: 1;
        position: relative;
      }

      paper-slider {
        width: 100%;
        position: absolute;
        bottom: 0px;
      }
    </style>

    <div class="content">

      <module-manager id="manager" class="controls">
        <module-filebrowser id="module-fileBrowser" class="module" label="data" list="[[list]]" files="[[files]]" on-load-data="_loadData"></module-filebrowser>
        <module-scene id="module-scene" class="module" label="scene" scene="[[scene]]" on-state-changed="_stateChanged"></module-scene>
        <module-editor id="module-editor" class="module" label="editor"></module-editor>
      </module-manager>

      <div class="renderers">
        <ami-3d id="r3d" class="v1 big"></ami-3d>
        <div class="v2 small">
          <paper-slider value="21" pin=""></paper-slider>
        </div>
        <div class="v3 small">
          <paper-slider value="21" pin=""></paper-slider>
        </div>
        <div class="v4 small">
          <paper-slider value="21" pin=""></paper-slider>
        </div>
      </div>

    </div>

  </template>

  <script>Polymer({is:"chris-feed-plugin",properties:{list:{type:Array,observer:"_listChanged"},files:{type:Array,value:[{data:{fname:"dicom/adi_brain/36444280"}},{data:{fname:"dicom/adi_brain/36444294"}},{data:{fname:"dicom/adi_brain/36444308"}},{data:{fname:"dicom/adi_brain/36444322"}},{data:{fname:"dicom/adi_brain/36444336"}},{data:{fname:"nifti/eun_brain/eun_uchar_8.nii.gz"}},{data:{fname:"stl/adi_brain/WM.stl"}},{data:{fname:"options.json"}}]},sceneMap:{type:Object,value:new Map},scene:{type:Array,value:[],observer:"_sceneChanged"},objectsMap:{type:Object,value:new Map}},observers:["_sceneChanged(scene.*)"],_listChanged:function(){console.log(this.list)},_loadData:function(e){var t=e.detail.data,i=this.analyze(t);if(null!==i.type&&!this.sceneMap.has(t.id))if(this.sceneMap.set(t.id,i),this.$.manager.selected=1,this.push("scene",i),"volume"===i.type){var a=AMI.default.Loaders.Volume,n=new a,s=i.files.map(function(e){return"https://cdn.rawgit.com/FNNDSC/data/master/"+e});n.load(s).then(function(){var e=n.data[0].mergeSeries(n.data),i=e[0].stack[0];i.prepare();var a=this.sceneMap.get(t.id);this.updateVolumeObject(a,i);var s=this.scene.map(function(e){return e.id}).indexOf(t.id);this.set(["scene",s,"ready"],a.ready),this.$["module-scene"].selected=s;var l=AMI.default.Helpers.Stack,d=new l(i);d.bbox.color=9159498,d.border.color=16007990,this._updateState(t,d,a.state),this.$.r3d.add(d),this.objectsMap.set(t.id,d)}.bind(this))}else if("mesh"===i.type){var s=i.files.map(function(e){return"https://cdn.rawgit.com/FNNDSC/data/master/"+e}),l=new THREE.STLLoader;l.load(s[0],function(e){var i=new THREE.MeshPhongMaterial({color:16007990,specular:1118481,shininess:100,transparent:!0,opacity:1}),a=new THREE.Mesh(e,i),n=new THREE.Matrix4;n.set(-1,0,0,0,0,-1,0,0,0,0,1,0,0,0,0,1),a.applyMatrix(n);var s=this.sceneMap.get(t.id);this.updateMeshObject(s,e,i);var l=this.scene.map(function(e){return e.id}).indexOf(t.id);this.set(["scene",l,"ready"],s.ready),this.$["module-scene"].selected=l,this._updateState(t,a,s.state),this.$.r3d.add(a),this.objectsMap.set(t.id,a)}.bind(this))}},_stateChanged:function(e){var t=this.objectsMap.get(e.detail.id),i=this.sceneMap.get(e.detail.id);this._updateState(i,t,e.detail.state)},_updateState:function(e,t,i){t.visible=i.visible,"volume"===e.type?(t.slice.windowCenter=i.windowLevel[0],t.slice.windowWidth=i.windowLevel[1],t.slice.interpolation=i.interpolation?1:0):"mesh"===e.type&&(t.material.opacity=i.opacity,t.material.color.set(i.color),t.material.shininess=i.shininess)},_sceneChanged:function(){},updateVolumeObject:function(e,t){e.info={minMax:t.minMax,size:[t.columns,t.rows],images:t.frame.length,seriesNumber:null,thickness:t.sliceThickness,patientID:null,patientBirthdate:null,patientAge:null,studyDescription:null,seriesDescription:null,stationName:null,modality:t.modality,sequenceName:null,studyDate:null,seriesDate:null,acquisitionDate:null,acquisitionTime:null},e.state={visible:!0,interpolation:!0,windowLevel:[t.windowCenter,t.windowWidth],threshold:null,lut:"B/W"},e.ready=!0},updateMeshObject:function(e,t,i){e.info={},e.state={visible:!0,color:"#"+i.color.getHexString(),opacity:i.opacity,shininess:i.shininess},e.ready=!0},analyze:function(e){var t={id:e.id,files:[],type:null,ready:!1};if(e.children.length<=0)t.files.push(e.id);else for(var i=0;i<e.children.length;i++)e.children[i].children.length<=0&&t.files.push(e.children[i].id);return t.files.length>0&&(t.files[0].includes(".stl")?t.type="mesh":t.type="volume"),t},clickInput:function(e){this.$.filesinput.click()},localFS_load:function(e){for(var t=[],i=0;i<e.target.files.length;i++)t.push(e.target.files[i]);this.files=t,console.log(this.files)}});</script>
</dom-module></body></html>