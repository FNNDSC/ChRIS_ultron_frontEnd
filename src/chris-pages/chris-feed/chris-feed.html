<link rel="import" href="../../../bower_components/polymer/polymer.html">

<!-- APP ELEMENTS -->
<link rel="import" href="../../../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../../../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../../../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../../../bower_components/app-layout/app-toolbar/app-toolbar.html">

<!-- PAPER ELEMENTS -->
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">

<!-- IRON ELEMENTS -->
<link rel="import" href="../../../bower_components/iron-dropdown/iron-dropdown.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/iron-icons/communication-icons.html">
<link rel="import" href="../../../bower_components/iron-icons/editor-icons.html">
<link rel="import" href="../../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../../bower_components/iron-selector/iron-selector.html">

<!-- CHRIS FEED VIEWS -->
<link rel="import" href="../../chris-pages/chris-feed/chris-feed-views/chris-feed-about/chris-feed-about.html">
<link rel="import" href="../../chris-pages/chris-feed/chris-feed-views/chris-feed-comments/chris-feed-comments.html">
<link rel="import" href="../../chris-pages/chris-feed/chris-feed-views/chris-feed-note/chris-feed-note.html">
<link rel="import" href="../../chris-pages/chris-feed/chris-feed-views/chris-feed-plugin/chris-feed-plugin.html">
<link rel="import" href="../../chris-pages/chris-feed/chris-feed-views/chris-feed-run/chris-feed-run.html">

<!-- CHRIS ELEMENTS -->
<link rel="import" href="../../chris-api/chris-api.html">
<link rel="import" href="../../chris-components/chris-plugin-tree/chris-plugin-tree.html">

<dom-module id="chris-feed">

  <template>

    <style include="iron-flex iron-flex-alignment">

      :host {

        display: block;

      }

      app-header {

        background-color: var(--dark-primary-color);
        color: #ffffff;

      }

      app-header paper-icon-button {

        --paper-icon-button-ink-color: #ffffff;

      }

      .content {

        flex: 1;
        display: flex;
        flex-direction: column;

      }

      app-header-layout {

        background-color: var(--paper-grey-100);
        /*min-height: 201vh;*/

      }

      app-header-layout app-toolbar {

        color: #ffffff;

      }

      paper-progress {

        width: 100%;
        --paper-progress-active-color: var(--accent-color);
        --paper-progress-height: 2px;

      }

      .loaded paper-progress {

        display: none;

      }

      a {

        color: #ffffff;

      }

      div[main-title] {

        text-align: center;
      
     }

      .dropdown-content{
        margin-top: 64px;
        background-color: rgba(255, 255, 255, .8);
      }

      @media (max-width: 896px) {

        /*iron-dropdown, .dropdown-content{

          max-width: 100%!important;
          width: 100%!important;

        }*/

      } 

    </style>

    <!-- API Calls -->
    <chris-api id="API"
      error="{{error}}">
    </chris-api>

    <div id="detail">

        <!-- Main content -->
        <app-header-layout id="adl" has-scrolling-region style$="[[_setLayoutStyle(feed.data.color)]]" fullbleed>

          <app-header id="header" fixed effects="waterfall" style$="[[_setToolbarStyle(feed.data.color)]]">
            <app-toolbar>
              <paper-icon-button icon="icons:arrow-back" on-tap="_exit"></paper-icon-button>

              <div main-title>[[feed.data.name]]</div>

              <!--<span>
                <paper-icon-button icon="icons:apps" on-tap="_openTree"></paper-icon-button>
                <iron-dropdown id="dropdown" horizontal-align="right" vertical-align="top" on-tap="_closeDropdown">
                    <div class="plugin dropdown-content" on-select-node="_selectPlugin">
                      <chris-plugin-tree list="[[pluginInstanceCollection]]" selected="[[plugin]]"></chris-plugin-tree>
                    </div>
                </iron-dropdown>
              </span>-->

              <!--<iron-selector attr-for-selected="name" selected="{{page}}">
                <paper-icon-button name="note" icon="editor:mode-edit" on-tap="_deselectPlugin"></paper-icon-button>
                <paper-icon-button name="comments" icon="communication:forum" on-tap="_deselectPlugin"></paper-icon-button>
                <paper-icon-button name="about" icon="icons:assignment-ind" on-tap="_deselectPlugin"></paper-icon-button>
              </iron-selector>-->

              <paper-icon-button icon="icons:more-vert"></paper-icon-button>

            </app-toolbar>
          </app-header>

          <div id="content" class="main content">

          <!--<iron-pages selected="[[page]]" attr-for-selected="name">-->

            <!--<chris-feed-about name="about" feed="{{feed}}"></chris-feed-about>
            <chris-feed-note name="note" notes="{{note}}"></chris-feed-note>
            <chris-feed-comments name="comments" comments="{{comments}}"></chris-feed-comments>-->
            <chris-feed-plugin name="plugin" list="[[pluginInstanceCollection]]" feed-index="[[feedRouteData.index]]" plugin="[[plugin]]" files="[[files]]" on-run-plugin="_runPlugin" on-select-node="_selectPlugin"></chris-feed-plugin>
            <!--<chris-feed-run name="run" plugin="[[plugin]]" plugins="[[plugins]]" on-fetch-plugin="_fetchPlugin"></chris-feed-run>-->

          <!--</iron-pages>-->

          </div>

        </app-header-layout>

    </div>

  </template>

  <script>
    Polymer({
      is: 'chris-feed',
      properties: {

        feed: {
          type: Object,
          observer: '_feedChanged'
          },

        page: {
          type: String,
          value: 'plugin',
          // reflectToAttribute: true,
          observer: '_pageChanged'
        },

        pluginInstanceCollection: {
          type: Array,
          observer: '_listChanged',
        },
        plugins: Array,

        plugin:{
          type: Object,
          observer: '_pluginChanged'
        },

        fileCollection: Array,

        files: Array,

        workflow: Array,

        note: Object,

        comments: Object,

        details: Object,

        error: Object,

        route: Object,
        
        routeData: Object

      },

      ready: function( event ){

      },

      _feedIndexChanged: function( index ) {

        console.log( '_feedIndexChanged ');
        console.log( index );

      },

      _pluginIndexChanged: function( index ) {

        console.log( '_pluginIndexChanged' );
        console.log( index );

      },

      _pluginDSIdChanged: function( id ) {

        console.log( '_pluginDSIdChanged' );
        console.log( id );

        if( id ){

          //this.page = 'plugin';

        }

      },

      _feedChanged: function(){

        console.log('feed changed');

        var data = {};
        data.auth = {
          type: 'token',
          token: sessionStorage.getItem('token')
        };

        // get comments
        var requestComments = this.$.API.request( 'GET', this.feed.links.comments, data );
        requestComments
          .then( this.handleComments.bind(this) )
          .catch( this.handleError.bind(this) );

        // get note
        var requestNote = this.$.API.request( 'GET', this.feed.links.note, data );
        requestNote
          .then( this.handleNote.bind(this) )
          .catch( this.handleError.bind(this) );

        // get plugins
        data.params = {};
        data.params.root_id = this.feed.data.plugin_instance;
        var requestPlugins =this.$.API.request('GET', '/plugins/instances/search/', data);
        requestPlugins
          .then( this._handlePlugins.bind(this) )
          .catch( this.handleError.bind(this) );
      },

      _reset: function(){

        //this.page = 'about';

      },

      _handleFiles: function(response){
        console.log('handle files');
        var files = [];
        // format plugin
        for(var i = 0; i < response.data.length; i++){
          this._handleFile(response.data[i]);
          console.log('loopin');
          console.log(response.data[i].data.plugin_inst_id);
          console.log(this.feed.data);
          if(response.data[i].data.plugin_inst_id === this.plugin.data.id) files.push(response.data[i]); 
        }

        console.log(files);

        this.set('files', files );
      },

      _handleFile: function(file){
        // create relative path
        var relative_fname = file.data.fname.split('_' + file.data.plugin_inst_id + '/data/')[1];
        file.data.relative_fname = relative_fname;
      },

      _handlePlugins: function(response) {

        // process plugin
        for(var i = 0; i < response.data.length; i++){
          this._handlePlugin(response.data[i]);
        }

        this.set('pluginInstanceCollection', response.data );
      },

      _handlePlugin: function(plugin){
        // console.log(plugin);
        // if plugin not ready watch it!
        // when success, if selected, re-fetch the files

        // start probing if needed
        if(plugin.data.status === 'started') {
          this._waitUntilPluginFinishes(plugin)
          .then(function(data){
            if(plugin.data.id === this.plugin.data.id) {
              this._pluginChanged();
              this.set(['plugin', 'data', 'status'], plugin.data.status);
            }
          }.bind(this));
        }
  
      },

      handleComments: function( response ){

        console.log( response );

        /// ugly hack
        this.$.adl.resetLayout();

          // could/should show nice reload button
        if( !response ){

          return;

        }

        // use href to decide on how to handle it!
        var type = response.href.split(/[/]+/).pop();

        switch(type){

          case 'comments' :
            this.set( 'comments', response );
            break;

          case 'note' :
            this.set( 'note', response );
            break;

          case 'plugins' :
            this.set( 'workflow', response );
            break;

          default:
            break;

        }
      },

      handleNote: function( response ){

        console.log( response );

        /// ugly hack
        this.$.adl.resetLayout();

          // could/should show nice reload button
        if( !response ){

          return;

        }

        // use href to decide on how to handle it!
        var type = response.href.split(/[/]+/).pop();

        switch(type){

          case 'comments' :
            this.set( 'comments', response );
            break;

          case 'note' :
            this.set( 'note', response );
            break;

          case 'plugins' :
            this.set( 'workflow', response );
            break;

          default:
            break;

        }
      },

      handleError: function( response ){

        console.error( response );

      },

      _setLayoutStyle: function( color ){

        // convert hex color to rgb in order to set the alpha channel
        //color = color.replace('#','');
        var r = 121; //parseInt(color.substring(0,2), 16);
        var g = 121; //parseInt(color.substring(2,4), 16);
        var b = 121; //parseInt(color.substring(4,6), 16);

        return 'background-color: rgba(' + r + ',' + g + ',' + b + ', 0.5);';

      },

      _setToolbarStyle: function( color ){

        return 'background-color: ' + color + ';';

      },

      _exit: function(){
        
        this._reset();
        this.fire('exit');

      },


      _openTree: function() {

        console.log( ' open tree ');

        this.$.dropdown.open();

      },

      _pageChanged: function(){

        console.log( this.page );

      },

      _selectPlugin: function( event ){

        if( event.detail.data ){

          this.plugin = event.detail;

        }
        else {

          this._deselectPlugin();

        }

      },

      _deselectPlugin: function(){

        this.plugin = null;

      },

      _pluginChanged: function(){

        if( ! this.page ){
          return;
        }

        //
        if( this.plugin !== null ){

          console.log(this.plugin);
          
          this.page = 'plugin';
          // retrieve files for this plugin
          var data = {};
          data.auth = {
            type: 'token',
            token: sessionStorage.getItem('token')
          };

        data.params = {};
        data.params.limit = 99999;
        data.params.page_size = 99999;
          
        var requestFiles = this.$.API.request( 'GET', this.feed.links.files, data );
        requestFiles
          .then( this._handleFiles.bind(this) )
          .catch( this.handleError.bind(this) );

        }
        else{

          this.page = 'about';

        }
        
      },

      _runPlugin: function(){

        if( this.plugin ){

          this.page = 'run';

        }

      },

      _closeDropdown: function(){

        this.$.dropdown.close();

      },

      _waitUntilPluginFinishes: function(plugin){

        // new feed
        var data = {};
        data.auth = {
          type: 'token',
          token: sessionStorage.getItem( 'token' )
        };
        var waitPromise = new Promise(
           function(resolve, reject) {
             var remaningAttemps = 6;

             function run() {
              this.$.API.request('GET', plugin.href , data).
              then( function(response2) {
                console.log(plugin);
                // check depdending on status
                console.log(response2);
                if(remaningAttemps < 5 && response2.data[0].data.status === 'finishedSuccessfully') {
                  resolve(response2);
                } else {
                  remaningAttemps--;
                  if(remaningAttemps <= 0) {
                    reject(response2);
                  } else {
                    setTimeout(run, 1000);
                  }
                }
              }.bind(this));
             }

             run = run.bind(this);
             run();

           }.bind(this)
        );

        return waitPromise;
      }

      // _fetchPlugin: function( event ){

      //   // get the plugin
      //   var data = {};
      //   data.auth = {
      //     type: 'token',
      //     token: sessionStorage.getItem('token')
      //   };

      //   // add parameters to help the FAKE API// (not required by real API)
      //   data.params = {};
      //   data.params.fake_api_previous_id = this.plugin.data.id;

      //   var fetchPlugin =this.$.API.request('GET', event.detail.href, data);
      //   fetchPlugin
      //     .then( this._handlePlugin.bind(this) )
      //     .catch( this.handleError.bind(this) );

      // },

      // _handlePlugin: function( event ){

      //   this.push('pluginInstanceCollection', event.data[0]);
      //   this.plugin = event.data[0];   

      // },

      // _listChanged: function(){
      //   console.log(this.pluginInstanceCollection);
      // }

    });
  </script>
</dom-module>
