<!--
@license
Copyright (c) 2016 FNNDSC. All rights reserved.
-->

<link rel="import" href="../../../bower_components/polymer/polymer.html">

<!-- APP ELEMENTS -->
<link rel="import" href="../../../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../../../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../../../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../../../bower_components/app-layout/app-toolbar/app-toolbar.html">

<!-- IRON ELEMENTS -->
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/iron-icons/av-icons.html">

<!-- PAPER ELEMENTS -->
<link rel="import" href="../../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">

<dom-module id="chris-app">

  <template>

    <style>
    
    :host{

      background-color: var(--dark-primary-color);
      --paper-input-container-focus-color: var(--accent-color);

    }

    app-header-layout {

      /* use fit instead... */
      position: absolute;
      top: 0;
      right: 0;
      left: 0;
      bottom: 0;

    }

    app-toolbar {

      color: #ffffff;

    }

    a {

      color: #ffffff;

    }

    </style>

    <app-header-layout has-scrolling-region style$="[[_setLayoutStyle(app.data.color)]]">
      <app-header fixed condenses effects="waterfall">
        <app-toolbar style$="[[_setToolbarStyle(app.data.color)]]">
          <div main-title>[[app.data.label]]</div>
          <a class="back" href="/home">
            <paper-icon-button icon="icons:clear"></paper-icon-button>
          </a>
        </app-toolbar>
        <app-toolbar id="appToolbar" style$="[[_setToolbarStyle(app.data.color)]]" sticky>

        </app-toolbar>
      </app-header>

      <div id="content" class="content">
      </div>

    </app-header-layout>

  </template>


  <script>
    Polymer({
        is: 'chris-app',
        properties: {

          app: {
            type: Object,
            observer: '_appChanged'
          },

          feed:{
            type: Object
          }

        },

        _appChanged: function( ){

          // remove child if any
          // maybe better to hide?
          var node = Polymer.dom(this.$.content).firstElementChild;

          if( node ){

            Polymer.dom( this.$.content ).removeChild( node );
            Polymer.dom( this.$.appToolbar ).removeChild( Polymer.dom(this.$.appToolbar).firstElementChild );

            // remove event listener
            node.removeEventListener( 'parameters-changed', this._createFeed );

          }
          
          // fetch the plugin!
          Polymer.Base.importHref(
            this.resolveUrl( '../../chris-apps/chris-apps-' + this.app.data.name + '/chris-apps-' + this.app.data.name + '.html' ),
            function( evt ){

              var plugin = document.createElement( 'chris-apps-' + this.app.data.name );

              // attach app
              Polymer.dom( this.$.content ).appendChild( plugin );

              // attach toolbar
              Polymer.dom( this.$.appToolbar ).appendChild( plugin.toolbar );

              // add event listener
              plugin.addEventListener( 'parameters-changed', this._createFeed.bind( this ) );

            }.bind( this ),

            function( evt ){

              window.console.log( 'oops, something went wrong...' );
              window.console.log( evt );

            }.bind( this ),
            true );
        },

        _getParamters: function(){

          var node = Polymer.dom(this.$.content).firstElementChild;
          node.generateParameters();

        },

        _createFeed: function(){

          // push to the API
          // print plugin command line paramters
          var node = Polymer.dom(this.$.content).firstElementChild;

          // feed created
          // ask for feed ID # through API...
          // call API to get feed
          // the create plugin should return it to us...
          this.feed = {};
          this.feed.details = {
            id: '', // will be overwritten
            name: 'created by ' + this.app.data.name,
            opened: false,
            checked: false,
            color: this.app.data.color,
            favorite: false,
            status: 'running',
            tags: [],
            selected: false,
            letter: this.app.data.name.charAt(0).toUpperCase(),
            date: ( new Date() ).toString()
          }
          this.feed.plugins = [{
            label: this.app.data.name,
            color: this.app.data.color,
            id: 0,
            parentID: 0,
            depth: 0,
            icon: 'icons:cloud-queue',
            workflow: [{
              color: this.app.data.color,
              icon: 'icons:cloud-queue',
              label: this.app.data.name
            }]
          }];
          this.feed.comments = [];

          this.feed.note = '\
# Note about ' + this.app.data.name + '\n\
\n\
---\n\
### parameters\n\
';

        // add parameters to the note
        var parametersKeys = Object.keys( node.parameters );
        for( var i = 0; i < parametersKeys.length; i++ ){

          var key = parametersKeys[i];
          this.feed.note += '*' + key + '* : ' + node.parameters[key] + '\n\n';

        }

          // fire in X seconds to fake finished notification
          this.fire('feed-changed');

        },

        _setLayoutStyle: function( color ){

          // convert hex color to rgb in order to set the alpha channel
          color = color.replace('#','');
          var r = parseInt(color.substring(0,2), 16);
          var g = parseInt(color.substring(2,4), 16);
          var b = parseInt(color.substring(4,6), 16);

          return 'background-color: rgba(' + r + ',' + g + ',' + b + ', 0.5);';

        },

        _setToolbarStyle: function( color ){

          return 'background-color: ' + color + ';';

        }
  });
  </script>
</dom-module>
