<!--
@license
Copyright (c) 2016 FNNDSC. All rights reserved.
-->

<link rel="import" href="../../../bower_components/polymer/polymer.html">

<!-- APP ELEMENTS -->
<link rel="import" href="../../../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../../../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../../../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../../../bower_components/app-layout/app-toolbar/app-toolbar.html">

<!-- IRON ELEMENTS -->
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/iron-icons/av-icons.html">

<!-- PAPER ELEMENTS -->
<link rel="import" href="../../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">

<dom-module id="chris-app">

  <template>

    <style>

    :host{

      background-color: var(--dark-primary-color);
      --paper-input-container-focus-color: var(--accent-color);

    }

    app-header-layout {

      /* use fit instead... */
      position: absolute;
      top: 0;
      right: 0;
      left: 0;
      bottom: 0;

    }

    app-toolbar {

      color: #ffffff;

    }

    a {

      color: #ffffff;

    }

    </style>

    <app-header-layout has-scrolling-region style$="[[_setLayoutStyle(app.color)]]">
      <app-header fixed condenses effects="waterfall">
        <app-toolbar style$="[[_setToolbarStyle(app.color)]]">
          <div main-title>[[app.label]]</div>
          <a class="back" href="/home" on-tap="_reset">
            <paper-icon-button icon="icons:clear"></paper-icon-button>
          </a>
        </app-toolbar>
        <app-toolbar id="appToolbar" style$="[[_setToolbarStyle(app.color)]]" sticky>

        </app-toolbar>
      </app-header>

      <div id="content" class="content">
      </div>

    </app-header-layout>

  </template>


  <script>
    Polymer({
        is: 'chris-app',
        properties: {

          app: {
            type: Object,
            observer: '_appChanged'
          },

          appElt: HTMLElement,

          feed:{
            type: Object
          }

        },

        attached: function(){

          console.log( 'got attached' );

        },

        _appChanged: function( ){

          console.log( this.app );

          if( this.appElt ){

            Polymer.dom( this.$.content ).removeChild( this.appElt );
            Polymer.dom( this.$.appToolbar ).removeChild( Polymer.dom(this.$.appToolbar).firstElementChild );

            // remove reference if any
            this.appElt = null;

          }

          // fetch the plugin!
          Polymer.Base.importHref(
            this.resolveUrl( '../../chris-apps/chris-apps-' + this.app.name + '/chris-apps-' + this.app.name + '.html' ),
            function( evt ){

              this.appElt = document.createElement( 'chris-apps-' + this.app.name );

              // attach app
              Polymer.dom( this.$.content ).appendChild( this.appElt );

              // attach toolbar
              Polymer.dom( this.$.appToolbar ).appendChild( this.appElt.toolbar );

            }.bind( this ),

            function( evt ){

              window.console.log( 'oops, something went wrong...' );
              window.console.log( evt );

            }.bind( this ),
            true );
        },

        _reset: function(){

          this.appElt.reset();

        },

        _setLayoutStyle: function( color ){

          // convert hex color to rgb in order to set the alpha channel
          color = color.replace('#','');
          var r = parseInt(color.substring(0,2), 16);
          var g = parseInt(color.substring(2,4), 16);
          var b = parseInt(color.substring(4,6), 16);

          return 'background-color: rgba(' + r + ',' + g + ',' + b + ', 0.5);';

        },

        _setToolbarStyle: function( color ){

          return 'background-color: ' + color + ';';

        }
  });
  </script>
</dom-module>
