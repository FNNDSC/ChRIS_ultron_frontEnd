<link rel="import" href="../../bower_components/polymer/polymer.html">

<!-- APP LAYOUT ELEMENTS -->
<link rel="import" href="../../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../../bower_components/app-layout/app-toolbar/app-toolbar.html">

<!-- IRON ELEMENTS -->
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">

<!-- PAPER ELEMENTS -->
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">

<!-- CHRIS ELEMENTS -->
<link rel="import" href="../chris-api/chris-api.html">
<link rel="import" href="../chris-feed-list/chris-feed-list.html">
<link rel="import" href="../chris-label-list/chris-label-list.html">
<link rel="import" href="../chris-login/chris-login.html">

<dom-module id="chris-ultron">
  <template>

    <style>
      :host {
        display: block;

        /* Define theme here for now....*/
        /* text */
        --primary-text-color: var(--paper-grey-900);
        --primary-background-color: #ffffff;
        --secondary-text-color: #737373;
        --disabled-text-color: #9b9b9b;

        --divider-color: #dbdbdb;

        /* colors */
        --primary-color: var(--paper-blue-500);
        --light-primary-color: var(--paper-blue-100);
        --dark-primary-color: var(--paper-blue-700);
        
        --accent-color: var(--paper-pink-a200);
        --light-accent-color: var(--paper-pink-a100);
        --dark-accent-color: var(--paper-pink-a400);
      }

      app-header {

        background-color: var(--dark-primary-color);
        color: #fff;

      }

      app-header paper-icon-button {

        --paper-icon-button-ink-color: #ffffff;

      }

      .drawer.content {

        height: 100%;
        overflow: auto;

      }

      app-header-layout {

        background-color: var(--paper-grey-100);
        /*min-height: 201vh;*/

      }

    </style>

    <div id="container">
    
      <template is="dom-if" if="{{!loggedIn}}" restamp>

        <chris-login id="login" logged-in={{loggedIn}}></chris-login>

      </template>

      <template is="dom-if" if="{{loggedIn}}" on-dom-change="_domChange" restamp>

        <div id="home">

          <!-- API Calls -->
          <chris-api id="FeedsAPI"
            api="Feeds"
            response="{{feeds}}"
            error="{{error}}" on-error="handleError">
          </chris-api>

          <chris-api id="PluginsFeedAPI"
            api="PluginsFeed"
            response="{{plugins}}" on-response="handlePlugins"
            error="{{error}}" on-error="handleError">
          </chris-api>

          <chris-api id="LabelsAPI"
            api="Labels"
            response="{{labels}}"
            error="{{error}}" on-error="handleError">
          </chris-api>

          <app-drawer-layout fullbleed>

            <!-- Drawer content -->
            <app-drawer>

              <div class="drawer content">

                <app-toolbar>Menu</app-toolbar>
                <chris-label-list custom-labels="{{labels}}"></chris-label-list>

              </div>

            </app-drawer>

            <!-- Main content -->
            <app-header-layout has-scrolling-region>

              <app-header id="appHeader" fixed effects="waterfall">
                <app-toolbar>
                  <paper-icon-button icon="menu" drawer-toggle></paper-icon-button>
                  <div title>My App</div>
                </app-toolbar>
              </app-header>

              <div class="main content">

                <chris-feed-list feeds="[[feeds]]"></chris-feed-list>

              </div>

            </app-header-layout>

          </app-drawer-layout>

        </div>

      </template>

    </div>

  </template>

  <script>

    // performance logging
    window.performance && performance.mark && performance.mark('chris-ultron - before register');

    Polymer({

      is: 'chris-ultron',

      properties: {

        loggedIn:{
          type: Boolean,
          value: false
        },

        feeds: {
          type: Array
        },

        plugins: {
          type: Object
        },

        labels: {
          type: Array
        },

        error: {
          type: Object
        } 

      },

      created: function() {
        window.performance && performance.mark && performance.mark('chris-ultron.created');
        // Custom elements polyfill safe way to indicate an element has been upgraded.
        this.removeAttribute('unresolved');

      },

      ready: function(){

        // if username and token are stored, we are still loggedIn in
        if ( sessionStorage.getItem( 'username' ) &&
             sessionStorage.getItem( 'token' ) ) {

          this.loggedIn = true;

        }

      },

      _domChange: function( event ){

        if( this.loggedIn ){

          // logged in
          // prepare parameters for API call
          var params = {
            auth: 'user=' + sessionStorage.getItem( 'username' ) + ',hash=' + sessionStorage.getItem( 'token' )
          };

          // fetch the feeds
          this.$$( '#FeedsAPI' ).params = params;
          this.$$( '#FeedsAPI' ).url = '';

          // fetch the plugins that can create a feed
          this.$$( '#PluginsFeedAPI' ).params = params;
          this.$$( '#PluginsFeedAPI' ).url = 'pluginsFeed';

          // fetch the labels
          this.$$( '#LabelsAPI' ).params = params;
          this.$$( '#LabelsAPI' ).url = '';

          // this.$$('#appHeader').scrollTarget = document.querySelector("#scrollingRegion");

          }

        },

        handlePlugins: function(){

          console.log( 'handlePlugins not implemented' );
          // console.log( this.plugins );

        },

        handleError: function(){

          console.error( this.error );

        }

    });
  </script>
</dom-module>
