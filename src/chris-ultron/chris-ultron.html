<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../chris-api/chris-api.html">
<link rel="import" href="../chris-login/chris-login.html">

<dom-module id="chris-ultron">
  <template>
    <style>
      :host {
        display: block;

        /* Define theme here for now....*/
        /* text */
        --primary-text-color: var(--paper-grey-900);
        --primary-background-color: #ffffff;
        --secondary-text-color: #737373;
        --disabled-text-color: #9b9b9b;

        --divider-color: #dbdbdb;

        /* colors */
        --primary-color: var(--paper-blue-500);
        --light-primary-color: var(--paper-blue-100);
        --dark-primary-color: var(--paper-blue-700);
        
        --accent-color: var(--paper-pink-a200);
        --light-accent-color: var(--paper-pink-a100);
        --dark-accent-color: var(--paper-pink-a400);
      }
    </style>

    <div id="container">
    
      <template is="dom-if" if="{{!loggedIn}}" restamp>

        <chris-login id="login" logged={{loggedIn}}></chris-login>

      </template>

      <template is="dom-if" if="{{loggedIn}}" on-dom-change="_domChange" restamp>

        <div id="home">

          <!-- API Calls -->
          <chris-api id="FeedsAPI"
            api="Feeds"
            response="{{items}}" on-response="fetchPlugins">
          </chris-api>

          <chris-api id="PluginsFeedAPI"
            api="PluginsFeed"
            response="{{plugins}}" on-reponse="fetchLabels">
          </chris-api>

          <chris-api id="LabelsAPI"
            api="Labels"
            response="{{labels}}">
          </chris-api>

          Welcome to ChRIS Ultron!

        </div>

      </template>

    </div>

  </template>

  <script>

    // performance logging
    window.performance && performance.mark && performance.mark('chris-ultron - before register');

    Polymer({

      is: 'chris-ultron',

      properties: {

        loggedIn:{
          type: Boolean,
          value: false
        },

      },

      created: function() {
        window.performance && performance.mark && performance.mark('chris-ultron.created');
        // Custom elements polyfill safe way to indicate an element has been upgraded.
        this.removeAttribute('unresolved');

      },

      ready: function(){

        // if username and token are stored, we are still loggedIn in
        if ( sessionStorage.getItem( 'username' ) &&
             sessionStorage.getItem( 'token' ) ) {

          this.loggedIn = true;

        }

      },

      _domChange: function( event ){

        if( this.loggedIn ){

          // logged in
          // prepare parameters for API call
          var params = {
            auth: 'user=' + sessionStorage.getItem( 'username' ) + ',hash=' + sessionStorage.getItem( 'token' )
          };

          // fetch the feeds
          this.$$( '#FeedsAPI' ).params = params;
          this.$$( '#FeedsAPI' ).url = '';

          // fetch the plugins that can create a feed
          this.$$( '#PluginsFeedAPI' ).params = params;
          this.$$( '#PluginsFeedAPI' ).url = '';

          // fetch the labels
          this.$$( '#LabelsAPI' ).params = params;
          this.$$( '#LabelsAPI' ).url = '';

          }

        }

    });
  </script>
</dom-module>
