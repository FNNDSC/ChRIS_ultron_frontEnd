<link rel="import" href="../../bower_components/polymer/polymer.html">

<!-- APP ELEMENTS -->
<link rel="import" href="../../bower_components/app-layout/app-toolbar/app-toolbar.html">

<!-- IRON ELEMENTS -->
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icons/social-icons.html">

<!-- PAPER ELEMENTS -->
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<!-- <link rel="import" href="../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../bower_components/paper-menu-button/paper-menu-button.html"> -->
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<!-- <link rel="import" href="../../bower_components/paper-item/paper-item.html"> -->
<link rel="import" href="../../bower_components/paper-tooltip/paper-tooltip.html">

<!-- CHRIS -->
<link rel="import" href="../chris-api/chris-api.html">

<dom-module id="chris-feed">

  <template>

    <style>

      :host{
        display: block;

      }

      #feed {

        @apply(--layout-flex);
        @apply(--layout-vertical);
        padding: 20px;
        background-color: white;
        /*border: 1px solid #ddd;*/
        margin-bottom: 10px;

      }

      #feed:hover {

        @apply(--shadow-elevation-8dp);

      }

      #feed[opened] {

        background-color: var(--light-accent-color);

      }

      
      .title {

        padding: 0 16px;
        @apply(--layout-flex);
        @apply(--layout-vertical);

      }

      .name {

        font-size: 16px;
        font-weight: bold;

      }

      .date {

        font-size: 14px;
        color: gray;

      }

      .tags {

        font-size: 14px;
        color: gray;

      }

      app-toolbar {

        flex:1;

      }

      .status, #content {

        display: none;

      }

      .status.expanded, .feed.expanded #content {

        display: block;

      }

      #favorite{

        color: var(--paper-pink-a200);

      }

      paper-icon-button.done{

        color: var(--paper-light-green-500);

      }

      paper-icon-button.running{

        color: var(--paper-light-blue-500);

      }

      paper-icon-button.error{

        color: var(--paper-red-500);

      }

      .letter{
        height: 48px;
        width: 48px;
        border-radius: 24px;
        box-sizing: border-box;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      paper-icon-button.action:hover{

        color: var(--accent-color);
        cursor: pointer;

      }

      .letter:hover{

        color: var(--accent-color);
        border-color: var(--accent-color)!important;
        cursor: pointer;

      }

    </style>

<!--     <chris-api id="chrisAPI" api="FeedDetails" response="{{feed.details}}" on-response="handleDetails">
    </chris-api> -->
    <chris-api id="FeedAPI"
      api="Feed",
      method="POST",
      content-type="application/json",
      response="{{response}}"
      on-response="handleFeed"
      error="{{error}}"
      on-error="handleError">
    </chris-api>


    <paper-material id="feed" class="feed" elevation=1>

      <!-- Toolbar -->
      <app-toolbar>

        <div id="select" class="letter" style$="{{_setStyle(feed.color)}}" on-tap="select">[[feed.letter]]</div>
        <paper-tooltip for="select" offset="0">Select</paper-tooltip>

        <div class="title">
          <div class="name">Feed [[feed.id]] - [[feed.name]]</div>
          <div class="date">[[feed.date]]</div>
          <div class="tags">
            <template is="dom-repeat" items="[[_validateTags(feed.tags)]]">
              <span class="tag" style$="{{_setTagStyle(item.color)}}">#<span>{{item.name}}</span></span>
            </template>
          </div>
        </div>

        <div class="actions">

          <paper-icon-button id="share" class="action" icon="social:share" on-tap="share"></paper-icon-button>

<!--           <paper-menu-button id="tag" ignore-select on-tap="tag">
            <paper-icon-button icon="icons:label-outline" class="dropdown-trigger" alt="multi select"></paper-icon-button>
            <paper-menu class="dropdown-content" multi>
              <template is="dom-repeat" items="[[feed.tags]]">
                <paper-item>[[item.name]]</paper-item>
              </template>
            </paper-menu>
          </paper-menu-button>
 -->
          <paper-icon-button id="tag" class="action" icon="icons:label-outline" on-tap="tag"></paper-icon-button>
          <paper-icon-button id="favorite" class="action" icon="icons:favorite-border" on-tap="favorite"></paper-icon-button>
          <paper-icon-button icon$="{{_setStatusIcon(feed.status)}}" class$="{{feed.status}}" disabled></paper-icon-button>

          <paper-tooltip for="share" offset="0">Share</paper-tooltip>
          <paper-tooltip for="tag" offset="0">Tag</paper-tooltip>
          <paper-tooltip for="favorite" offset="0">Favorite</paper-tooltip>

        </div>

      </app-toolbar>

      <div id="content">
      I am the CONTENT!
<!--         <chris-note note="[[feed.details.note]]"></chris-note>
        <chris-plugin-list feedindex="[[index]]" plugins="[[feed.details.plugins]]"></chris-plugin-list>
        <chris-comment-list comments="[[feed.details.comments]]"></chris-comment-list> -->
      </div>

    </paper-material>

  </template>

  <script>
    Polymer({
        is: 'chris-feed',
        properties: {

          feed: {
            type: Object,
            observer: '_validateFeed'
          },

          opened:{
            type: Boolean,
            value: false,
            observer: '_openedChanged'
          },

          index: {
            type: Number
          },

          valid:{
            type: Boolean
          },

          response:{
            type: Array
          },

          error: {
            type: Array
          }

        },

        observers: [
          '_setFavoriteIcon(feed.favorite)'
        ],

        _openedChanged: function( ){

          // toggle if details available
          //  && this.feed.details 
          if( this.feed ){

            this.opened ? this.$.feed.classList.add('expanded') : this.$.feed.classList.remove('expanded');
            this.opened ? this.$.feed.elevation = 4 : this.$.feed.elevation = 1;

            return;

          }

          // trigger API call
          if( this.feed ){

            return;

            this.$.chrisAPI.url = "";
            this.$.chrisAPI.params = {
              feedID: this.feed.index // feed.id
            };

          }

        },

        _setStyle: function( color ){

          return 'border: 4px solid ' + color + ';';

        },

        _setStatusIcon: function( status ){

          var icon = 'icons:';

          if( status === 'running'){

            icon += 'schedule';

          }
          else if( status === 'error' ){

            icon += 'clear';

          }
          else{

            icon += 'done';

          }

          return icon;

        },

        _setTagStyle: function( color ){

          return 'color: ' + color + ';';

        },

        _setFavoriteIcon: function( favorite ) {

          this.$.favorite.icon = this.feed.favorite ? 'favorite-border' : 'favorite';

        },

        select: function( event ){

          event.preventDefault();
          event.stopPropagation();

          console.log( 'select feed' );

        },

        share: function( event ){

          event.preventDefault();
          event.stopPropagation();

          console.log( 'share feed' );

        },

        tag: function( event ){

          event.preventDefault();
          event.stopPropagation();

          console.log( 'tag feed' );

        },

        favorite: function( event ){

          event.preventDefault();
          event.stopPropagation();

          // update feed favorite
          this.set('feed.favorite', !this.feed.favorite);

          // api push
          var params = {
            auth: 'user=' + sessionStorage.getItem( 'username' ) + ',hash=' + sessionStorage.getItem( 'token' )
          };

          // fetch the feeds
          this.$.FeedAPI.params = params;
          this.$.FeedAPI.body = this.feed;
          this.$.FeedAPI.url = '';

        },

        handleFeed: function( event ){

          // stop ajax propagation
          event.preventDefault();
          event.stopPropagation();

          // compare reponse and the data
          if( this.response.update && !this.response.update.status ){

            // revert changes
            this.set( 'feed', this.response );

            // show toast message
            this.fire( 'notification', {text: this.response.update.text} );

          }

        },

        handleError: function( event ){

          // stop ajax propagation
          event.preventDefault();
          event.stopPropagation();
          console.log( this.error );

        },

        _validateFeed: function(){

          if( !this.feed ){

            return;

          }

          var error = [];

          // need id
          if( !( typeof this.feed.id === 'string' ) ){

            error.push( 'id:String' );

          }

          // need name
          if( !( typeof this.feed.name === 'string' ) ){

            error.push( 'name:String' );

          }

          // need letter
          if( !( typeof this.feed.letter === 'string' ) ){

            error.push( 'letter:String' );

          }

          // need color
          if( !( typeof this.feed.color === 'string' ) ){

            error.push( 'color:String' );

          }

          // need date
          if( !( typeof this.feed.date === 'string' ) ){

            error.push( 'date:String' );

          }

          // need status
          if( !( typeof this.feed.status === 'string' ) ){

            error.push( 'status:String' );

          }

          // need favorite
          if( !( typeof this.feed.favorite === 'boolean' ) ){

            error.push( 'favorite:Boolean' );

          }

          // need tags array
          if( !( this.feed.tags && this.feed.tags.constructor === Array ) ){

            // should we "fix" it or hide the feed and show error
            // just show error "feed"
            // if invalid: red and can not do anything
            this.set('feed.tags', []);
            error.push( 'tags:Array' );

          }

          if( error.length > 0){

            // got an error
            this.error = error;
            this.fire( 'error-changed' );
            // triggers error on Firefox for some reason...
            // this.fire( 'error' );

            // make it invalid
            this.valid = false;
            this.fire( 'valid-changed' );

            // fire error here because firefox complains if we do it before...?
            this.fire( 'error' );

            return;

          }

          this.valid = true;
          this.fire( 'valid-changed');

        },

        _validateTags: function( tags ){

          if( !( tags && tags.constructor === Array ) ){

            return [];

          }

          return tags;

        }

    });
  </script>
</dom-module>
