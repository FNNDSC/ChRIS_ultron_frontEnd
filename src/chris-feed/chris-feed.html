<!--
@license
Copyright (c) 2016 FNNDSC. All rights reserved.
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">

<!-- IRON -->
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-image/iron-image.html">
<link rel="import" href="../../bower_components/iron-list/iron-list.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-scroll-threshold/iron-scroll-threshold.html">

<!-- PAPER <3 -->
<link rel="import" href="../../bower_components/paper-badge/paper-badge.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../../bower_components/paper-styles/color.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">
<link rel="import" href="../../bower_components/paper-toggle-button/paper-toggle-button.html">

<!-- APP LAYOUT -->
<link rel="import" href="../../bower_components/app-layout/app-toolbar/app-toolbar.html">

<!-- CHRIS -->
<link rel="import" href="../chris-api/chris-api.html">
<link rel="import" href="../chris-comment-list/chris-comment-list.html">
<link rel="import" href="../chris-note/chris-note.html">
<link rel="import" href="../chris-plugin-list/chris-plugin-list.html">

<dom-module id="chris-feed">

  <template>

    <style>
      #feed {
        @apply(--layout-vertical);
        padding: 20px;
        background-color: white;
        border: 1px solid #ddd;
        cursor: pointer;
        margin-bottom: 10px;
      }

      #feed.checked {
        background-color: var(--paper-teal-a100);
      }

      .avatar {
        height: 40px;
        width: 40px;
        border-radius: 20px;
        box-sizing: border-box;
        background-color: #DDD;
      }
      .pad {
        padding: 0 16px;
        @apply(--layout-flex);
        @apply(--layout-vertical);
      }
      .primary {
        font-size: 16px;
        font-weight: bold;
      }
      .description, .date {
        font-size: 14px;
        color: gray;
      }

      #content {
        margin-top:20px;
        cursor: default;
      }

      app-toolbar {
        flex:1;
      }

      #favorite {
        color: var(--paper-pink-500);
      }

      paper-icon-button {
        color: var(--paper-grey-500);
      }

      paper-progress {
        padding-top: 10px;
        width: 100%;
        --paper-progress-height: 2px
      }

      paper-progress.running {
        --paper-progress-active-color: var(--paper-light-blue-500);
      }

      paper-progress.success {
        --paper-progress-active-color: var(--paper-light-green-500);
      }

      paper-progress.error {
        --paper-progress-active-color: var(--paper-red-500);
      }

      .status, #content {
        display: none;
      }

      .status.expanded, .feed.expanded #content {
        display: block;
      }

    </style>

    <chris-api id="chrisAPI" api="FeedDetails" response="{{details}}" on-return="handleDetails"></chris-api>

      <div>

        <paper-progress id="status" class="status" value="100"></paper-progress>

        <div id="feed" class="feed">

          <!-- Toolbar -->
          <app-toolbar>

            <iron-image class="avatar" sizing="contain" src="[[feed.image]]" on-tap="check"></iron-image>
            <div class="pad">
              <div class="primary">Feed [[feed.id]] - [[feed.name]]</div>
              <div class="description">[[feed.description]]</div>
              <div class="date">[[feed.date]]</div>
            </div>
            <!-- <paper-badge label="3"></paper-badge> -->
            <div class="icons">
              <paper-icon-button icon="delete" on-tap="donothing"></paper-icon-button>
              <paper-icon-button icon="social:share" on-tap="donothing"></paper-icon-button>
              <paper-icon-button icon="label" on-tap="donothing"></paper-icon-button>
              <paper-icon-button id="favorite" icon$="[[favoriteIconForFeed(feed)]]" on-tap="favoriteFeed"></paper-icon-button>
            </div>

          </app-toolbar>

          <div id="content" on-tap="donothing">
            <chris-note note="[[details.note]]"></chris-note>
            <chris-plugin-list feedindex="[[index]]" plugins="[[details.plugins]]"></chris-plugin-list>
            <chris-comment-list comments="[[details.comments]]"></chris-comment-list>
          </div>

        </div>

      </div>
  </template>

  <script>
    Polymer({
        is: 'chris-feed',
        properties: {
          feed: {
            type: Object
          },
          details:{
            type: Object,
            value: null
          },
          selected:{
            type: Boolean,
            value: false,
            observer: '_selectedChanged'
          },
          checked:{
            type: Boolean,
            value: false
          },
          index: {
            type: Number
          }
        },
        iconForItem: function(item) {
          return item ? (item.integer < 50 ? 'star-border' : 'star') : '';
        },
        getClassForItem: function(item, selected) {
          return selected ? 'item expanded' : 'item';
        },
        favoriteIconForFeed: function(feed) {
          return this.feed.favorite ? 'favorite-border' : 'favorite';
        },
        favoriteFeed: function(evt){
          evt.preventDefault();
          evt.stopPropagation();

          this.feed.favorite = !this.feed.favorite;
          this.$.favorite.icon = this.feed.favorite ? 'favorite-border' : 'favorite';
        },
        _selectedChanged: function(){
          // toggle if details available
          if(this.details){
            this.selected ? this.$.feed.classList.add('expanded') : this.$.feed.classList.remove('expanded');
            return;
          }

          // trigger API call
          if(this.feed){
            // start progress bar
            // this.$.status.value = 10;
            // this.$.status.indeterminate = true;
            // this.$.status.classList.add('expanded', 'running');

            this.$.chrisAPI.url = "";
            this.$.chrisAPI.params = {
              feedID: this.feed.index // feed.id
            };
          }
        },
        handleDetails: function(evt){
          // stop progress
          // this.$.status.classList.remove('expanded','running');

          // toggle that we have details now
          this._selectedChanged();
          // let iron-list know the size of the feed changed
          // window.console.log('details changed');
          this.fire('size', {index: this.index});
        },
        donothing: function(evt){
          evt.stopPropagation();
          evt.preventDefault();
        },
        check: function(evt){
          // this.donothing(evt);
          // this.checked = !this.checked;

          // this.checked ? this.$.feed.classList.add('checked') : this.$.feed.classList.remove('checked');
        }
    });
  </script>
</dom-module>
