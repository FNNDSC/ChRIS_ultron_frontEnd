<!--
@license
Copyright (c) 2016 FNNDSC. All rights reserved.
-->

<link rel="import" href="../../../bower_components/polymer/polymer.html">

<!-- IRON ELEMENTS -->
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/iron-icons/editor-icons.html">
<link rel="import" href="../../../bower_components/iron-selector/iron-selector.html">

<!-- PAPER ELEMENTS -->
<link rel="import" href="../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../../bower_components/paper-listbox/paper-listbox.html">

<!-- CHRIS ELEMENTS -->
<link rel="import" href="../chris-dataviews-behaviors/chris-dataviews-behaviors.html">

<dom-module id="chris-dataviews-rows">

  <template>

    <style include="iron-flex iron-flex-alignment">

      #rowsView{

        width:100%;
        overflow-x: scroll;
        border: 1px solid var(--primary-text-color);

      }
      #rowsView paper-listbox{

        overflow-y: scroll;
        min-height: 300px;
        max-height: 300px;

      }

      iron-icon {

        margin-right: 2px;

      }

      paper-item {

        --paper-item: {

          cursor: pointer;

        };

      }

      paper-item[type="folder"] iron-icon{

        --iron-icon-stroke-color: var(--primary-color);
        --iron-icon-fill-color: var(--paper-grey-100);

      }

      paper-item[type="folder"][up] iron-icon{

        --iron-icon-stroke-color: var(--paper-grey-500);
        --iron-icon-fill-color: var(--paper-grey-500);

      }

      paper-item[type="folder"][up] {

        color: var(--paper-grey-500);

      }

      paper-item[type="file"] iron-icon{

        --iron-icon-stroke-color: var(--accent-color);
        --iron-icon-fill-color: var(--paper-grey-100);

      }

      #rowsView paper-item{

        min-height:32px;
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
        display:block;
        --paper-item-selected: {
        color: var(--primary-color);

        };

      }
    </style>

    <div id="rowsView">

      <paper-listbox depth="0" on-iron-select="_selectionChanged">

        <!-- button to go up -->
        <paper-item type="folder" up> <iron-icon icon="icons:arrow-back"></iron-icon></paper-item>

        <!-- show folders -->
        <template is="dom-repeat" items="{{data.files}}" as="file">
          <paper-item type="folder"> <iron-icon icon="icons:folder"></iron-icon> [[file.label]]</paper-item>
        </template>

        <!-- show files -->
        <template is="dom-repeat" items="{{data.images}}" as="image">
          <paper-item type="file"> <iron-icon icon="editor:insert-drive-file"></iron-icon> [[image.label]]</paper-item>
        </template>

      </paper-listbox>

    </div>

  </template>

  <script>
    Polymer({
        is: 'chris-dataviews-rows',

        behaviors: [
          Dataviews
        ],

        _pathChanged: function(){

          console.log( 'rows path changed');
          console.log( this.path );

          // update UI

        },

        _selectionChanged: function( evt ){

          // update the path

          var depth = parseInt( evt.target.attributes.depth.nodeValue, 10 );
          var type = evt.target.selectedItem.attributes.type.nodeValue;

          if(type === 'file'){
            // we are done!
            return;
          }

          var oldListBox = Polymer.dom( this.$.rowsView ).querySelector( 'paper-listbox' );
          // update the path
          if(oldListBox.selected === 0){
            // if click up
            this.pop('path');
          }
          else{
            // else go down!
            // index 0 it to top directory
            this.push('path', oldListBox.selected - 1);
          }

          // need to call set for callbacks to be triggerred
          this.set('path', this.path );
          this.fire('path-changed');

          // access current path
          var files = this.data.files;
          var images = this.data.images;
          var parentLabel = '';

          // get images/files and parent label of target location
          for( var i=0; i<this.path.length; i++ ){

            fileIndex = this.path[i];
            images = files[fileIndex].images;
            parentLabel = files[fileIndex].label;
            files = files[fileIndex].files;

          }

          // if we have files or images, show it!
          if( files || images ){

            // create new node
            var listbox = this.fillListBox( depth + 1, files, images);

            // prepend button to go top
            var upItem = this.createUpItem( parentLabel );
            var beforeNode = Polymer.dom(listbox).firstChild;
            Polymer.dom(listbox).insertBefore(upItem, beforeNode)

            Polymer.dom( this.$.rowsView ).removeChild( oldListBox );
            Polymer.dom( this.$.rowsView ).appendChild( listbox );

          }

          this.$.rowsView.scrollTop = 0;
        }

    });
  </script>
</dom-module>
