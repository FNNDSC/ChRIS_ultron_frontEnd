<!--
@license
Copyright (c) 2016 FNNDSC. All rights reserved.
-->

<link rel="import" href="../../../bower_components/polymer/polymer.html">

<!-- IRON ELEMENTS -->
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/iron-icons/editor-icons.html">
<link rel="import" href="../../../bower_components/iron-selector/iron-selector.html">

<!-- PAPER ELEMENTS -->
<link rel="import" href="../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../../bower_components/paper-listbox/paper-listbox.html">

<!-- CHRIS ELEMENTS -->
<link rel="import" href="../chris-dataviews-behaviors/chris-dataviews-behaviors.html">

<dom-module id="chris-dataviews-columns">
  <template>

    <style include="iron-flex iron-flex-alignment">

      #columnsView{

        width:100%;
        overflow-x: scroll;
        border: 1px solid var(--primary-text-color);

      }

      #columnsView paper-listbox{

        border-right: 1px solid var(--paper-grey-100);
        min-width: 128px;
        overflow-y: scroll;
        max-height: 300px;

      }

      iron-icon {

        margin-right: 2px;

      }

      paper-item {

        --paper-item: {

          cursor: pointer;

        };

      }

      paper-item[type="folder"] iron-icon{

        --iron-icon-stroke-color: var(--primary-color);
        --iron-icon-fill-color: var(--paper-grey-100);

      }

      paper-item[type="file"] iron-icon{

        --iron-icon-stroke-color: var(--accent-color);
        --iron-icon-fill-color: var(--paper-grey-100);

      }

      #columnsView paper-item{

        min-height:32px;
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
        display:block;
        --paper-item-selected: {
          color: var(--primary-color);
        };

      }

      #columnsView paper-listbox:last-child {

        flex-grow:0;
        flex-shrink:0;

      }

    </style>

    <div id="columnsView" class="layout horizontal">

      <paper-listbox depth="0" on-iron-select="_selectionChanged">

        <!-- show folders -->
        <template is="dom-repeat" items="{{data.files}}" as="file">
          <paper-item type="folder"> <iron-icon icon="icons:folder"></iron-icon>[[file.label]]</paper-item>
        </template>

        <!-- show files -->
        <template is="dom-repeat" items="{{data.images}}" as="image">
          <paper-item type="file"> <iron-icon icon="editor:insert-drive-file"></iron-icon>[[image.label]]</paper-item>
        </template>

      </paper-listbox>

    </div>

  </template>

  <script>
    Polymer({
        is: 'chris-dataviews-columns',

        behaviors: [
          Dataviews
        ],

        _pathChanged: function(){

          console.log( 'columns path changed');
          console.log( this.path );

        },

        _selectionChanged: function( evt ){

          var depth = parseInt( evt.target.attributes.depth.nodeValue, 10 );
          var type = evt.target.selectedItem.attributes.type.nodeValue;

          // delete child nodes after
          var childNodes = Polymer.dom( this.$.columnsView ).querySelectorAll( 'paper-listbox' );

          // clean DOM
          for( var i= depth + 1; i < childNodes.length; i++ ){

            Polymer.dom( this.$.columnsView ).removeChild( childNodes[i] );

          }

          if( type === 'file' ){

            // we are done!
            return;

          }

          // get next files
          // if any.. if not it is a file...
          // check what do we got here
          var fileIndex = childNodes[0].selected;
          var files = this.data.files[fileIndex].files;
          var images = this.data.files[fileIndex].images;
          var path = [fileIndex];

          for( var i=1; i<depth + 1; i++ ){

            path.push(childNodes[i].selected);
            fileIndex = childNodes[i].selected;
            images = files[fileIndex].images;
            files = files[fileIndex].files;

          }

          this.set('path', path);
          this.fire('path-changed');

          if( files || images ){

            var listbox = this.fillListBox( depth + 1, files, images);
            Polymer.dom( this.$.columnsView ).appendChild( listbox );

          }

          // force scroll to the right
          // proper value should be set
          this.$.columnsView.scrollLeft = 9999999;

        }
    });
  </script>
</dom-module>
