<!--
@license
Copyright (c) 2016 FNNDSC. All rights reserved.
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/iron-selector/iron-selector.html">

<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">

<!-- STYLES... -->
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<dom-module id="chris-dataview-rows">

  <template>

    <style include="iron-flex iron-flex-alignment">
:host {
        display: flex;
        flex:1;
      }

      #macview{
        width:100%;
        overflow-x: scroll;
      }
      #macview paper-listbox{
        border-right: 1px solid var(--paper-red-100);
        overflow-y: scroll;
        min-height: 300px;
        max-height: 300px;
      }

      iron-icon {
        margin-right: 2px;
        /*margin-top: -3px;*/
      }

      paper-item[type="folder"] iron-icon{
        --iron-icon-stroke-color: var(--paper-blue-500);
        --iron-icon-fill-color: var(--paper-grey-100);
      }

      paper-item[type="folder"][up] iron-icon{
        --iron-icon-stroke-color: var(--paper-grey-500);
        --iron-icon-fill-color: var(--paper-grey-500);
      }

      paper-item[type="folder"][up] {
        color: var(--paper-grey-500);;
      }

      paper-item[type="file"] iron-icon{
        --iron-icon-stroke-color: var(--paper-pink-a200);
        --iron-icon-fill-color: var(--paper-grey-100);
      }

      #macview paper-item{
        min-height:32px;
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
        display:block;
        --paper-item-selected: {
        color: var(--paper-blue-500);
        };

      }
    <style>

    </style>

      <div id="macview">
        <paper-listbox depth="0" on-iron-select="selectionChanged">
          <paper-item type="folder" up> <iron-icon icon="icons:more-horiz"></iron-icon></paper-item>
          <template is="dom-repeat" items="{{data.files}}" as="file">
            <paper-item type="folder"> <iron-icon icon="icons:folder"></iron-icon> [[file.label]]</paper-item>
          </template>
          <template is="dom-repeat" items="{{data.images}}" as="image">
            <paper-item type="file"> <iron-icon icon="editor:insert-drive-file"></iron-icon> [[image.label]]</paper-item>
          </template>
        </paper-listbox>
      </div>

  </template>

  <script>
    Polymer({
        is: 'chris-dataview-rows',
        properties: {
          data: {
            type: Object
          },
          path: {
            type: Array,
            value: []
          }
        },
        donothing: function(evt){
          evt.stopPropagation();
          // evt.preventDefault();
        },
        selectionChanged: function(evt){
          // evt.stopPropagation();
          evt.preventDefault();

          var depth = parseInt(evt.target.attributes.depth.nodeValue, 10);
          var type = evt.target.selectedItem.attributes.type.nodeValue;
          var childNodes = Polymer.dom(this.$.macview).querySelectorAll('paper-listbox');

          if(type === 'file'){
            // we are done!
            return;
          }

          if(childNodes[0].selected === 0){
            // if click up
            this.pop('path');
          }
          else{
            // else go down!
            // index 0 it to top directory
            this.push('path', childNodes[0].selected - 1);
          }

          // access current path
          var files = this.data.files;
          var images = this.data.images;
          var parentLabel = '';
          //
          for(var i=0; i<this.path.length; i++){
            fileIndex = this.path[i];
            images = files[fileIndex].images;
            parentLabel = files[fileIndex].label;
            files = files[fileIndex].files;
          }

          window.console.log(files);
          window.console.log(images);

          if( files || images){
            // create new node
            var paperListbox = document.createElement('paper-listbox');
            paperListbox.setAttribute('depth', depth + 1);
            this.listen(paperListbox, 'iron-select', 'selectionChanged');

            // button to go top
            var paperItem = document.createElement('paper-item');
            paperItem.setAttribute('type', 'folder');
            paperItem.setAttribute('up', true);
            var ironIcon = document.createElement('iron-icon');
            ironIcon.setAttribute('icon', 'icons:more-horiz');
            Polymer.dom(paperItem).appendChild(ironIcon);
            var text = document.createTextNode(parentLabel);
            Polymer.dom(paperItem).appendChild(text);
            // paperItem.appendChild = '<iron-icon icon="icons:folder"></iron-icon> ' + files[i].label;

            Polymer.dom(paperListbox).appendChild(paperItem);

            // create child nodes for folders...
            if(files){
              for(var i = 0; i < files.length; i++){
                var paperItem = document.createElement('paper-item');
                paperItem.setAttribute('type', 'folder');
                var ironIcon = document.createElement('iron-icon');
                ironIcon.setAttribute('icon', 'icons:folder');
                Polymer.dom(paperItem).appendChild(ironIcon);
                var text = document.createTextNode(files[i].label);
                Polymer.dom(paperItem).appendChild(text);
                // paperItem.appendChild = '<iron-icon icon="icons:folder"></iron-icon> ' + files[i].label;

                Polymer.dom(paperListbox).appendChild(paperItem);
              }
            }

            // then for images...
            if(images){
              for(var i = 0; i < images.length; i++){
                var paperItem = document.createElement('paper-item');
                paperItem.setAttribute('type', 'file');
                var ironIcon = document.createElement('iron-icon');
                ironIcon.setAttribute('icon', 'editor:insert-drive-file');
                Polymer.dom(paperItem).appendChild(ironIcon);
                var text = document.createTextNode(images[i].label);
                Polymer.dom(paperItem).appendChild(text);
                //paperItem.appendChild = '<iron-icon icon="editor:insert-drive-file"></iron-icon> ' + images[i].label;

                Polymer.dom(paperListbox).appendChild(paperItem);
              }
            }

            Polymer.dom(this.$.macview).removeChild(childNodes[0]);
            Polymer.dom(this.$.macview).appendChild(paperListbox);

          }


          Polymer.dom.flush();
          this.$.macview.scrollTop = 0;
        }
    });
  </script>
</dom-module>
