<!--
@license
Copyright (c) 2016 FNNDSC. All rights reserved.
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/iron-selector/iron-selector.html">

<link rel="import" href="../../bower_components/app-layout/app-toolbar/app-toolbar.html">

<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../../bower_components/paper-radio-group/paper-radio-group.html">

<link rel="import" href="../chris-dataview-columns/chris-dataview-columns.html">
<link rel="import" href="../chris-dataview-grid/chris-dataview-grid.html">
<link rel="import" href="../chris-dataview-plugin/chris-dataview-plugin.html">
<link rel="import" href="../chris-dataview-rows/chris-dataview-rows.html">

<link rel="import" href="../chris-plugin-data/chris-plugin-data.html">
<link rel="import" href="../chris-plugin-create/chris-plugin-create.html">

<!-- STYLE -->
<link rel="import" href="../chris-ultron/chris-ultron-styles.html">

<dom-module id="chris-plugin">

  <template>

    <style include="chris-ultron-styles"></style>
    <style>
      .plugin{
        /*@apply(--layout-vertical);*/
        
        background-color: white;
        /*border: 1px solid #ddd;*/
        cursor: pointer;
        margin: 10px 0;
      }

      .title{
        margin-left:8px;
      }

      paper-icon-button{
        --paper-icon-button-ink-color: var(--paper-grey-300);
      }

      paper-icon-button.views{
        border: 1px solid var(--paper-grey-300);
      }

      .dataview{
        display:none;
      }

      .dataview.iron-selected{
        display: block;
      }

      .views.iron-selected{
        background-color: var(--paper-grey-50);
        color: var(--primary-color);
      }

      iron-selector#buttons {
        display: flex;
      }

    .plugin-toolbar {
        border-bottom: 1px solid var(--paper-grey-300);
        height: 48px;
      }

      .plugin-toolbar .primary.invert {
        background-color: #FFFFFF;
      }

      paper-material {
        @apply(--shadow-none);
      }

      paper-material:hover {
        @apply(--shadow-elevation-2dp);
      }

    </style>

<paper-material elevation=1>
      <div id$="[[plugin.id]]" class="plugin">
        <!-- Toolbar -->
        <div on-tap="toggleView">
        <app-toolbar class="plugin-toolbar">
          <template is="dom-repeat" items="{{plugin.workflow}}">
            <paper-icon-button icon="[[item.icon]]" class$="primary [[item.color]] invert" alt="More options"></paper-icon-button>
          </template>
        
          <div class="title" title>[[plugin.label]]</div>

          <div on-tap="updateView">
          <template is="dom-if" if="{{selected}}">
              <iron-selector id="buttons" selected="0">
              <paper-icon-button class="views" targetView="0" icon="icons:view-week"></paper-icon-button>
              <paper-icon-button class="views" targetView="1" icon="icons:view-headline"></paper-icon-button>
              <paper-icon-button class="views" targetView="2" icon="icons:view-module"></paper-icon-button>
              <paper-icon-button class="views" targetView="3" icon="image:remove-red-eye"></paper-icon-button>
            </iron-selector>
          </template>
          </div>


          <!-- jummping around... -->
          <!--           <paper-menu-button>
            <paper-icon-button icon="icons:more-vert" class="dropdown-trigger"></paper-icon-button>
            <paper-menu class="dropdown-content">
              <paper-item>Run</paper-item>
              <paper-item>Fork</paper-item>
              <paper-item>Merge</paper-item>
            </paper-menu>
          </paper-menu-button> -->

          <paper-icon-button icon="communication:call-split" on-tap="newFeed"></paper-icon-button>
          <paper-icon-button icon="add" alt="More options" on-tap="newPlugin"></paper-icon-button>
        </app-toolbar>
        </div>

        <!-- Data view -->
        <!-- to be loaded on data expand! -->
        <!-- it is slow to load it like that -->
        <!-- <iron-pages id="pages" selected="0"> -->
        <template is="dom-if" if="{{selected}}">
          <iron-selector id="views" selected="0" on-iron-deselect="deselect" on-iron-select="select">
            <chris-dataview-columns class="dataview" data="[[plugin.data]]"></chris-dataview-columns>
            <chris-dataview-rows class="dataview" data="[[plugin.data]]"></chris-dataview-rows>
            <chris-dataview-grid class="dataview" data="[[plugin.data]]"></chris-dataview-grid>
            <chris-dataview-plugin class="dataview" dataview="[[plugin.dataview]]" data="[[plugin.data]]"></chris-dataview-plugin>
          </iron-selector>
        </template>
      </div>

      </paper-material>

  </template>

  <script>
    Polymer({
        is: 'chris-plugin',

        properties: {

          plugin: {
            type: Object
          },

          selected: {
            type: Boolean,
            value: false
          }
          // path to be shared between views to stay at the same location
        },

        toggleView: function( evt ){


          this.donothing(evt);

          this.selected = !this.selected;
          // need to resize the list
          this.fire('resized-content');

        },

        donothing: function( evt ){

          evt.stopPropagation();
          evt.preventDefault();

        },

        newFeed: function( evt ){

          this.donothing(evt);
          // call API
          // get reponse,
          // fire the new feed
          this.fire('newfeed');

        },

        newPlugin: function( evt ){

          this.donothing(evt);
          // call API
          // get reponse,
          // fire the new feed
          this.fire('newplugin', {plugin: this.plugin});

        },

        updateView: function( evt ){

          this.donothing(evt);
          this.$$('#views').selected = this.$$('#buttons').selected;
        },

        deselect: function( evt ){

          evt.detail.item.selected = false;

        },

        select: function( evt ){

          // load plugin view...
          // remove child if any
          // var node = Polymer.dom(this.$.card).querySelector( '.plugin' );
          // if( node ){

          //   Polymer.dom( this.$.card ).removeChild( node );

          // }
          
          // // fetch the plugin!
          // var self = this;
          // Polymer.Base.importHref(
          //   this.plugin.url,
          //   function( evt ){

          //     var plugin = document.createElement( self.plugin.name );
          //     plugin.classList.add( 'plugin' );
          //     Polymer.dom( self.$.card ).appendChild( plugin );

          //   },
          //   function( evt ){

          //     window.console.log( 'oops, something went wrong...' );
          //     window.console.log( evt );

          //   },
          //   true );

          window.console.log(this.plugin);

          evt.detail.item.selected = true;

        }
    });
  </script>
</dom-module>
