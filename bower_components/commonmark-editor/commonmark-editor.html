<html><head><link rel="import" href="../polymer/polymer.html">
<link rel="import" href="./commonmark-editor-import.html">

</head><body><dom-module id="commonmark-editor">
	<template>
		<textarea class="half" id="input" placeholder="{{placeholder}}" on-keyup="keyPressed" on-tap="markSelection" value="{{value::input}}"></textarea>
		<div class="half" id="preview"></div>
		<style>*{box-sizing:border-box;}textarea{width:100%;height:100%;resize:vertical;}.half{float:left;width:50%;height:400px;}::content.selected{background-color:var(--preview-text-highlight, lightblue);}#preview{padding-left:var(--editor-preview-padding, 5px);overflow:scroll;resize:vertical;}@media only screen and (max-width: 768px){.half{float:left;width:100%;height:400px;}}</style>
	</template>
	<script>Polymer({is:"commonmark-editor",created:function(){this.reader=new commonmark.Parser,this.writer=new commonmark.HtmlRenderer({sourcepos:!0})},ready:function(){var e=Polymer.dom(this).textContent;e&&this.initValue(e),this.$.input.style.height=this.height,this.$.preview.style.height=this.height},properties:{height:{type:String,value:"400px"},placeholder:{type:String,value:"Markdown content"},workingDir:String,value:{type:String,observer:"inputChangeAction",notify:!0},changedByUser:{type:Boolean,readOnly:!0,notify:!0,"default":!1}},initValue:function(e){this.$.input.value=e,this.inputChangeAction(e),this._setChangedByUser(!1)},inputChangeAction:function(e){var i=this.$.input;this.debounce("inputChangeAction",function(){if(this.cachedSrc!==i.value){this.cachedSrc=i.value;var e=this.reader.parse(this.cachedSrc);this.workingDir&&(e=this._fixPlainImageLink(e,this._addMissingSlash(this.workingDir))),this.$.preview.innerHTML=this.writer.render(e)}this.markSelection()},500)},keyPressed:function(e){var i=this.$.input;this.changedByUser||this._setChangedByUser(this.cachedSrc!==i.value),this.inputChangeAction(!1)},markSelection:function(){var e=this._getLineToPreview(),i=this.$.preview,t=i.querySelector("*[data-sourcepos^='"+e+":']");this._highlightInPreview(t)},_highlightInPreview:function(e){this.cacheHighlightedNode!==e&&(e?(this.cacheHighlightedNode&&this.cacheHighlightedNode.classList.remove("selected"),preview.scrollTop=e.offsetTop-preview.offsetHeight/2,e.classList.add("selected"),this.cacheHighlightedNode=e):this.cacheHighlightedNode&&(this.cacheHighlightedNode.classList.remove("selected"),delete this.cacheHighlightedNode))},_getLineToPreview:function(){var e=this.$.input,i=e.selectionStart;i+1<e.value.length&&i++;var t=this._trimRightSpacesNewline(e.value.substr(0,i)),n=this._numberOfLine(t);return n},_numberOfLine:function(e){return(e.match(/\n/g)||[]).length+1},_trimRightSpacesNewline:function(e){var i=/( |\n)+$/g,t=e.replace(i,"");return t},_fixPlainImageLink:function(e,i){for(var t,n,h=e.walker();t=h.next();)if(n=t.node,"Image"===n.type&&t.entering){var r=n.destination;r.indexOf("/")<=-1&&(n.destination=i+r)}return e},_addMissingSlash:function(e){return"/"!==e.charAt(e.length-1)?e+"/":e}});</script>

</dom-module>
</body></html>