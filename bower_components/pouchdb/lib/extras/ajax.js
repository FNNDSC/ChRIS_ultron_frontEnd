"use strict";function _interopDefault(r){return r&&"object"==typeof r&&"default"in r?r["default"]:r}function PouchError(r){Error.call(this,r.reason),this.status=r.status,this.name=r.error,this.message=r.reason,this.error=!0}function createError(r,e,t){function n(e){for(var n in r)"function"!=typeof r[n]&&(this[n]=r[n]);void 0!==t&&(this.name=t),void 0!==e&&(this.reason=e)}return n.prototype=PouchError.prototype,new n(e)}function generateErrorFromResponse(r){var e,t,n,o,s;return t=r.error===!0&&"string"==typeof r.name?r.name:r.error,s=r.reason,n=getErrorTypeByProp("name",t,s),r.missing||"missing"===s||"deleted"===s||"not_found"===t?n=MISSING_DOC:"doc_validation"===t?(n=DOC_VALIDATION,o=s):"bad_request"===t&&n.message!==s&&(n=BAD_REQUEST),n||(n=getErrorTypeByProp("status",r.status,s)||UNKNOWN_ERROR),e=createError(n,s,t),o&&(e.message=o),r.id&&(e.id=r.id),r.status&&(e.status=r.status),r.missing&&(e.missing=r.missing),e}function isBinaryObject(r){return r instanceof Buffer}function cloneBinaryObject(r){var e=new Buffer(r.length);return r.copy(e),e}function isPlainObject(r){var e=Object.getPrototypeOf(r);if(null===e)return!0;var t=e.constructor;return"function"==typeof t&&t instanceof t&&funcToString.call(t)==objectCtorString}function clone(r){var e,t,n;if(!r||"object"!=typeof r)return r;if(Array.isArray(r)){for(e=[],t=0,n=r.length;n>t;t++)e[t]=clone(r[t]);return e}if(r instanceof Date)return r.toISOString();if(isBinaryObject(r))return cloneBinaryObject(r);if(!isPlainObject(r))return r;e={};for(t in r)if(Object.prototype.hasOwnProperty.call(r,t)){var o=clone(r[t]);"undefined"!=typeof o&&(e[t]=o)}return e}function pick(r,e){for(var t={},n=0,o=e.length;o>n;n++){var s=e[n];s in r&&(t[s]=r[s])}return t}function isChromeApp(){return!1}function hasLocalStorage(){return!1}function attachBrowserEvents(r){isChromeApp()?chrome.storage.onChanged.addListener(function(e){null!=e.db_name&&r.emit(e.dbName.newValue)}):hasLocalStorage()&&("undefined"!=typeof addEventListener?addEventListener("storage",function(e){r.emit(e.key)}):window.attachEvent("storage",function(e){r.emit(e.key)}))}function Changes(){events.EventEmitter.call(this),this._listeners={},attachBrowserEvents(this)}function applyTypeToBuffer(r,e){r.type=e.headers["content-type"]}function defaultBody(){return new Buffer("","binary")}function ajaxCore(r,e){function t(e,t,n){if(!r.binary&&r.json&&"string"==typeof e)try{e=JSON.parse(e)}catch(o){return n(o)}Array.isArray(e)&&(e=e.map(function(r){return r.error||r.missing?generateErrorFromResponse(r):r})),r.binary&&applyTypeToBuffer(e,t),n(null,e,t)}function n(r,e){var t,n;if(r.code&&r.status){var o=new Error(r.message||r.code);return o.status=r.status,e(o)}if(r.message&&"ETIMEDOUT"===r.message)return e(r);try{t=JSON.parse(r.responseText),n=generateErrorFromResponse(t)}catch(s){n=generateErrorFromResponse(r)}e(n)}r=clone(r);var o={method:"GET",headers:{},json:!0,processData:!0,timeout:1e4,cache:!1};return r=jsExtend.extend(o,r),r.json&&(r.binary||(r.headers.Accept="application/json"),r.headers["Content-Type"]=r.headers["Content-Type"]||"application/json"),r.binary&&(r.encoding=null,r.json=!1),r.processData||(r.json=!1),request(r,function(o,s,a){if(o)return o.status=s?s.statusCode:400,n(o,e);var i,u=s.headers&&s.headers["content-type"],c=a||defaultBody();if(!r.binary&&(r.json||!r.processData)&&"object"!=typeof c&&(/json/.test(u)||/^[\s]*\{/.test(c)&&/\}[\s]*$/.test(c)))try{c=JSON.parse(c.toString())}catch(d){}s.statusCode>=200&&s.statusCode<300?t(c,s,e):(i=generateErrorFromResponse(c),i.status=s.statusCode,e(i))})}function ajax(r,e){return ajaxCore(r,e)}var jsExtend=require("js-extend"),inherits=_interopDefault(require("inherits")),lie=_interopDefault(require("lie")),getArguments=_interopDefault(require("argsarray")),debug=_interopDefault(require("debug")),events=require("events"),request=require("request");inherits(PouchError,Error),PouchError.prototype.toString=function(){return JSON.stringify({status:this.status,name:this.name,message:this.message,reason:this.reason})};var UNAUTHORIZED=new PouchError({status:401,error:"unauthorized",reason:"Name or password is incorrect."}),MISSING_BULK_DOCS=new PouchError({status:400,error:"bad_request",reason:"Missing JSON list of 'docs'"}),MISSING_DOC=new PouchError({status:404,error:"not_found",reason:"missing"}),REV_CONFLICT=new PouchError({status:409,error:"conflict",reason:"Document update conflict"}),INVALID_ID=new PouchError({status:400,error:"invalid_id",reason:"_id field must contain a string"}),MISSING_ID=new PouchError({status:412,error:"missing_id",reason:"_id is required for puts"}),RESERVED_ID=new PouchError({status:400,error:"bad_request",reason:"Only reserved document ids may start with underscore."}),NOT_OPEN=new PouchError({status:412,error:"precondition_failed",reason:"Database not open"}),UNKNOWN_ERROR=new PouchError({status:500,error:"unknown_error",reason:"Database encountered an unknown error"}),BAD_ARG=new PouchError({status:500,error:"badarg",reason:"Some query argument is invalid"}),INVALID_REQUEST=new PouchError({status:400,error:"invalid_request",reason:"Request was invalid"}),QUERY_PARSE_ERROR=new PouchError({status:400,error:"query_parse_error",reason:"Some query parameter is invalid"}),DOC_VALIDATION=new PouchError({status:500,error:"doc_validation",reason:"Bad special document member"}),BAD_REQUEST=new PouchError({status:400,error:"bad_request",reason:"Something wrong with the request"}),NOT_AN_OBJECT=new PouchError({status:400,error:"bad_request",reason:"Document must be a JSON object"}),DB_MISSING=new PouchError({status:404,error:"not_found",reason:"Database not found"}),IDB_ERROR=new PouchError({status:500,error:"indexed_db_went_bad",reason:"unknown"}),WSQ_ERROR=new PouchError({status:500,error:"web_sql_went_bad",reason:"unknown"}),LDB_ERROR=new PouchError({status:500,error:"levelDB_went_went_bad",reason:"unknown"}),FORBIDDEN=new PouchError({status:403,error:"forbidden",reason:"Forbidden by design doc validate_doc_update function"}),INVALID_REV=new PouchError({status:400,error:"bad_request",reason:"Invalid rev format"}),FILE_EXISTS=new PouchError({status:412,error:"file_exists",reason:"The database could not be created, the file already exists."}),MISSING_STUB=new PouchError({status:412,error:"missing_stub"}),INVALID_URL=new PouchError({status:413,error:"invalid_url",reason:"Provided URL is invalid"}),allErrors=[UNAUTHORIZED,MISSING_BULK_DOCS,MISSING_DOC,REV_CONFLICT,INVALID_ID,MISSING_ID,RESERVED_ID,NOT_OPEN,UNKNOWN_ERROR,BAD_ARG,INVALID_REQUEST,QUERY_PARSE_ERROR,DOC_VALIDATION,BAD_REQUEST,NOT_AN_OBJECT,DB_MISSING,WSQ_ERROR,LDB_ERROR,FORBIDDEN,INVALID_REV,FILE_EXISTS,MISSING_STUB,IDB_ERROR,INVALID_URL],getErrorTypeByProp=function(r,e,t){var n=allErrors.filter(function(t){return t[r]===e});return t&&n.filter(function(r){return r.message===t})[0]||n[0]},funcToString=Function.prototype.toString,objectCtorString=funcToString.call(Object),log=debug("pouchdb:api");inherits(Changes,events.EventEmitter),Changes.prototype.addListener=function(r,e,t,n){function o(){function r(){a=!1}if(s._listeners[e]){if(a)return void(a="waiting");a=!0;var i=pick(n,["style","include_docs","attachments","conflicts","filter","doc_ids","view","since","query_params","binary"]);t.changes(i).on("change",function(r){r.seq>n.since&&!n.cancelled&&(n.since=r.seq,n.onChange(r))}).on("complete",function(){"waiting"===a&&setTimeout(function(){o()},0),a=!1}).on("error",r)}}if(!this._listeners[e]){var s=this,a=!1;this._listeners[e]=o,this.on(r,o)}},Changes.prototype.removeListener=function(r,e){e in this._listeners&&events.EventEmitter.prototype.removeListener.call(this,r,this._listeners[e])},Changes.prototype.notifyLocalWindows=function(r){isChromeApp()?chrome.storage.local.set({dbName:r}):hasLocalStorage()&&(localStorage[r]="a"===localStorage[r]?"b":"a")},Changes.prototype.notify=function(r){this.emit(r),this.notifyLocalWindows(r)};var chars="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split("");module.exports=ajax;