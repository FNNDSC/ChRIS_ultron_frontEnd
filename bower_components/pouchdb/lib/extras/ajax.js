"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e["default"]:e}function PouchError(e){Error.call(this,e.reason),this.status=e.status,this.name=e.error,this.message=e.reason,this.error=!0}function generateErrorFromResponse(e){if("object"!=typeof e){var r=e;e=UNKNOWN_ERROR,e.data=r}return"error"in e&&"conflict"===e.error&&(e.name="conflict",e.status=409),"name"in e||(e.name=e.error||"unknown"),"status"in e||(e.status=500),"message"in e||(e.message=e.message||e.reason),e}function isBinaryObject(e){return e instanceof Buffer}function cloneBinaryObject(e){var r=new Buffer(e.length);return e.copy(r),r}function isPlainObject(e){var r=Object.getPrototypeOf(e);if(null===r)return!0;var t=r.constructor;return"function"==typeof t&&t instanceof t&&funcToString.call(t)==objectCtorString}function clone(e){var r,t,n;if(!e||"object"!=typeof e)return e;if(Array.isArray(e)){for(r=[],t=0,n=e.length;n>t;t++)r[t]=clone(e[t]);return r}if(e instanceof Date)return e.toISOString();if(isBinaryObject(e))return cloneBinaryObject(e);if(!isPlainObject(e))return e;r={};for(t in e)if(Object.prototype.hasOwnProperty.call(e,t)){var o=clone(e[t]);"undefined"!=typeof o&&(r[t]=o)}return r}function pick(e,r){for(var t={},n=0,o=r.length;o>n;n++){var s=r[n];s in e&&(t[s]=e[s])}return t}function isChromeApp(){return!1}function hasLocalStorage(){return!1}function attachBrowserEvents(e){isChromeApp()?chrome.storage.onChanged.addListener(function(r){null!=r.db_name&&e.emit(r.dbName.newValue)}):hasLocalStorage()&&("undefined"!=typeof addEventListener?addEventListener("storage",function(r){e.emit(r.key)}):window.attachEvent("storage",function(r){e.emit(r.key)}))}function Changes(){events.EventEmitter.call(this),this._listeners={},attachBrowserEvents(this)}function applyTypeToBuffer(e,r){e.type=r.headers["content-type"]}function defaultBody(){return new Buffer("","binary")}function ajaxCore(e,r){function t(r,t,n){if(!e.binary&&e.json&&"string"==typeof r)try{r=JSON.parse(r)}catch(o){return n(o)}Array.isArray(r)&&(r=r.map(function(e){return e.error||e.missing?generateErrorFromResponse(e):e})),e.binary&&applyTypeToBuffer(r,t),n(null,r,t)}e=clone(e);var n={method:"GET",headers:{},json:!0,processData:!0,timeout:1e4,cache:!1};return e=jsExtend.extend(n,e),e.json&&(e.binary||(e.headers.Accept="application/json"),e.headers["Content-Type"]=e.headers["Content-Type"]||"application/json"),e.binary&&(e.encoding=null,e.json=!1),e.processData||(e.json=!1),request(e,function(n,o,s){if(n)return r(generateErrorFromResponse(n));var a,i=o.headers&&o.headers["content-type"],u=s||defaultBody();if(!e.binary&&(e.json||!e.processData)&&"object"!=typeof u&&(/json/.test(i)||/^[\s]*\{/.test(u)&&/\}[\s]*$/.test(u)))try{u=JSON.parse(u.toString())}catch(c){}o.statusCode>=200&&o.statusCode<300?t(u,o,r):(a=generateErrorFromResponse(u),a.status=o.statusCode,r(a))})}function ajax(e,r){return ajaxCore(e,r)}var jsExtend=require("js-extend"),inherits=_interopDefault(require("inherits")),lie=_interopDefault(require("lie")),getArguments=_interopDefault(require("argsarray")),debug=_interopDefault(require("debug")),events=require("events"),request=require("request");inherits(PouchError,Error),PouchError.prototype.toString=function(){return JSON.stringify({status:this.status,name:this.name,message:this.message,reason:this.reason})};var UNAUTHORIZED=new PouchError({status:401,error:"unauthorized",reason:"Name or password is incorrect."}),MISSING_BULK_DOCS=new PouchError({status:400,error:"bad_request",reason:"Missing JSON list of 'docs'"}),MISSING_DOC=new PouchError({status:404,error:"not_found",reason:"missing"}),REV_CONFLICT=new PouchError({status:409,error:"conflict",reason:"Document update conflict"}),INVALID_ID=new PouchError({status:400,error:"bad_request",reason:"_id field must contain a string"}),MISSING_ID=new PouchError({status:412,error:"missing_id",reason:"_id is required for puts"}),RESERVED_ID=new PouchError({status:400,error:"bad_request",reason:"Only reserved document ids may start with underscore."}),NOT_OPEN=new PouchError({status:412,error:"precondition_failed",reason:"Database not open"}),UNKNOWN_ERROR=new PouchError({status:500,error:"unknown_error",reason:"Database encountered an unknown error"}),BAD_ARG=new PouchError({status:500,error:"badarg",reason:"Some query argument is invalid"}),INVALID_REQUEST=new PouchError({status:400,error:"invalid_request",reason:"Request was invalid"}),QUERY_PARSE_ERROR=new PouchError({status:400,error:"query_parse_error",reason:"Some query parameter is invalid"}),DOC_VALIDATION=new PouchError({status:500,error:"doc_validation",reason:"Bad special document member"}),BAD_REQUEST=new PouchError({status:400,error:"bad_request",reason:"Something wrong with the request"}),NOT_AN_OBJECT=new PouchError({status:400,error:"bad_request",reason:"Document must be a JSON object"}),DB_MISSING=new PouchError({status:404,error:"not_found",reason:"Database not found"}),IDB_ERROR=new PouchError({status:500,error:"indexed_db_went_bad",reason:"unknown"}),WSQ_ERROR=new PouchError({status:500,error:"web_sql_went_bad",reason:"unknown"}),LDB_ERROR=new PouchError({status:500,error:"levelDB_went_went_bad",reason:"unknown"}),FORBIDDEN=new PouchError({status:403,error:"forbidden",reason:"Forbidden by design doc validate_doc_update function"}),INVALID_REV=new PouchError({status:400,error:"bad_request",reason:"Invalid rev format"}),FILE_EXISTS=new PouchError({status:412,error:"file_exists",reason:"The database could not be created, the file already exists."}),MISSING_STUB=new PouchError({status:412,error:"missing_stub"}),INVALID_URL=new PouchError({status:413,error:"invalid_url",reason:"Provided URL is invalid"}),funcToString=Function.prototype.toString,objectCtorString=funcToString.call(Object),log=debug("pouchdb:api");inherits(Changes,events.EventEmitter),Changes.prototype.addListener=function(e,r,t,n){function o(){function e(){a=!1}if(s._listeners[r]){if(a)return void(a="waiting");a=!0;var i=pick(n,["style","include_docs","attachments","conflicts","filter","doc_ids","view","since","query_params","binary"]);t.changes(i).on("change",function(e){e.seq>n.since&&!n.cancelled&&(n.since=e.seq,n.onChange(e))}).on("complete",function(){"waiting"===a&&setTimeout(function(){o()},0),a=!1}).on("error",e)}}if(!this._listeners[r]){var s=this,a=!1;this._listeners[r]=o,this.on(e,o)}},Changes.prototype.removeListener=function(e,r){r in this._listeners&&events.EventEmitter.prototype.removeListener.call(this,e,this._listeners[r])},Changes.prototype.notifyLocalWindows=function(e){isChromeApp()?chrome.storage.local.set({dbName:e}):hasLocalStorage()&&(localStorage[e]="a"===localStorage[e]?"b":"a")},Changes.prototype.notify=function(e){this.emit(e),this.notifyLocalWindows(e)};var chars="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split("");module.exports=ajax;