"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e["default"]:e}function createBlob(e,r){e=e||[],r=r||{};try{return new Blob(e,r)}catch(t){if("TypeError"!==t.name)throw t;for(var n="undefined"!=typeof BlobBuilder?BlobBuilder:"undefined"!=typeof MSBlobBuilder?MSBlobBuilder:"undefined"!=typeof MozBlobBuilder?MozBlobBuilder:WebKitBlobBuilder,o=new n,s=0;s<e.length;s+=1)o.append(e[s]);return o.getBlob(r.type)}}function readAsArrayBuffer(e,r){if("undefined"==typeof FileReader)return r((new FileReaderSync).readAsArrayBuffer(e));var t=new FileReader;t.onloadend=function(e){var t=e.target.result||new ArrayBuffer(0);r(t)},t.readAsArrayBuffer(e)}function wrappedFetch(){for(var e={},r=new PouchPromise(function(r,t){e.resolve=r,e.reject=t}),t=new Array(arguments.length),n=0;n<t.length;n++)t[n]=arguments[n];return e.promise=r,PouchPromise.resolve().then(function(){return fetch.apply(null,t)}).then(function(r){e.resolve(r)})["catch"](function(r){e.reject(r)}),e}function fetchRequest(e,r){var t,n,o,s=new Headers,a={method:e.method,credentials:"include",headers:s};return e.json&&(s.set("Accept","application/json"),s.set("Content-Type",e.headers["Content-Type"]||"application/json")),e.body&&e.body instanceof Blob?readAsArrayBuffer(e.body,function(e){a.body=e}):e.body&&e.processData&&"string"!=typeof e.body?a.body=JSON.stringify(e.body):"body"in e?a.body=e.body:a.body=null,Object.keys(e.headers).forEach(function(r){e.headers.hasOwnProperty(r)&&s.set(r,e.headers[r])}),t=wrappedFetch(e.url,a),e.timeout>0&&(n=setTimeout(function(){t.reject(new Error("Load timeout for resource: "+e.url))},e.timeout)),t.promise.then(function(r){return o={statusCode:r.status},e.timeout>0&&clearTimeout(n),o.statusCode>=200&&o.statusCode<300?e.binary?r.blob():r.text():r.json()}).then(function(e){o.statusCode>=200&&o.statusCode<300?r(null,o,e):r(e,o)})["catch"](function(e){r(e,o)}),{abort:t.reject}}function xhRequest(e,r){var t,n,o=!1,s=function(){t.abort()},a=function(){o=!0,t.abort()};t=e.xhr?new e.xhr:new XMLHttpRequest;try{t.open(e.method,e.url)}catch(i){r(i,{statusCode:413})}t.withCredentials="withCredentials"in e?e.withCredentials:!0,"GET"===e.method?delete e.headers["Content-Type"]:e.json&&(e.headers.Accept="application/json",e.headers["Content-Type"]=e.headers["Content-Type"]||"application/json",e.body&&e.processData&&"string"!=typeof e.body&&(e.body=JSON.stringify(e.body))),e.binary&&(t.responseType="arraybuffer"),"body"in e||(e.body=null);for(var u in e.headers)e.headers.hasOwnProperty(u)&&t.setRequestHeader(u,e.headers[u]);return e.timeout>0&&(n=setTimeout(a,e.timeout),t.onprogress=function(){clearTimeout(n),4!==t.readyState&&(n=setTimeout(a,e.timeout))},"undefined"!=typeof t.upload&&(t.upload.onprogress=t.onprogress)),t.onreadystatechange=function(){if(4===t.readyState){var n={statusCode:t.status};if(t.status>=200&&t.status<300){var s;s=e.binary?createBlob([t.response||""],{type:t.getResponseHeader("Content-Type")}):t.responseText,r(null,n,s)}else{var a={};if(o)a=new Error("ETIMEDOUT"),n.statusCode=400;else try{a=JSON.parse(t.response)}catch(i){}r(a,n)}}},e.body&&e.body instanceof Blob?readAsArrayBuffer(e.body,function(e){t.send(e)}):t.send(e.body),{abort:s}}function testXhr(){try{return new XMLHttpRequest,!0}catch(e){return!1}}function ajax$1(e,r){return hasXhr||e.xhr?xhRequest(e,r):fetchRequest(e,r)}function PouchError(e){Error.call(this,e.reason),this.status=e.status,this.name=e.error,this.message=e.reason,this.error=!0}function createError(e,r,t){function n(r){for(var n in e)"function"!=typeof e[n]&&(this[n]=e[n]);void 0!==t&&(this.name=t),void 0!==r&&(this.reason=r)}return n.prototype=PouchError.prototype,new n(r)}function generateErrorFromResponse(e){var r,t,n,o,s;return t=e.error===!0&&"string"==typeof e.name?e.name:e.error,s=e.reason,n=getErrorTypeByProp("name",t,s),e.missing||"missing"===s||"deleted"===s||"not_found"===t?n=MISSING_DOC:"doc_validation"===t?(n=DOC_VALIDATION,o=s):"bad_request"===t&&n.message!==s&&(n=BAD_REQUEST),n||(n=getErrorTypeByProp("status",e.status,s)||UNKNOWN_ERROR),r=createError(n,s,t),o&&(r.message=o),e.id&&(r.id=e.id),e.status&&(r.status=e.status),e.missing&&(r.missing=e.missing),r}function isBinaryObject(e){return e instanceof ArrayBuffer||"undefined"!=typeof Blob&&e instanceof Blob}function cloneArrayBuffer(e){if("function"==typeof e.slice)return e.slice(0);var r=new ArrayBuffer(e.byteLength),t=new Uint8Array(r),n=new Uint8Array(e);return t.set(n),r}function cloneBinaryObject(e){if(e instanceof ArrayBuffer)return cloneArrayBuffer(e);var r=e.size,t=e.type;return"function"==typeof e.slice?e.slice(0,r,t):e.webkitSlice(0,r,t)}function isPlainObject(e){var r=Object.getPrototypeOf(e);if(null===r)return!0;var t=r.constructor;return"function"==typeof t&&t instanceof t&&funcToString.call(t)==objectCtorString}function clone(e){var r,t,n;if(!e||"object"!=typeof e)return e;if(Array.isArray(e)){for(r=[],t=0,n=e.length;n>t;t++)r[t]=clone(e[t]);return r}if(e instanceof Date)return e.toISOString();if(isBinaryObject(e))return cloneBinaryObject(e);if(!isPlainObject(e))return e;r={};for(t in e)if(Object.prototype.hasOwnProperty.call(e,t)){var o=clone(e[t]);"undefined"!=typeof o&&(r[t]=o)}return r}function pick(e,r){for(var t={},n=0,o=r.length;o>n;n++){var s=r[n];s in e&&(t[s]=e[s])}return t}function isChromeApp(){return"undefined"!=typeof chrome&&"undefined"!=typeof chrome.storage&&"undefined"!=typeof chrome.storage.local}function hasLocalStorage(){return hasLocal}function attachBrowserEvents(e){isChromeApp()?chrome.storage.onChanged.addListener(function(r){null!=r.db_name&&e.emit(r.dbName.newValue)}):hasLocalStorage()&&("undefined"!=typeof addEventListener?addEventListener("storage",function(r){e.emit(r.key)}):window.attachEvent("storage",function(r){e.emit(r.key)}))}function Changes(){events.EventEmitter.call(this),this._listeners={},attachBrowserEvents(this)}function defaultBody(){return""}function ajaxCore(e,r){function t(r,t,n){if(!e.binary&&e.json&&"string"==typeof r)try{r=JSON.parse(r)}catch(o){return n(o)}Array.isArray(r)&&(r=r.map(function(e){return e.error||e.missing?generateErrorFromResponse(e):e})),e.binary&&res$2(r,t),n(null,r,t)}function n(e,r){var t,n;if(e.code&&e.status){var o=new Error(e.message||e.code);return o.status=e.status,r(o)}if(e.message&&"ETIMEDOUT"===e.message)return r(e);try{t=JSON.parse(e.responseText),n=generateErrorFromResponse(t)}catch(s){n=generateErrorFromResponse(e)}r(n)}e=clone(e);var o={method:"GET",headers:{},json:!0,processData:!0,timeout:1e4,cache:!1};return e=jsExtend.extend(o,e),e.json&&(e.binary||(e.headers.Accept="application/json"),e.headers["Content-Type"]=e.headers["Content-Type"]||"application/json"),e.binary&&(e.encoding=null,e.json=!1),e.processData||(e.json=!1),ajax$1(e,function(o,s,a){if(o)return o.status=s?s.statusCode:400,n(o,r);var i,u=s.headers&&s.headers["content-type"],c=a||defaultBody();if(!e.binary&&(e.json||!e.processData)&&"object"!=typeof c&&(/json/.test(u)||/^[\s]*\{/.test(c)&&/\}[\s]*$/.test(c)))try{c=JSON.parse(c.toString())}catch(d){}s.statusCode>=200&&s.statusCode<300?t(c,s,r):(i=generateErrorFromResponse(c),i.status=s.statusCode,r(i))})}function ajax(e,r){var t=navigator&&navigator.userAgent?navigator.userAgent.toLowerCase():"",n=-1!==t.indexOf("safari")&&-1===t.indexOf("chrome"),o=-1!==t.indexOf("msie"),s=-1!==t.indexOf("edge"),a=n||(o||s)&&"GET"===e.method,i="cache"in e?e.cache:!0,u=/^blob:/.test(e.url);if(!u&&(a||!i)){var c=-1!==e.url.indexOf("?");e.url+=(c?"&":"?")+"_nonce="+Date.now()}return ajaxCore(e,r)}var lie=_interopDefault(require("lie")),jsExtend=require("js-extend"),inherits=_interopDefault(require("inherits")),getArguments=_interopDefault(require("argsarray")),debug=_interopDefault(require("debug")),events=require("events"),PouchPromise="function"==typeof Promise?Promise:lie,hasXhr=testXhr();inherits(PouchError,Error),PouchError.prototype.toString=function(){return JSON.stringify({status:this.status,name:this.name,message:this.message,reason:this.reason})};var UNAUTHORIZED=new PouchError({status:401,error:"unauthorized",reason:"Name or password is incorrect."}),MISSING_BULK_DOCS=new PouchError({status:400,error:"bad_request",reason:"Missing JSON list of 'docs'"}),MISSING_DOC=new PouchError({status:404,error:"not_found",reason:"missing"}),REV_CONFLICT=new PouchError({status:409,error:"conflict",reason:"Document update conflict"}),INVALID_ID=new PouchError({status:400,error:"invalid_id",reason:"_id field must contain a string"}),MISSING_ID=new PouchError({status:412,error:"missing_id",reason:"_id is required for puts"}),RESERVED_ID=new PouchError({status:400,error:"bad_request",reason:"Only reserved document ids may start with underscore."}),NOT_OPEN=new PouchError({status:412,error:"precondition_failed",reason:"Database not open"}),UNKNOWN_ERROR=new PouchError({status:500,error:"unknown_error",reason:"Database encountered an unknown error"}),BAD_ARG=new PouchError({status:500,error:"badarg",reason:"Some query argument is invalid"}),INVALID_REQUEST=new PouchError({status:400,error:"invalid_request",reason:"Request was invalid"}),QUERY_PARSE_ERROR=new PouchError({status:400,error:"query_parse_error",reason:"Some query parameter is invalid"}),DOC_VALIDATION=new PouchError({status:500,error:"doc_validation",reason:"Bad special document member"}),BAD_REQUEST=new PouchError({status:400,error:"bad_request",reason:"Something wrong with the request"}),NOT_AN_OBJECT=new PouchError({status:400,error:"bad_request",reason:"Document must be a JSON object"}),DB_MISSING=new PouchError({status:404,error:"not_found",reason:"Database not found"}),IDB_ERROR=new PouchError({status:500,error:"indexed_db_went_bad",reason:"unknown"}),WSQ_ERROR=new PouchError({status:500,error:"web_sql_went_bad",reason:"unknown"}),LDB_ERROR=new PouchError({status:500,error:"levelDB_went_went_bad",reason:"unknown"}),FORBIDDEN=new PouchError({status:403,error:"forbidden",reason:"Forbidden by design doc validate_doc_update function"}),INVALID_REV=new PouchError({status:400,error:"bad_request",reason:"Invalid rev format"}),FILE_EXISTS=new PouchError({status:412,error:"file_exists",reason:"The database could not be created, the file already exists."}),MISSING_STUB=new PouchError({status:412,error:"missing_stub"}),INVALID_URL=new PouchError({status:413,error:"invalid_url",reason:"Provided URL is invalid"}),allErrors=[UNAUTHORIZED,MISSING_BULK_DOCS,MISSING_DOC,REV_CONFLICT,INVALID_ID,MISSING_ID,RESERVED_ID,NOT_OPEN,UNKNOWN_ERROR,BAD_ARG,INVALID_REQUEST,QUERY_PARSE_ERROR,DOC_VALIDATION,BAD_REQUEST,NOT_AN_OBJECT,DB_MISSING,WSQ_ERROR,LDB_ERROR,FORBIDDEN,INVALID_REV,FILE_EXISTS,MISSING_STUB,IDB_ERROR,INVALID_URL],getErrorTypeByProp=function(e,r,t){var n=allErrors.filter(function(t){return t[e]===r});return t&&n.filter(function(e){return e.message===t})[0]||n[0]},funcToString=Function.prototype.toString,objectCtorString=funcToString.call(Object),log=debug("pouchdb:api"),hasLocal;if(isChromeApp())hasLocal=!1;else try{localStorage.setItem("_pouch_check_localstorage",1),hasLocal=!!localStorage.getItem("_pouch_check_localstorage")}catch(e){hasLocal=!1}inherits(Changes,events.EventEmitter),Changes.prototype.addListener=function(e,r,t,n){function o(){function e(){a=!1}if(s._listeners[r]){if(a)return void(a="waiting");a=!0;var i=pick(n,["style","include_docs","attachments","conflicts","filter","doc_ids","view","since","query_params","binary"]);t.changes(i).on("change",function(e){e.seq>n.since&&!n.cancelled&&(n.since=e.seq,n.onChange(e))}).on("complete",function(){"waiting"===a&&setTimeout(function(){o()},0),a=!1}).on("error",e)}}if(!this._listeners[r]){var s=this,a=!1;this._listeners[r]=o,this.on(e,o)}},Changes.prototype.removeListener=function(e,r){r in this._listeners&&events.EventEmitter.prototype.removeListener.call(this,e,this._listeners[r])},Changes.prototype.notifyLocalWindows=function(e){isChromeApp()?chrome.storage.local.set({dbName:e}):hasLocalStorage()&&(localStorage[e]="a"===localStorage[e]?"b":"a")},Changes.prototype.notify=function(e){this.emit(e),this.notifyLocalWindows(e)};var chars="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),res$2=function(){};module.exports=ajax;