<html><head><link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../app-storage/app-storage-behavior.html">
<link rel="import" href="app-pouchdb-database-behavior.html">
<link rel="import" href="pouchdb.html">


<script>!function(){"use strict";Polymer({is:"app-pouchdb-document",behaviors:[Polymer.AppStorageBehavior,Polymer.AppPouchDBDatabaseBehavior],properties:{docId:{type:String,value:null},rev:{type:String,readOnly:!0,value:null},changes:{type:Object,computed:"__computeChanges(db, docId)"}},observers:["__docRevChanged(data._rev)","__docChanged(db, data, docId, _readied)"],get isNew(){return null==this.docId},get zeroValue(){return{}},save:function(){return this.db?(this.docId&&(this.data._id=this.docId),this._upsert("data",this.data,this.data).then(function(t){this.syncToMemory(function(){this.docId=t.id,this.set("data._id",t.id),this.set("data._rev",t.rev)})}.bind(this))):Promise.reject("No PouchDB instance available!")},reset:function(){this.docId=null,this.data=this.zeroValue},destroy:function(){return this.set("data._deleted",!0),this.transactionsComplete.then(function(){return this.reset()})},getStoredValue:function(t){return this.db.get(this.docId).then(function(e){return this.get(t,{data:e})}.bind(this))["catch"](function(t){if(!t||404!==t.status)throw t})},setStoredValue:function(t,e){return"data"===t&&null==e?Promise.reject(["Unsupported attempt to unset PouchDB document by assigning null value.","Perhaps you meant to set `data._deleted = true`?"].join(" ")):this._put(t,e,this.data)},__docChanged:function(t,e,n){this._log("Doc / ID changed",e,n),t&&null!=e&&null!=n&&e._id!=n&&(e._id=n,this._initializeStoredValue())},__docRevChanged:function(){this._setRev(null!=this.data?this.data._rev:null)},__computeChanges:function(t,e){return this.changes&&this.changes.removeAllListeners(),null==t||null==e?null:t.changes({since:"now",live:!0,doc_ids:[e],include_docs:!0}).on("change",function(t){var e=t.doc;this.syncToMemory(function(){this.set("data",e)})}.bind(this))}})}();</script>
</head><body></body></html>