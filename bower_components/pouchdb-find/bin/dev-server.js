#!/usr/bin/env node
"use strict";function bundle(){function e(){fs.rename(dotfile,outfile,function(e){return e?console.error(e):(console.log("Updated:",outfile),filesWritten=!0,void checkReady())})}var r=w.bundle();r.on("error",function(e){console.error(String(e))}),r.on("end",e),r.pipe(fs.createWriteStream(dotfile))}function startServers(e){readyCallback=e,http_server.createServer().listen(HTTP_PORT);var r="Tests: http://127.0.0.1:"+HTTP_PORT+"/test/index.html";process.env.COUCH_HOST&&(r+="?couchHost="+process.env.COUCH_HOST),console.log(r),serverStarted=!0,checkReady()}function checkReady(){filesWritten&&serverStarted&&readyCallback&&readyCallback()}var HTTP_PORT=8001,http_server=require("http-server"),fs=require("fs"),indexfile="./test/test.js",dotfile="./test/.test-bundle.js",outfile="./test/test-bundle.js",watchify=require("watchify"),browserify=require("browserify"),w=watchify(browserify(indexfile,{cache:{},packageCache:{},fullPaths:!0,debug:!0}));w.on("update",bundle),bundle();var filesWritten=!1,serverStarted=!1,readyCallback;require.main===module?startServers():module.exports.start=startServers;