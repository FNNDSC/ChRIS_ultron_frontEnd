"use strict";function stringify(e){if(!e)return"undefined";switch(typeof e){case"function":return e.toString();case"string":return e.toString();default:return JSON.stringify(e)}}var upsert=require("./upsert"),utils=require("./utils"),Promise=utils.Promise;module.exports=function(e){var t=e.db,r=e.viewName,n=e.map,i=e.reduce,u=e.temporary,s=e.pluginName,a=stringify(n)+stringify(i)+"undefined";if(!u&&t._cachedViews){var c=t._cachedViews[a];if(c)return Promise.resolve(c)}return t.info().then(function(e){function c(e){e.views=e.views||{};var t=r;-1===t.indexOf("/")&&(t=r+"/"+r);var n=e.views[t]=e.views[t]||{};if(!n[o])return n[o]=!0,e}var o=e.db_name+"-mrview-"+(u?"temp":utils.MD5(a));return upsert(t,"_local/"+s,c).then(function(){return t.registerDependentDatabase(o).then(function(e){var r=e.db;r.auto_compaction=!0;var s={name:o,db:r,sourceDB:t,adapter:t.adapter,mapFun:n,reduceFun:i};return s.db.get("_local/lastSeq")["catch"](function(e){if(404!==e.status)throw e}).then(function(e){return s.seq=e?e.seq:0,u||(t._cachedViews=t._cachedViews||{},t._cachedViews[a]=s,s.db.on("destroyed",function(){delete t._cachedViews[a]})),s})})})})};