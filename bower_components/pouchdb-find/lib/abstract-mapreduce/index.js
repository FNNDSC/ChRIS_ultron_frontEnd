"use strict";function QueryParseError(e){this.status=400,this.name="query_parse_error",this.message=e,this.error=!0;try{Error.captureStackTrace(this,QueryParseError)}catch(r){}}function NotFoundError(e){this.status=404,this.name="not_found",this.message=e,this.error=!0;try{Error.captureStackTrace(this,NotFoundError)}catch(r){}}function parseViewName(e){return-1===e.indexOf("/")?[e,e]:e.split("/")}function isGenOne(e){return 1===e.length&&/^1-/.test(e[0].rev)}function sortByKeyThenValue(e,r){var n=collate(e.key,r.key);return 0!==n?n:collate(e.value,r.value)}function sliceResults(e,r,n){return n=n||0,"number"==typeof r?e.slice(n,r+n):n>0?e.slice(n):e}function rowToDocId(e){var r=e.value,n=r&&"object"==typeof r&&r._id||e.id;return n}function emitError(e,r){try{e.emit("error",r)}catch(n){console.error("The user's map/reduce function threw an uncaught error.\nYou can debug this error by doing:\nmyDatabase.on('error', function (err) { debugger; });\nPlease double-check your map/reduce function."),console.error(r)}}function tryCode(e,r,n){try{return{output:r.apply(null,n)}}catch(t){return emitError(e,t),{error:t}}}function checkQueryParseError(e,r){var n=e.descending?"endkey":"startkey",t=e.descending?"startkey":"endkey";if("undefined"!=typeof e[n]&&"undefined"!=typeof e[t]&&collate(e[n],e[t])>0)throw new QueryParseError("No rows can match your key range, reverse your start_key and end_key or set {descending : true}");if(r.reduce&&e.reduce!==!1){if(e.include_docs)throw new QueryParseError("{include_docs:true} is invalid for reduce");if(e.keys&&e.keys.length>1&&!e.group&&!e.group_level)throw new QueryParseError("Multi-key fetches for reduce views must use {group: true}")}if(e.group_level){if("number"!=typeof e.group_level)throw new QueryParseError('Invalid value for integer: "'+e.group_level+'"');if(e.group_level<0)throw new QueryParseError('Invalid value for positive integer: "'+e.group_level+'"')}}function defaultsTo(e){return function(r){if(404===r.status)return e;throw r}}function createIndexer(e){function r(e,r,n){function t(){return isGenOne(l)?Promise.resolve(a):r.db.get(i)["catch"](defaultsTo(a))}function o(e){return e.keys.length?r.db.allDocs({keys:e.keys,include_docs:!0}):Promise.resolve({rows:[]})}function u(e,r){for(var n=[],t={},o=0,u=r.rows.length;u>o;o++){var i=r.rows[o],a=i.doc;if(a&&(n.push(a),t[a._id]=!0,a._deleted=!s[a._id],!a._deleted)){var c=s[a._id];"value"in c&&(a.value=c.value)}}var l=Object.keys(s);return l.forEach(function(e){if(!t[e]){var r={_id:e},o=s[e];"value"in o&&(r.value=o.value),n.push(r)}}),e.keys=utils.uniq(l.concat(e.keys)),n.push(e),n}var i="_local/doc_"+e,a={_id:i,keys:[]},c=n[e],s=c.indexableKeysToKeyValues,l=c.changes;return t().then(function(e){return o(e).then(function(r){return u(e,r)})})}function n(e,n,t){var o="_local/lastSeq";return e.db.get(o)["catch"](defaultsTo({_id:o,seq:0})).then(function(o){var u=Object.keys(n);return Promise.all(u.map(function(t){return r(t,e,n)})).then(function(r){var n=utils.flatten(r);return o.seq=t,n.push(o),e.db.bulkDocs({docs:n})})})}function t(e){var r="string"==typeof e?e:e.name,n=persistentQueues[r];return n||(n=persistentQueues[r]=new TaskQueue),n}function o(e){return utils.sequentialize(t(e),function(){return u(e)})()}function u(e){function r(e,r){var n={id:u._id,key:normalizeKey(e)};"undefined"!=typeof r&&null!==r&&(n.value=normalizeKey(r)),o.push(n)}function t(r,t){return function(){return n(e,r,t)}}var o,u,i=f(e.mapFun,r),a=e.seq||0,c=new TaskQueue;return new Promise(function(r,n){function s(){c.finish().then(function(){e.seq=a,r()})}function l(){function r(e){n(e)}e.sourceDB.changes({conflicts:!0,include_docs:!0,style:"all_docs",since:a,limit:CHANGES_BATCH_SIZE}).on("complete",function(r){var n=r.results;if(!n.length)return s();for(var d={},f=0,y=n.length;y>f;f++){var v=n[f];if("_"!==v.doc._id[0]){o=[],u=v.doc,u._deleted||tryCode(e.sourceDB,i,[u]),o.sort(sortByKeyThenValue);for(var h,p={},k=0,g=o.length;g>k;k++){var m=o[k],_=[m.key,m.id];0===collate(m.key,h)&&_.push(k);var w=toIndexableString(_);p[w]=m,h=m.key}d[v.doc._id]={indexableKeysToKeyValues:p,changes:v.changes}}a=v.seq}return c.add(t(d,a)),n.length<CHANGES_BATCH_SIZE?s():l()}).on("error",r)}l()})}function i(e,r,n){0===n.group_level&&delete n.group_level;var t=n.group||n.group_level,o=y(e.reduceFun),u=[],i=n.group_level;r.forEach(function(e){var r=u[u.length-1],n=t?e.key:null;return t&&Array.isArray(n)&&"number"==typeof i&&(n=n.length>i?n.slice(0,i):n),r&&0===collate(r.key[0][0],n)?(r.key.push([n,e.id]),void r.value.push(e.value)):void u.push({key:[[n,e.id]],value:[e.value]})});for(var a=0,c=u.length;c>a;a++){var s=u[a],l=tryCode(e.sourceDB,o,[s.key,s.value,!1]);if(l.error&&/BuiltInError/.test(l.error.constructor))throw l.error;s.value=l.error?null:l.output,s.key=s.key[0][0]}return{rows:sliceResults(u,n.limit,n.skip)}}function a(e,r){return utils.sequentialize(t(e),function(){return c(e,r)})()}function c(e,r){function n(r){return r.include_docs=!0,e.db.allDocs(r).then(function(e){return o=e.total_rows,e.rows.map(function(e){if("value"in e.doc&&"object"==typeof e.doc.value&&null!==e.doc.value){var r=Object.keys(e.doc.value).sort(),n=["id","key","value"];if(!(n>r||r>n))return e.doc.value}var t=pouchCollate.parseIndexableString(e.doc._id);return{key:t[0],id:t[1],value:"value"in e.doc?e.doc.value:null}})})}function t(n){var t;if(t=u?i(e,n,r):{total_rows:o,offset:a,rows:n},r.include_docs){var c=utils.uniq(n.map(rowToDocId));return e.sourceDB.allDocs({keys:c,include_docs:!0,conflicts:r.conflicts,attachments:r.attachments,binary:r.binary}).then(function(e){var r={};return e.rows.forEach(function(e){e.doc&&(r["$"+e.id]=e.doc)}),n.forEach(function(e){var n=rowToDocId(e),t=r["$"+n];t&&(e.doc=t)}),t})}return t}var o,u=e.reduceFun&&r.reduce!==!1,a=r.skip||0;"undefined"==typeof r.keys||r.keys.length||(r.limit=0,delete r.keys);var c=function(e){return e.reduce(function(e,r){return e.concat(r)})};if("undefined"!=typeof r.keys){var s=r.keys,l=s.map(function(e){var r={startkey:toIndexableString([e]),endkey:toIndexableString([e,{}])};return n(r)});return Promise.all(l).then(c).then(t)}var d={descending:r.descending};if("undefined"!=typeof r.startkey&&(d.startkey=toIndexableString(r.descending?[r.startkey,{}]:[r.startkey])),"undefined"!=typeof r.endkey){var f=r.inclusive_end!==!1;r.descending&&(f=!f),d.endkey=toIndexableString(f?[r.endkey,{}]:[r.endkey])}if("undefined"!=typeof r.key){var y=toIndexableString([r.key]),v=toIndexableString([r.key,{}]);d.descending?(d.endkey=y,d.startkey=v):(d.startkey=y,d.endkey=v)}return u||("number"==typeof r.limit&&(d.limit=r.limit),d.skip=a),n(d).then(t)}function s(e){return e.get("_local/"+d).then(function(r){var n={};Object.keys(r.views).forEach(function(e){var r=parseViewName(e),t="_design/"+r[0],o=r[1];n[t]=n[t]||{},n[t][o]=!0});var o={keys:Object.keys(n),include_docs:!0};return e.allDocs(o).then(function(o){var u={};o.rows.forEach(function(e){var t=e.key.substring(8);Object.keys(n[e.key]).forEach(function(n){var o=t+"/"+n;r.views[o]||(o=n);var i=Object.keys(r.views[o]),a=e.doc&&e.doc.views&&e.doc.views[n];i.forEach(function(e){u[e]=u[e]||a})})});var i=Object.keys(u).filter(function(e){return!u[e]}),a=i.map(function(r){return utils.sequentialize(t(r),function(){return new e.constructor(r,e.__opts).destroy()})()});return Promise.all(a).then(function(){return{ok:!0}})})},defaultsTo({ok:!0}))}function l(e,r,n){if("string"!=typeof r){checkQueryParseError(n,r);var t={db:e,viewName:"temp_view/temp_view",map:r.map,reduce:r.reduce,temporary:!0,pluginName:d};return tempViewQueue.add(function(){return createView(t).then(function(e){function r(){return e.db.destroy()}return utils.fin(o(e).then(function(){return a(e,n)}),r)})}),tempViewQueue.finish()}var u=r,i=parseViewName(u),c=i[0],s=i[1];return e.get("_design/"+c).then(function(r){var t=r.views&&r.views[s];if(!t)throw new NotFoundError("ddoc "+r._id+" has no view named "+s);v(r,s),checkQueryParseError(n,t);var i={db:e,viewName:u,map:t.map,reduce:t.reduce,pluginName:d};return createView(i).then(function(e){return"ok"===n.stale||"update_after"===n.stale?("update_after"===n.stale&&process.nextTick(function(){o(e)}),a(e,n)):o(e).then(function(){return a(e,n)})})})}var d=e.name,f=e.mapper,y=e.reducer,v=e.ddocValidator,h=function(e,r,n){var t=this;"function"==typeof r&&(n=r,r={}),r=utils.extend(!0,{},r),"function"==typeof e&&(e={map:e});var o=Promise.resolve().then(function(){return l(t,e,r)});return utils.promisedCallback(o,n),o},p=utils.callbackify(function(){var e=this;return s(e)});return{query:h,viewCleanup:p}}var pouchCollate=require("pouchdb-collate"),TaskQueue=require("./taskqueue"),collate=pouchCollate.collate,toIndexableString=pouchCollate.toIndexableString,normalizeKey=pouchCollate.normalizeKey,createView=require("./create-view"),log;log="undefined"!=typeof console&&"function"==typeof console.log?Function.prototype.bind.call(console.log,console):function(){};var utils=require("./utils"),Promise=utils.Promise,persistentQueues={},tempViewQueue=new TaskQueue,CHANGES_BATCH_SIZE=50;utils.inherits(QueryParseError,Error),utils.inherits(NotFoundError,Error),module.exports=createIndexer;