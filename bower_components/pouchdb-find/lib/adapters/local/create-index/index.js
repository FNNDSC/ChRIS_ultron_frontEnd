"use strict";function upsert(e,t,r){return pouchUpsert.upsert.call(e,t,r)}function createIndex(e,t){function r(e){return e._rev&&"query"!==e.language&&(d=!0),e.language="query",e.views=e.views||{},l=!!e.views[s],e.views[s]={map:{fields:utils.mergeObjects(t.index.fields)},reduce:"_count",options:{def:a}},e}t=massageCreateIndexRequest(t);var a=utils.clone(t.index);t.index=massageIndexDef(t.index),validateIndex(t.index);var i=utils.MD5(JSON.stringify(t)),s=t.name||"idx-"+i,n=t.ddoc||"idx-"+i,u="_design/"+n,d=!1,l=!1;return log("creating index",u),upsert(e,u,r).then(function(){if(d)throw new Error('invalid language for ddoc with id "'+u+'" (should be "query")')}).then(function(){var t=n+"/"+s;return abstractMapper.query.call(e,t,{limit:0,reduce:!1}).then(function(){return{id:u,name:s,result:l?"exists":"created"}})})}var utils=require("../../../utils"),log=utils.log,pouchUpsert=require("pouchdb-upsert"),abstractMapper=require("../abstract-mapper"),localUtils=require("../utils"),validateIndex=localUtils.validateIndex,massageIndexDef=localUtils.massageIndexDef,massageCreateIndexRequest=require("../../../massageCreateIndexRequest");module.exports=createIndex;