"use strict";function getFieldFromDoc(e,t){for(var r=e,n=0,i=t.length;i>n;n++){var o=t[n];if(r=r[o],!r)break}return r}function createFieldSorter(e){function t(t){return e.map(function(e){var r=getKey(e),n=parseField(r),i=getFieldFromDoc(t,n);return i})}return function(e,r){var n=t(e.doc),i=t(r.doc),o=collate(n,i);return 0!==o?o:utils.compare(e.doc._id,r.doc._id)}}function filterInMemoryFields(e,t,r){if(e=e.filter(function(e){return rowFilter(e.doc,t.selector,r)}),t.sort){var n=createFieldSorter(t.sort);e=e.sort(n),"string"!=typeof t.sort[0]&&"desc"===getValue(t.sort[0])&&(e=e.reverse())}if("limit"in t||"skip"in t){var i=t.skip||0,o=("limit"in t?t.limit:e.length)+i;e=e.slice(i,o)}return e}function rowFilter(e,t,r){return r.every(function(r){var n=t[r],i=parseField(r),o=getFieldFromDoc(e,i);return isCombinationalField(r)?matchCominationalSelector(r,n,e):matchSelector(n,e,i,o)})}function matchSelector(e,t,r,n){return e?Object.keys(e).every(function(i){var o=e[i];return match(i,t,o,r,n)}):!0}function matchCominationalSelector(e,t,r){return"$or"===e?t.some(function(e){return rowFilter(r,e,Object.keys(e))}):"$not"===e?!rowFilter(r,t,Object.keys(t)):!t.find(function(e){return rowFilter(r,e,Object.keys(e))})}function match(e,t,r,n,i){if(!matchers[e])throw new Error('unknown operator "'+e+'" - should be one of $eq, $lte, $lt, $gt, $gte, $exists, $ne, $in, $nin, $size, $mod, $regex, $elemMatch, $type or $all');return matchers[e](t,r,n,i)}function fieldExists(e){return"undefined"!=typeof e&&null!==e}function fieldIsArray(e){return fieldExists(e)&&e instanceof Array}function fieldNotUndefined(e){return"undefined"!=typeof e}function modField(e,t){var r=t[0],n=t[1];if(0===r)throw new Error("Bad divisor, cannot divide by zero");if(parseInt(r,10)!==r)throw new Error("Divisor is not an integer");if(parseInt(n,10)!==n)throw new Error("Modulus is not an integer");return parseInt(e,10)!==e?!1:e%r===n}function arrayContainsValue(e,t){return t.some(function(t){return e instanceof Array?e.indexOf(t)>-1:e===t})}function arrayContainsAllValues(e,t){return t.every(function(t){return e.indexOf(t)>-1})}function arraySize(e,t){return e.length===t}function regexMatch(e,t){var r=new RegExp(t);return r.test(e)}function typeMatch(e,t){switch(t){case"null":return null===e;case"boolean":return"boolean"==typeof e;case"number":return"number"==typeof e;case"string":return"string"==typeof e;case"array":return e instanceof Array;case"object":return"[object Object]"==={}.toString.call(e)}throw new Error(t+" not supported as a type.Please use one of object, string, array, number, boolean or null.")}var collate=require("pouchdb-collate").collate,localUtils=require("../utils"),isCombinationalField=localUtils.isCombinationalField,getKey=localUtils.getKey,getValue=localUtils.getValue,parseField=localUtils.parseField,utils=require("../../../utils"),matchers={$elemMatch:function(e,t,r,n){return fieldIsArray(n)?0===n.length?(console.log("FIELD WOOO!"),!1):"object"==typeof n[0]?n.some(function(e){return rowFilter(e,t,Object.keys(t))}):n.some(function(n){return matchSelector(t,e,r,n)}):!1},$eq:function(e,t,r,n){return fieldExists(n)&&0===collate(n,t)},$gte:function(e,t,r,n){return fieldExists(n)&&collate(n,t)>=0},$gt:function(e,t,r,n){return fieldExists(n)&&collate(n,t)>0},$lte:function(e,t,r,n){return fieldExists(n)&&collate(n,t)<=0},$lt:function(e,t,r,n){return fieldExists(n)&&collate(n,t)<0},$exists:function(e,t,r,n){return t?fieldNotUndefined(n):!fieldNotUndefined(n)},$mod:function(e,t,r,n){return fieldExists(n)&&modField(n,t)},$ne:function(e,t,r,n){return t.every(function(e){return 0!==collate(n,e)})},$in:function(e,t,r,n){return fieldExists(n)&&arrayContainsValue(n,t)},$nin:function(e,t,r,n){return fieldExists(n)&&!arrayContainsValue(n,t)},$size:function(e,t,r,n){return fieldExists(n)&&arraySize(n,t)},$all:function(e,t,r,n){return fieldIsArray(n)&&arrayContainsAllValues(n,t)},$regex:function(e,t,r,n){return fieldExists(n)&&regexMatch(n,t)},$type:function(e,t,r,n){return typeMatch(n,t)}};module.exports=filterInMemoryFields;