<!DOCTYPE html><html><head>
  <title>iron-ajax</title>

  <script src="../../webcomponentsjs/webcomponents.js"></script>
  <script src="../../web-component-tester/browser.js"></script>

  <link rel="import" href="../../polymer/polymer.html">
  <link rel="import" href="../../promise-polyfill/promise-polyfill.html">
  <link rel="import" href="../iron-ajax.html">
</head>
<body>
  <test-fixture id="TrivialGet">
    <template>
      <iron-ajax url="/responds_to_get_with_json"></iron-ajax>
    </template>
  </test-fixture>
  <test-fixture id="ParamsGet">
    <template>
      <iron-ajax url="/responds_to_get_with_json" params="{&quot;a&quot;: &quot;a&quot;}"></iron-ajax>
    </template>
  </test-fixture>
  <test-fixture id="AutoGet">
    <template>
      <iron-ajax auto="" url="/responds_to_get_with_json"></iron-ajax>
    </template>
  </test-fixture>
  <test-fixture id="GetEcho">
    <template>
      <iron-ajax handle-as="json" url="/echoes_request_url"></iron-ajax>
    </template>
  </test-fixture>
  <test-fixture id="TrivialPost">
    <template>
      <iron-ajax method="POST" url="/responds_to_post_with_json"></iron-ajax>
    </template>
  </test-fixture>
  <test-fixture id="DebouncedGet">
    <template>
      <iron-ajax auto="" url="/responds_to_debounced_get_with_json" debounce-duration="150"></iron-ajax>
    </template>
  </test-fixture>
  <test-fixture id="BlankUrl">
    <template>
      <iron-ajax auto="" handle-as="text"></iron-ajax>
    </template>
  </test-fixture>
  <test-fixture id="RealPost">
    <template>
      <iron-ajax method="POST" url="/httpbin/post"></iron-ajax>
    </template>
  </test-fixture>
  <test-fixture id="Delay">
    <template>
      <iron-ajax url="/httpbin/delay/1"></iron-ajax>
    </template>
  </test-fixture>
  <test-fixture id="Bubbles">
    <template>
      <iron-ajax url="/httpbin/post" method="POST" bubbles=""></iron-ajax>
      <iron-ajax url="/responds_to_get_with_502_error_json" bubbles=""></iron-ajax>
    </template>
  </test-fixture>
  <script>"use strict";suite("<iron-ajax>",function(){function e(e){return new Promise(function(t){window.setTimeout(function(){t()},e)})}function t(e){e.respond(200,r.json,JSON.stringify({url:e.url}))}var n,o,s,r={json:{"Content-Type":"application/json"},plain:{"Content-Type":"text/plain"}};setup(function(){s=sinon.fakeServer.create(),s.respondWith("GET",/\/responds_to_get_with_json.*/,[200,r.json,'{"success":true}']),s.respondWith("POST","/responds_to_post_with_json",[200,r.json,'{"post_success":true}']),s.respondWith("GET","/responds_to_get_with_text",[200,r.plain,"Hello World"]),s.respondWith("GET","/responds_to_debounced_get_with_json",[200,r.json,'{"success": "true"}']),s.respondWith("GET","/responds_to_get_with_502_error_json",[502,r.json,'{"message": "an error has occurred"}']),n=fixture("TrivialGet")}),teardown(function(){s.restore()}),suite("when making simple GET requests for JSON",function(){test("has sane defaults that love you",function(){o=n.generateRequest(),s.respond(),expect(o.response).to.be.ok,expect(o.response).to.be.an("object"),expect(o.response.success).to.be.equal(!0)}),test("will be asynchronous by default",function(){expect(n.toRequestOptions().async).to.be.eql(!0)})}),suite("when setting custom headers",function(){test("are present in the request headers",function(){n.headers["custom-header"]="valid";var e=n.toRequestOptions();expect(e.headers).to.be.ok,expect(e.headers["custom-header"]).to.be.an("string"),expect(e.headers.hasOwnProperty("custom-header")).to.be.equal(!0)}),test("non-objects in headers are not applied",function(){n.headers="invalid";var e=n.toRequestOptions();expect(Object.keys(e.headers).length).to.be.equal(0)})}),suite("when url isn't set yet",function(){test("we don't fire any automatic requests",function(){return expect(s.requests.length).to.be.equal(0),n=fixture("BlankUrl"),e(1).then(function(){return expect(s.requests.length).to.be.equal(0),n.generateRequest(),expect(s.requests.length).to.be.equal(1),s.requests=[],n=fixture("BlankUrl"),n.url="",e(1)}).then(function(){expect(s.requests.length).to.be.equal(1)})}),test("requestUrl remains empty despite valid queryString",function(){n=fixture("BlankUrl"),expect(n.url).to.be.equal(void 0),expect(n.queryString).to.be.equal(""),expect(n.requestUrl).to.be.equal(""),n.params={a:"b",c:"d"},expect(n.queryString).to.be.equal("a=b&c=d"),expect(n.requestUrl).to.be.equal("?a=b&c=d")}),test("generateRequest works with empty URL and valid queryString",function(){n=fixture("BlankUrl"),expect(n.url).to.be.equal(void 0),n.generateRequest(),expect(s.requests[0].url).to.be.eql(""),n.params={a:"b",c:"d"},n.generateRequest(),expect(s.requests[1].url).to.be.eql("?a=b&c=d")})}),suite("when properties are changed",function(){test("generates simple-request elements that reflect the change",function(){o=n.generateRequest(),expect(o.xhr.method).to.be.equal("GET"),n.method="POST",n.url="/responds_to_post_with_json",o=n.generateRequest(),expect(o.xhr.method).to.be.equal("POST")})}),suite("when generating a request",function(){test("yields an iron-request instance",function(){var e=document.createElement("iron-request").constructor;expect(n.generateRequest()).to.be.instanceOf(e)}),test("correctly adds params to a URL that already has some",function(){n.url+="?a=b",n.params={c:"d"},expect(n.requestUrl).to.be.equal("/responds_to_get_with_json?a=b&c=d")}),test("encodes params properly",function(){n.params={"a b,c":"d e f"},expect(n.queryString).to.be.equal("a%20b%2Cc=d%20e%20f")}),test("encodes array params properly",function(){n.params={"a b":["c","d e","f"]},expect(n.queryString).to.be.equal("a%20b=c&a%20b=d%20e&a%20b=f")}),test("reflects the loading state in the `loading` property",function(){var t=n.generateRequest();return expect(n.loading).to.be.equal(!0),s.respond(),t.completes.then(function(){return e(1)}).then(function(){expect(n.loading).to.be.equal(!1)})}),test("the loading-changed event gets fired twice",function(){var t=0;n.addEventListener("loading-changed",function(){t++});var o=n.generateRequest();return s.respond(),o.completes.then(function(){return e(1)}).then(function(){expect(t).to.be.equal(2)})})}),suite("when there are multiple requests",function(){var n,o,r;setup(function(){o=fixture("GetEcho"),n=[];for(var e=0;3>e;++e)o.params={order:e+1},n.push(o.generateRequest());var t=n.map(function(e){return e.completes});r=Promise.all(t)}),test("holds all requests in the `activeRequests` Array",function(){expect(n).to.deep.eql(o.activeRequests)}),test("empties `activeRequests` when requests are completed",function(){expect(o.activeRequests.length).to.be.equal(3);for(var n=0;3>n;n++)t(s.requests[n]);return r.then(function(){return e(1)}).then(function(){expect(o.activeRequests.length).to.be.equal(0)})}),test("avoids race conditions with last response",function(){return expect(o.lastResponse).to.be.equal(void 0),t(s.requests[0]),n[0].completes.then(function(){return expect(o.lastResponse).to.be.equal(void 0),t(s.requests[2]),n[2].completes}).then(function(){return expect(o.lastResponse).to.be.deep.eql({url:"/echoes_request_url?order=3"}),t(s.requests[1]),n[1].completes}).then(function(){expect(o.lastResponse).to.be.deep.eql({url:"/echoes_request_url?order=3"})})}),test("`loading` is true while the last one is loading",function(){return expect(o.loading).to.be.equal(!0),t(s.requests[0]),n[0].completes.then(function(){return expect(o.loading).to.be.equal(!0),t(s.requests[2]),n[2].completes}).then(function(){return expect(o.loading).to.be.eql(!1),t(s.requests[1]),n[1].completes}).then(function(){expect(o.loading).to.be.eql(!1)})})}),suite("when params are changed",function(){test("generates a request that reflects the change",function(){n=fixture("ParamsGet"),o=n.generateRequest(),expect(o.xhr.url).to.be.equal("/responds_to_get_with_json?a=a"),n.params={b:"b"},o=n.generateRequest(),expect(o.xhr.url).to.be.equal("/responds_to_get_with_json?b=b")})}),suite("when `auto` is enabled",function(){setup(function(){n=fixture("AutoGet")}),test("automatically generates new requests",function(){return new Promise(function(e){n.addEventListener("request",function(){e()})})}),test("does not send requests if url is not a string",function(){return new Promise(function(e,t){n.addEventListener("request",function(){t("A request was generated but url is null!")}),n.url=null,n.handleAs="text",Polymer.Base.async(function(){e()},1)})}),test("deduplicates multiple changes to a single request",function(){return new Promise(function(e,t){n.addEventListener("request",function(){s.respond()}),n.addEventListener("response",function(){try{expect(n.activeRequests.length).to.be.eql(1),e()}catch(o){t(o)}}),n.handleas="text",n.params={foo:"bar"},n.headers={"X-Foo":"Bar"}})}),test("automatically generates new request when a sub-property of params is changed",function(e){n.addEventListener("request",function(){s.respond()}),n.params={foo:"bar"},n.addEventListener("response",function(){n.addEventListener("request",function(){e()}),n.set("params.foo","xyz")})})}),suite("the last response",function(){setup(function(){o=n.generateRequest(),s.respond()}),test("is accessible as a readonly property",function(){return o.completes.then(function(e){expect(n.lastResponse).to.be.equal(e.response)})}),test("updates with each new response",function(){return o.completes.then(function(e){return expect(e.response).to.be.an("object"),expect(n.lastResponse).to.be.equal(e.response),n.handleAs="text",e=n.generateRequest(),s.respond(),e.completes}).then(function(e){expect(e.response).to.be.a("string"),expect(n.lastResponse).to.be.equal(e.response)})})}),suite("when making POST requests",function(){setup(function(){n=fixture("TrivialPost")}),test("POSTs the value of the `body` attribute",function(){var e=JSON.stringify({foo:"bar"});n.body=e,n.generateRequest(),expect(s.requests[0]).to.be.ok,expect(s.requests[0].requestBody).to.be.equal(e)}),test("if `contentType` is set to form encode, the body is encoded",function(){n.body={foo:"bar\nbip","biz bo":"baz blar"},n.contentType="application/x-www-form-urlencoded",n.generateRequest(),expect(s.requests[0]).to.be.ok,expect(s.requests[0].requestBody).to.be.equal("foo=bar%0D%0Abip&biz+bo=baz+blar")}),test("if `contentType` is json, the body is json encoded",function(){var e={foo:"bar",baz:[1,2,3]};n.body=e,n.contentType="application/json",n.generateRequest(),expect(s.requests[0]).to.be.ok,expect(s.requests[0].requestBody).to.be.equal(JSON.stringify(e))}),suite("the examples in the documentation work",function(){test("json content, body attribute is an object",function(){n.setAttribute("body",'{"foo": "bar baz", "x": 1}'),n.contentType="application/json",n.generateRequest(),expect(s.requests[0]).to.be.ok,expect(s.requests[0].requestBody).to.be.equal('{"foo":"bar baz","x":1}')}),test("form content, body attribute is an object",function(){n.setAttribute("body",'{"foo": "bar baz", "x": 1}'),n.contentType="application/x-www-form-urlencoded",n.generateRequest(),expect(s.requests[0]).to.be.ok,expect(s.requests[0].requestBody).to.be.equal("foo=bar+baz&x=1")})}),suite("and `contentType` is explicitly set to form encode",function(){test("we encode a custom object",function(){function e(e){this.bar=e}var t=new e("baz");n.body=t,n.contentType="application/x-www-form-urlencoded",n.generateRequest(),expect(s.requests[0]).to.be.ok,expect(s.requests[0].requestBody).to.be.equal("bar=baz")})}),suite("and `contentType` isn't set",function(){test("we don't try to encode an ArrayBuffer",function(){var e=new ArrayBuffer;n.body=e,n.generateRequest(),expect(s.requests[0]).to.be.ok,expect(s.requests[0].requestBody).to.be.equal(e)})})}),suite("when debouncing requests",function(){setup(function(){n=fixture("DebouncedGet")}),test("only requests a single resource",function(){return n._requestOptionsChanged(),expect(s.requests[0]).to.be.equal(void 0),n._requestOptionsChanged(),e(200).then(function(){expect(s.requests[0]).to.be.ok})})}),suite("when a response handler is bound",function(){var e;setup(function(){e=sinon.spy(),n.addEventListener("response",e)}),test("calls the handler after every response",function(){return n.generateRequest(),n.generateRequest(),s.respond(),n.lastRequest.completes.then(function(){expect(e.callCount).to.be.equal(2)})})}),suite("when the response type is `json`",function(){setup(function(){s.restore()}),test("finds the JSON on any platform",function(){return n.url="../bower.json",o=n.generateRequest(),o.completes.then(function(){expect(n.lastResponse).to.be.instanceOf(Object)})})}),suite("when handleAs parameter is `text`",function(){test("response type is string",function(){n.url="/responds_to_get_with_json",n.handleAs="text",o=n.generateRequest();var e=o.completes.then(function(){expect(typeof n.lastResponse).to.be.equal("string")});return expect(s.requests.length).to.be.equal(1),expect(s.requests[0].requestHeaders.accept).to.be.equal("text/plain"),s.respond(),e})}),suite("when a request fails",function(){test("we give an error with useful details",function(){n.url="/responds_to_get_with_502_error_json",n.handleAs="json";var t=!1;n.addEventListener("error",function(e){expect(e.detail.request).to.be.ok,expect(e.detail.error).to.be.ok,t=!0});var o=n.generateRequest(),r=o.completes.then(function(){throw new Error("Expected the request to fail!")},function(t){return expect(t).to.be["instanceof"](Error),expect(o.succeeded).to.be.eq(!1),e(100)}).then(function(){expect(t).to.be.eq(!0),expect(n.lastError).to.not.be.eq(null),expect(n.lastError.status).to.be.eq(502),expect(n.lastError.statusText).to.be.eq("Bad Gateway"),expect(n.lastError.response).to.be.ok});return s.respond(),r}),test("we give a useful error even when the domain doesn't resolve",function(){n.url="http://nonexistant.example.com/",s.restore();var t=!1;n.addEventListener("error",function(e){expect(e.detail.request).to.be.ok,expect(e.detail.error).to.be.ok,t=!0});var o=n.generateRequest(),r=o.completes.then(function(){throw new Error("Expected the request to fail!")},function(t){return expect(o.succeeded).to.be.eq(!1),expect(t).to.not.be.eq(null),e(100)}).then(function(){expect(t).to.be.eq(!0),expect(n.lastError).to.not.be.eq(null)});return s.respond(),r})}),suite("when handleAs parameter is `json`",function(){test("response type is string",function(){n.url="/responds_to_get_with_json",n.handleAs="json",o=n.generateRequest();var e=o.completes.then(function(){expect(typeof n.lastResponse).to.be.equal("object")});return expect(s.requests.length).to.be.equal(1),expect(s.requests[0].requestHeaders.accept).to.be.equal("application/json"),s.respond(),e})}),suite("when making a POST over the wire",function(){test("FormData is handled correctly",function(){s.restore();var e=new FormData;e.append("a","foo"),e.append("b","bar");var t=fixture("RealPost");return t.body=e,t.generateRequest().completes.then(function(){expect(t.lastResponse.headers["Content-Type"]).to.match(/^multipart\/form-data; boundary=.*$/),expect(t.lastResponse.form.a).to.be.equal("foo"),expect(t.lastResponse.form.b).to.be.equal("bar")})}),test("json is handled correctly",function(){s.restore();var e=fixture("RealPost");return e.body=JSON.stringify({a:"foo",b:"bar"}),e.contentType="application/json",e.generateRequest().completes.then(function(){expect(e.lastResponse.headers["Content-Type"]).to.match(/^application\/json(;.*)?$/),expect(e.lastResponse.json.a).to.be.equal("foo"),expect(e.lastResponse.json.b).to.be.equal("bar")})}),test("urlencoded data is handled correctly",function(){s.restore();var e=fixture("RealPost");return e.body="a=foo&b=bar",e.generateRequest().completes.then(function(){expect(e.lastResponse.headers["Content-Type"]).to.match(/^application\/x-www-form-urlencoded(;.*)?$/),expect(e.lastResponse.form.a).to.be.equal("foo"),expect(e.lastResponse.form.b).to.be.equal("bar")})}),test("xml is handled correctly",function(){s.restore();var e=fixture("RealPost"),t=document.implementation.createDocument(null,"foo",null),n=t.createElement("bar");return n.setAttribute("name","baz"),t.documentElement.appendChild(n),e.body=t,e.generateRequest().completes.then(function(){expect(e.lastResponse.headers["Content-Type"]).to.match(/^application\/xml(;.*)?$/),expect(e.lastResponse.data).to.match(/<foo\s*><bar\s+name="baz"\s*\/><\/foo\s*>/)})})}),suite("when setting timeout",function(){setup(function(){s.restore()}),test("it is present in the request xhr object",function(){n.url="/responds_to_get_with_json",n.timeout=5e3,o=n.generateRequest(),expect(o.xhr.timeout).to.be.equal(5e3)}),test("it fails once that timeout is reached",function(){var t=fixture("Delay");return t.timeout=1,o=t.generateRequest(),o.completes.then(function(){throw new Error("Expected the request to throw an error.")},function(){return expect(o.succeeded).to.be.equal(!1),expect(o.xhr.status).to.be.equal(0),expect(o.timedOut).to.be.equal(!0),e(1)}).then(function(){expect(t.loading).to.be.equal(!1),expect(t.lastResponse).to.be.equal(null),expect(t.lastError).to.not.be.equal(null)})})}),suite("when using the bubbles attribute",function(){setup(function(){s.restore()}),test("the request and response events should bubble to window",function(e){function t(){n++,4===n&&e()}s.restore();var n=0;window.addEventListener("request",t),window.addEventListener("iron-ajax-request",t),window.addEventListener("response",t),window.addEventListener("iron-ajax-response",t);var o=fixture("Bubbles")[0];o.generateRequest(),s.respond()}),test("the request and error events should bubble to window",function(e){function t(){n++,4===n&&e()}s.restore();var n=0;window.addEventListener("request",t),window.addEventListener("iron-ajax-request",t),window.addEventListener("error",t),window.addEventListener("iron-ajax-error",t);var o=fixture("Bubbles")[1];o.generateRequest(),s.respond()})})});</script>



</body></html>